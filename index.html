<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta id="viewportMeta" name="viewport" content="width=880, viewport-fit=cover">
    <title>Petualangan Mufradat - Ultimate Edition</title>
    <style>

        :root { --primary: #00b894; --secondary: #0984e3; --accent: #fdcb6e; --dark: #2d3436; --glass: rgba(255, 255, 255, 0.25); --glass-strong: rgba(255, 255, 255, 0.90); --glass-border: 2px solid rgba(255, 255, 255, 0.4); --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15); --font-main: 'Segoe UI', Tahoma, sans-serif; --font-arabic: "Traditional Arabic", serif; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: #222; height: 100vh; width: 100vw; overflow: hidden; position: fixed; }
        #app { width: 100%; height: 100%; position: relative; overflow-y: auto; background-color: #f0f0f0; padding-top: 0; display: flex; flex-direction: column; align-items: center; -webkit-overflow-scrolling: touch; transition: padding 0.3s ease; }
        /* HUD JUMBO ADJUSTMENT */
        #app.with-hud { padding-top: 110px; }
        #watermarkLogo { position: fixed; top: 20px; right: 20px; width: 90px; height: auto; z-index: 10; opacity: 0.9; pointer-events: none; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); transition: top 0.3s ease; }
        #watermarkLogo.lowered { top: 120px; }
        #assetPreloader { position: absolute; width: 1px; height: 1px; overflow: hidden; opacity: 0; pointer-events: none; z-index: -999; }
        section { min-height: 100vh; width: 100%; padding: 20px; display: none; flex-direction: column; align-items: center; justify-content: center; position: relative; background-size: cover; background-position: center; }
        #welcomeScreen, #coverScreen { min-height: 100vh; }
        section.active-screen { display: flex; animation: fadeIn 0.4s ease-out; }
        #welcomeScreen { background-image: url('https://cdn.imgpile.com/f/eFKTTCz_xl.jpg'); }
        #coverScreen { background-image: url('https://cdn.imgpile.com/f/j7g0YzS_xl.png'); justify-content: flex-end; padding-bottom: 120px; }
        #chapterScreen, #mapScreen, #game3Screen, #gameChallengeL2Screen, #challengeSelectScreen, #quizScreen, #scoreboardScreen, #puzzleScreen { background-image: url('https://cdn.imgpile.com/f/K2herev_xl.png'); }
        #arrangeScreen { background-image: url('https://cdn.imgpile.com/f/HSafnNa_xl.png'); }
        #arrangeVictoryScreen { background-image: url('https://cdn.imgpile.com/f/S7n7fF0_xl.png'); }
        #arrangeVictoryScreen { background-size: cover; background-position: center; }
        #levelScreen, #game1Screen, #game2Screen, #resultScreen { background-image: url('https://cdn.imgpile.com/f/5RCVNjo_xl.jpg'); }
        #mysteryScreen { background-image: url('https://cdn.imgpile.com/f/xCjaBMb_xl.png'); background-size: cover; }
        #mysteryFinalScreen { background-image: url('https://cdn.imgpile.com/f/417MocM_xl.png'); background-size: cover; }
        #mysteryResultScreen { background-size: cover; background-position: center; overflow: hidden; }
        #mysteryResultScreen .final-result-box { background: transparent; box-shadow: none; border: none; backdrop-filter: none; }
        #ultimateRewardScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://cdn.imgpile.com/f/ilRYDcJ_xl.png'); background-size: cover; background-position: center; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s ease; }
        #ultimateRewardScreen.active { display: flex; opacity: 1; }
        .ult-rays { position: absolute; top: 50%; left: 50%; width: 200vmax; height: 200vmax; background: repeating-conic-gradient(rgba(255, 215, 0, 0.2) 0 15deg, transparent 15deg 30deg); transform: translate(-50%, -50%); animation: sun-spin 60s linear infinite; pointer-events: none; mix-blend-mode: overlay; }
        .ult-strobe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 5; animation: strobe-flash 0.15s infinite; display: none; }
        #ultimateRewardScreen.active .ult-strobe.running { display: block; }
        .ult-content { z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100%; }
        .ult-text-chip { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 6px solid #f1c40f; border-radius: 40px; padding: 10px 40px; margin: 15px auto; box-shadow: 0 15px 40px rgba(0,0,0,0.4), 0 0 30px rgba(241, 196, 15, 0.6); transform: scale(0); width: fit-content; max-width: 90%; display: flex; align-items: center; justify-content: center; }
        .ult-arabic { font-family: var(--font-arabic); font-size: 4.5rem; color: #2d3436; margin: 0; line-height: 1.1; text-shadow: none; text-align: center; width: 100%; }
        .ult-info-chip { background: rgba(255, 255, 255, 0.95); border-radius: 30px; padding: 12px 30px; margin: 20px auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2); opacity: 0; width: fit-content; max-width: 90%; }
        .anim-slam { animation: slam-impact 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .anim-pop { animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards 0.5s; opacity: 0; }
        .ult-score-box { background: rgba(255, 255, 255, 0.95); border: 4px solid #f1c40f; padding: 10px 40px; border-radius: 50px; font-size: 3.5rem; font-weight: 900; color: #d35400; margin: 15px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); opacity: 0; width: fit-content; }
        @keyframes sun-spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes slam-impact { 0% { opacity: 0; transform: scale(3); } 60% { opacity: 1; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes strobe-flash { 0%, 100% { opacity: 0; } 50% { opacity: 0.1; } }
        /* HUD JUMBO STYLE */
        #topHud { position: fixed; top: 0; left: 0; width: 100%; height: 110px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 3px solid rgba(255, 255, 255, 0.8); display: none; justify-content: space-between; align-items: center; padding: 0 25px; z-index: 1000; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .progress-container { width: 50%; max-width: 300px; display: flex; flex-direction: column; gap: 5px; }
        .progress-label { font-size: 1rem; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 1px; }
        .progress-bg { width: 100%; height: 24px; background: #dfe6e9; border-radius: 15px; overflow: hidden; border: 2px solid #b2bec3; box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.15); }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00b894, #00cec9); transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 15px; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1); }
        .score-box { background: linear-gradient(135deg, #fdcb6e, #f1c40f); padding: 12px 25px; border-radius: 50px; font-weight: 900; color: #2d3436; font-size: 1.5rem; box-shadow: 0 6px 0 #d35400, 0 8px 15px rgba(0, 0, 0, 0.2); border: 3px solid #fff; transform: translateY(-2px); display: flex; align-items: center; gap: 8px; }
        #streakBadge { font-size: 1.2rem; background: #e74c3c; color: white; padding: 6px 15px; border-radius: 20px; display: none; animation: pulseText 0.5s infinite alternate; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .content-box { background: var(--glass); width: 100%; max-width: 500px; padding: 30px; border-radius: 30px; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; text-align: center; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); border: var(--glass-border); z-index: 5; margin: auto; transition: all 0.3s ease; position: relative; }
        #mapScreen .content-box { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(2px); border: 1px solid rgba(255, 255, 255, 0.3); max-width: 550px; }
        #levelScreen .level-content, #game1Screen .content-box, #game2Screen .content-box { background: transparent !important; box-shadow: none !important; border: none !important; padding: 0; max-width: 600px; width: 100%; backdrop-filter: none !important; }
        .title-chip { background: linear-gradient(to bottom, #fff, #f1f2f6); padding: 12px 35px; border-radius: 50px; box-shadow: 0 6px 0 #dfe6e9, 0 10px 20px rgba(0, 0, 0, 0.1); display: inline-block; margin-bottom: 15px; border: 2px solid #fff; }
        .title-chip h3 { margin: 0; color: var(--secondary); text-transform: uppercase; font-size: 1.3rem; font-weight: 900; letter-spacing: 1px; }
        .arabic-chip { font-family: var(--font-arabic); font-size: 4rem; font-weight: bold; color: var(--dark); background: #ffffff; padding: 10px 40px; border-radius: 30px; border: 4px solid var(--accent); box-shadow: 0 8px 0 #f39c12, 0 15px 25px rgba(0, 0, 0, 0.15); margin: 10px 0 20px 0; text-align: center; width: 100%; max-width: 450px; line-height: 1.2; animation: popUp 0.4s ease-out; }
        .btn { background: linear-gradient(to bottom, #00b894, #00a884); color: white; border: none; padding: 18px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 6px 0 #00796b, 0 10px 15px rgba(0, 0, 0, 0.2); transition: transform 0.1s, box-shadow 0.1s; border: 2px solid rgba(255, 255, 255, 0.3); }
        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 #00796b, inset 0 3px 5px rgba(0, 0, 0, 0.2); }
        .btn-secondary { background: linear-gradient(to bottom, #ffffff, #f1f2f6); color: #636e72; border: 2px solid #dfe6e9; box-shadow: 0 6px 0 #b2bec3, 0 8px 10px rgba(0, 0, 0, 0.1); padding: 15px 30px; border-radius: 50px; width: 100%; margin-top: 15px; cursor: pointer; font-weight: 800; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.1s; }
        .btn-secondary:hover { background: #fff; color: var(--secondary); border-color: var(--secondary); box-shadow: 0 6px 0 #74b9ff, 0 8px 10px rgba(0, 0, 0, 0.1); }
        .btn-secondary:active { transform: translateY(6px); box-shadow: 0 0 0 #b2bec3; }
        /* RAPORT TAB STYLE */
        .header-chip-container { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-chip { background: linear-gradient(to bottom, #fff, #ecf0f1); padding: 12px 25px; border-radius: 30px; box-shadow: 0 5px 0 #bdc3c7; font-weight: 800; color: #555; cursor: pointer; border: 2px solid #fff; font-size: 0.95rem; text-transform: uppercase; transition: all 0.1s; }
        .nav-chip:active { transform: translateY(5px); box-shadow: none; }
        .info-chip { font-size: 1.2rem; color: #444; font-weight: 700; background: rgba(255, 255, 255, 0.9); padding: 8px 25px; border-radius: 20px; margin-bottom: 8px; display: inline-block; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); }
        .meaning-chip { font-size: 1.5rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; background: var(--primary); padding: 10px 40px; border-radius: 50px; margin-bottom: 25px; display: inline-block; box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4); border: 2px solid rgba(255, 255, 255, 0.5); }
        #levelScreen .image-placeholder, #game1Screen .image-placeholder { border: 4px solid white; box-shadow: 0 0 25px rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.8); margin-bottom: 15px; }
        .floating-action-bar { display: flex; gap: 15px; width: 100%; justify-content: center; background: rgba(255, 255, 255, 0.6); padding: 10px; border-radius: 30px; backdrop-filter: blur(8px); margin-top: 10px; border: 1px solid rgba(255, 255, 255, 0.4); }
        #welcomeScreen .welcome-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1000px; }
        #welcomeScreen .content-box { max-width: 800px; padding: 40px; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); box-shadow: var(--shadow); border: var(--glass-border); }
        #welcomeScreen.active-screen .content-box { animation: wooshInLeft 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        #welcomeScreen.active-screen .welcome-char { animation: wooshInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; animation-fill-mode: forwards; }
        @media (min-width: 900px) {
            #welcomeScreen .welcome-container { flex-direction: row; justify-content: center; align-items: center; gap: 20px; }
            #welcomeScreen .content-box { text-align: left; align-items: flex-start; width: 60%; margin: 0; order: 1; }
            .welcome-char { height: 480px !important; margin-top: 0 !important; margin-left: -50px; order: 2; filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.4)); }
        }
        .level-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 1000px; position: relative; padding-bottom: 20px; }
        .level-char { height: 250px; width: auto; filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3)); z-index: 10; order: 2; margin-top: -50px; pointer-events: none; opacity: 0; }
        .level-content { z-index: 5; order: 1; display: flex; flex-direction: column; align-items: center; }
        @media (min-width: 851px) {
            .level-container { flex-direction: row; align-items: flex-end; justify-content: center; padding-bottom: 20px; }
            .level-char { height: 420px; margin-top: 0; }
            .level-content { order: 2; margin: 0 30px; width: 480px; }
            .level-container.pos-left .level-char { order: 1; margin-right: -70px; animation: slideInLeft 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .level-container.pos-right .level-char { order: 3; margin-left: -70px; animation: slideInRight 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        }
        @media (max-width: 850px) { .level-char { animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; } .welcome-char { height: 280px; margin-top: -30px; z-index: 6; position: relative; } }
        h1 { font-size: 2.8rem; margin-bottom: 15px; color: var(--secondary); text-shadow: 0 0 10px rgba(255, 255, 255, 0.9); line-height: 1.1; font-weight: 900; }
        .cover-arabic { font-family: var(--font-arabic); font-size: 5rem; font-weight: bold; color: var(--dark); line-height: 1.2; margin: 0 0 10px 0; text-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
        .welcome-text { font-size: 1.3rem; color: #222; margin-bottom: 25px; line-height: 1.6; font-weight: 600; text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); }
        .quote-box { background: rgba(255, 255, 255, 0.5); border-left: 6px solid var(--accent); padding: 15px 20px; margin: 20px 0 30px 0; border-radius: 0 15px 15px 0; font-size: 1.1rem; color: #111; font-style: italic; width: 100%; text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5); }
        .start-btn-img { width: 380px; height: auto; cursor: pointer; filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3)); transition: transform 0.2s; animation: pulseImg 2s infinite ease-in-out; position:relative; z-index:25; }
        .start-btn-img:hover { transform: scale(1.1); filter: drop-shadow(0 8px 15px rgba(0, 0, 0, 0.4)); }
        .start-btn-img:active { transform: scale(0.95); }
        .image-placeholder { width: 140px; height: 140px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 10px auto 20px auto; border: 5px solid rgba(255, 255, 255, 0.8); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); overflow: hidden; flex-shrink: 0; }
        #levelImg { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #levelImg img, .image-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .map-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 480px; margin-bottom: 20px; justify-items: center; }
        .location-card { background: rgba(255, 255, 255, 0.7); padding: 10px; border-radius: 20px; width: 100%; max-width: 130px; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); cursor: pointer; border: 3px solid transparent; transition: transform 0.2s, background 0.3s; backdrop-filter: blur(5px); }
        .location-card:hover { background: rgba(255, 255, 255, 0.9); }
        .location-card:active { transform: scale(0.95); }
        .location-card.completed { border-color: var(--primary); background: rgba(232, 245, 233, 0.85); }
        .location-card img { width: 65px; height: 65px; object-fit: cover; border-radius: 50%; margin: 0 auto 8px auto; border: 2px solid #eee; display: block; }
        @media (max-width: 350px) { .map-grid { grid-template-columns: repeat(2, 1fr); } }
        .img-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 10px; }
        @media (min-width: 600px) { .img-grid { grid-template-columns: repeat(3, 1fr); } }
        .btn-img { background: rgba(255, 255, 255, 0.8); border: 4px solid rgba(255, 255, 255, 0.5); border-radius: 18px; width: 100%; aspect-ratio: 1/1; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.2s; backdrop-filter: blur(5px); }
        .btn-img:hover { background: white; }
        .btn-img img { width: 100%; height: 100%; object-fit: cover; }
        .btn-img.correct-anim { border-color: #2ecc71; background: #d5f5e3; transform: scale(1.05); }
        .btn-img.wrong-anim { border-color: #e74c3c; background: #fadbd8; animation: shake 0.4s; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; width: 100%; margin-top: 10px; }
        .option-wrapper { display: flex; gap: 10px; width: 100%; align-items: stretch; }
        .btn-sound-opt { width: 60px; background: var(--accent); border-radius: 15px; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.1); flex-shrink: 0; transition: transform 0.1s; }
        .btn-sound-opt:active { transform: translateY(4px); box-shadow: none; }
        .btn-option { background: rgba(255, 255, 255, 0.7); border: 2px solid var(--primary); padding: 12px; border-radius: 15px; font-size: 1.2rem; font-weight: bold; color: var(--dark); cursor: pointer; box-shadow: 0 3px 0 rgba(0, 0, 0, 0.05); transition: 0.1s; backdrop-filter: blur(5px); }
        .btn-option:hover { background: white; }
        .btn-option:active { transform: translateY(2px); box-shadow: none; }
        .btn-opt-main { flex-grow: 1; margin-top: 0 !important; box-shadow: 0 4px 0 rgba(0,0,0,0.05); }
        .btn-option.arabic { font-family: var(--font-arabic); font-size: 2rem; }
        .option-row { display: flex; gap: 8px; width: 100%; align-items: stretch; }
        .btn-sound { width: 55px; background: var(--accent); border-radius: 15px; border: none; font-size: 1.5rem; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1); transition: 0.1s; }
        .btn-sound:active { transform: scale(0.95); box-shadow: none; }
        .btn-answer-split { flex-grow: 1; margin: 0; }
        .level-select-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .level-select-card { background: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 20px; width: 100%; max-width: 200px; cursor: pointer; transition: 0.2s; border: 4px solid transparent; text-align: center; position: relative; }
        .level-select-card:hover { transform: translateY(-5px); background: white; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .level-select-card h3 { color: var(--primary); margin-bottom: 5px; }
        .level-select-card p { font-size: 0.85rem; color: #666; line-height: 1.4; }
        .level-select-card.done { border-color: #2ecc71; background: #e8f5e9; }
        .level-select-card.done::after { content: "âœ… Selesai"; position: absolute; top: -10px; right: -10px; background: #2ecc71; color: white; font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; margin-top: 20px; perspective: 1000px; }
        .memory-card { aspect-ratio: 3/4; position: relative; cursor: pointer; border-radius: 10px; transform-style: preserve-3d; transition: transform 0.5s; }
        .memory-card.flipped, .memory-card.matched { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-align: center; border: 3px solid white; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); }
        .front { background: linear-gradient(135deg, var(--primary), #00cec9); color: rgba(255, 255, 255, 0.6); font-size: 2rem; transform: rotateY(0deg); }
        .back { background: #fff; color: var(--dark); transform: rotateY(180deg); font-weight: bold; padding: 4px; font-size: 0.85rem; word-wrap: break-word; display: flex; align-items: center; justify-content: center; }
        .back.ar { font-size: 1.3rem; font-family: var(--font-arabic); }
        .memory-card.matched .back { background: #d5f5e3; border-color: #2ecc71; box-shadow: inset 0 0 10px #2ecc71; }
        #feedbackOverlay, #grandFinale, #challengeOverlay, #flashOverlay, #mysteryOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; backdrop-filter: blur(15px); background: rgba(0, 0, 0, 0.4); }
        #feedbackOverlay { z-index: 4000; }
        #flashOverlay { z-index: 3900; background: white; pointer-events: none; opacity: 0; backdrop-filter: none; }
        #flashOverlay.flash-anim { animation: flash 0.5s ease-out; display: block !important; }
        #grandFinale { z-index: 3000; flex-direction: column; color: #2d3436; background: transparent; perspective: 1500px; opacity: 0; pointer-events: none; transition: opacity 0.5s; background-size: cover; background-position: center; background-repeat: no-repeat; }
        #grandFinale.active { opacity: 1; pointer-events: auto; display: flex; }
        .finale-fragments { 
            display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 3001; 
            width: 90%; max-width: 500px; transform-style: preserve-3d;
            /* mobile safety: keep CTA reachable */
            max-height: calc(100vh - 32px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 18px 0 calc(18px + env(safe-area-inset-bottom, 0px)) 0;
        }
        .finale-chip { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); padding: 10px 30px; border-radius: 50px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); text-align: center; border: 2px solid rgba(255,255,255,0.8); width: fit-content; }
        .finale-icon-solo { font-size: 8rem; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: popUp 0.8s infinite alternate; margin: 10px 0; }
        .score-chip { background: rgba(255, 255, 255, 0.95); padding: 15px 40px; border-radius: 30px; border: 4px solid var(--primary); color: var(--primary); font-size: 3.5rem; font-weight: 900; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* grand finale responsive */
        @media (max-height: 760px), (max-width: 420px) {
            .finale-icon-solo { font-size: 6rem; margin: 6px 0; }
            .score-chip { font-size: 2.8rem; padding: 12px 28px; }
            .finale-chip { padding: 8px 20px; }
            #finalTitle { font-size: 2.1rem !important; }
        }
        @media (max-height: 640px) {
            .finale-icon-solo { font-size: 5.2rem; }
            .score-chip { font-size: 2.5rem; }
        }
        #challengeOverlay { background: rgba(0, 0, 0, 0.85); z-index: 2500; }
        .challenge-card { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); border: 4px solid #f1c40f; width: 90%; max-width: 400px; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; }
        .big-score { font-size: 6rem; font-weight: 900; background: linear-gradient(to bottom, #f1c40f, #e67e22); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 0px rgba(0, 0, 0, 0.1)); line-height: 1; margin: 15px 0; animation: pulseText 2s infinite ease-in-out; }
        .popup { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 35px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.8); transition: 0.3s; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(15px); border: 6px solid #fff; opacity: 0; }
        .active .popup { transform: scale(1); opacity: 1; }
        .fb-correct { border-color: #2ecc71; background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); } .fb-correct h2 { color: #27ae60; text-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .fb-wrong { border-color: #e74c3c; background: linear-gradient(135deg, #fadbd8 0%, #ffffff 100%); } .fb-wrong h2 { color: #c0392b; text-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        #fbTitle { font-size: 3rem; margin: 15px 0 10px 0; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
        #fbText { font-size: 1.4rem; font-weight: 700; padding: 0 15px; line-height: 1.5; color: #555; }
        #fbEmoji { font-size: 6rem; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); animation: pulseImg 1.5s infinite; }
        .score-list { width: 100%; margin-top: 5px; text-align: left; max-height: 40vh; overflow-y: auto; padding-right: 5px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .score-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; background: rgba(255, 255, 255, 0.6); border-radius: 10px; margin-bottom: 8px; }
        .report-page-title{
          text-align:center;
          font-weight:900;
          color:#2c3e50;
          background:rgba(255,255,255,.85);
          padding:10px 16px;
          border-radius:999px;
          border:1px solid rgba(0,0,0,.08);
          margin:0 auto 12px auto;
          width:fit-content;
        }
        .report-back-btn{
          display:block;
          margin:14px auto 0 auto;
          padding:12px 18px;
        }

        .glitch-mode { animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite; }
        .chapter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 15px; }
        .chapter-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 240, 240, 0.8)); border-radius: 20px; padding: 15px; width: 100%; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); border: 2px solid white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center; }
        .chapter-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); border-color: var(--primary); }
        .chapter-icon-img { width: 90px; height: 90px; object-fit: contain; margin-bottom: 8px; filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.1)); transition: transform 0.2s; }
        .chapter-card:hover .chapter-icon-img { transform: scale(1.1); }
        .puzzle-riddle-box { background: rgba(255,255,255,0.9); border: 4px solid var(--accent); border-radius: 25px; padding: 25px; margin: 15px 0; width: 100%; box-shadow: 0 8px 0 rgba(0,0,0,0.05); }
        .puzzle-text { font-size: 1.8rem; font-weight: 800; color: #2d3436; line-height: 1.4; }
        .puzzle-speaker { width: 100px; height: 100px; background: #f1c40f; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 4px solid white; box-shadow: 0 8px 0 #d35400; cursor: pointer; margin-bottom: 20px; animation: pulseImg 2s infinite; }
        .puzzle-speaker:active { transform: translateY(4px); box-shadow: none; }
        .puzzle-options-grid { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .puzzle-opt-row { display: flex; gap: 10px; width: 100%; align-items: stretch; }
        .btn-puzzle-ar { flex-grow: 1; font-family: var(--font-arabic); font-size: 2.3rem !important; margin-top: 0 !important; padding: 10px !important; box-shadow: 0 5px 0 rgba(0,0,0,0.1) !important; }
        .btn-puzzle-sm { width: 70px; background: var(--accent); border-radius: 18px; border: none; font-size: 1.6rem; cursor: pointer; box-shadow: 0 4px 0 #d35400; display: flex; align-items: center; justify-content: center; }
        .btn-puzzle-sm:active { transform: translateY(2px); box-shadow: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes popUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-150px); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideInRight { from { transform: translateX(150px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(150px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes wooshInLeft { 0% { transform: translateX(-150%) skewX(-30deg); opacity: 0; filter: blur(20px); } 100% { transform: translateX(0) skewX(0); opacity: 1; filter: blur(0); } }
        @keyframes wooshInRight { 0% { transform: translateX(150%) skewX(30deg); opacity: 0; filter: blur(20px); } 100% { transform: translateX(0) skewX(0); opacity: 1; filter: blur(0); } }
        @keyframes pulseImg { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } } @keyframes pulseText { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        @keyframes shakeScreen { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }
        @keyframes glitch { 0% { transform: translate(0) } 20% { transform: translate(-3px, 3px) } 40% { transform: translate(-3px, -3px) } 60% { transform: translate(3px, 3px) } 80% { transform: translate(3px, -3px) } 100% { transform: translate(0) } }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        .confetti { position: absolute; width: 10px; height: 10px; background: gold; animation: fall 3s linear forwards; }
        .welcome-char { animation: popUp 1s; }
        #canvasFireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; transition: opacity 1s ease; }
        .toggle-container { display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(255,255,255,0.6); padding: 8px 15px; border-radius: 20px; margin-bottom: 10px; width: fit-content; margin-left: auto; margin-right: auto; }
        .toggle-btn { position: relative; width: 50px; height: 26px; background: #ccc; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .toggle-btn.active { background: #2ecc71; }
        .toggle-circle { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active .toggle-circle { left: 27px; }
        .chest-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 400px; width: 90%; }
        .chest-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .chest-base { width: 100px; height: 100px; position: relative; z-index: 2; transition: transform 0.1s; }
        .chest-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); transition: transform 0.2s; }
        .chest-plate { position: absolute; bottom: 0; width: 100%; height: 20px; background: rgba(0,0,0,0.3); border-radius: 50%; filter: blur(5px); z-index: 1; transform: scaleX(0.8); }
        .burst-fan { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 150px; height: 150px; background: radial-gradient(circle at center bottom, rgba(255,255,200,1) 0%, rgba(255,215,0,0.6) 50%, transparent 80%); z-index: 1; opacity: 0; pointer-events: none; mix-blend-mode: screen; clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%); }
        .anim-rumble .chest-img { animation: rumble 0.5s linear; }
        @keyframes rumble { 0% { transform: rotate(0deg) translate(0,0); } 10% { transform: rotate(-3deg) translate(-2px, 0); } 20% { transform: rotate(3deg) translate(2px, 0); } 30% { transform: rotate(-3deg) translate(-2px, 0); } 40% { transform: rotate(3deg) translate(2px, 0); } 50% { transform: rotate(-3deg) translate(-2px, 0); } 100% { transform: rotate(0deg) translate(0,0); } }
        .anim-slam .chest-img { animation: slamChest 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both; }
        @keyframes slamChest { 0% { transform: scale(1.1) translateY(-10px); } 60% { transform: scale(0.95) translateY(5px); } 100% { transform: scale(1) translateY(0); } }
        .anim-reveal .burst-fan { animation: fanBurst 1s ease-out forwards; }
        @keyframes fanBurst { 0% { transform: translate(-50%, -20%) scale(0); opacity: 0; } 20% { transform: translate(-50%, -60%) scale(1.5); opacity: 1; } 100% { transform: translate(-50%, -80%) scale(2); opacity: 0; } }
        .item-pop { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 4rem; z-index: 20; pointer-events: none; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .flying-item { position: fixed; width: 120px; height: 120px; z-index: 9000; pointer-events: none; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; font-size: 4.5rem; }
        #mysteryOverlay { z-index: 3500; display: none; }
        #mysteryOverlay.active { display: flex; animation: fadeIn 0.4s forwards; }
        .mystery-card { background: rgba(255, 255, 255, 0.95); border-radius: 30px; padding: 30px; width: 95%; max-width: 480px; text-align: center; border: 4px solid #8e44ad; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; align-items: center; opacity: 0; transform: scale(0.8); transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #mysteryOverlay.active .mystery-card { opacity: 1; transform: scale(1); }
        .mystery-icon { font-size: 6rem; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2)); margin: 10px 0; }
        .quiz-opt-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 15px; }
        .quiz-btn { background: #f0f0f0; border: 3px solid #ccc; border-radius: 20px; padding: 20px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; box-shadow: 0 5px 0 rgba(0,0,0,0.1); }
        .quiz-btn:hover { background: white; border-color: #8e44ad; }
        .quiz-btn:active { transform: translateY(4px); box-shadow: none; }
        .quiz-btn img { width: 100%; max-height: 80px; object-fit: contain; }
        .quiz-btn-small { width: 65px; height: 65px; border-radius: 50%; border: none; background: #fdcb6e; cursor: pointer; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 4px 0 #d35400; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .quiz-btn-small:active { transform: translateY(2px); box-shadow: none; }
        .quiz-btn-big { width: 70px; height: 70px; border-radius: 50%; background: #fdcb6e; border: 4px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.2); font-size: 1.8rem; cursor: pointer; margin-left: 10px; display: flex; align-items: center; justify-content: center; }
        #mysteryResultScreen { background-color: #000; overflow: hidden; }
        .rain-hud { position: absolute; top: 10px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 100; color: white; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; }
        .rain-target-box { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 10px; }
        .rain-item { position: absolute; font-size: 4.5rem; cursor: pointer; user-select: none; z-index: 50; transition: transform 0.1s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); will-change: top; }
        .rain-item:active { transform: scale(0.9); }
        .rain-splash { position: absolute; font-size: 2rem; pointer-events: none; animation: splash 0.5s forwards; font-weight: bold; }
        @keyframes splash { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .final-result-box { background: white; border-radius: 30px; padding: 40px; text-align: center; width: 90%; max-width: 500px; box-shadow: 0 0 50px rgba(255,215,0,0.3); animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; margin: 20px auto; border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .detail-score { display: flex; justify-content: space-around; width: 100%; margin: 20px 0; background: #f9f9f9; padding: 15px; border-radius: 15px; }
        .ds-item small { display: block; color: #777; font-size: 0.8rem; text-transform: uppercase; }
        .ds-item span { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .target-arab { font-family: var(--font-arabic); font-size: 3rem; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .speaker-icon { font-size: 1.5rem; cursor: pointer; background: #f1c40f; color: #d35400; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 4px 0 #e67e22; pointer-events: auto; }
        .speaker-icon:active { transform: translateY(2px); box-shadow: 0 0 0 #e67e22; }
    
        /* ===== Arrange Mode (Susun Huruf) - scoped ===== */
        #arrangeScreen .glass-box { background: var(--glass-strong); border: var(--glass-border); border-radius: 16px; padding: 16px; }
        #arrangeScreen .arrange-slots { display:flex; flex-wrap:nowrap; gap:10px; margin-top:14px; justify-content:center; direction: rtl; unicode-bidi: plaintext; overflow-x:auto; padding-bottom:6px; }
        #arrangeScreen .arrange-slot { min-width: 78px; min-height: 78px; padding:10px 12px; border-radius:12px; border:2px dashed rgba(45,52,54,.35); background: rgba(255,255,255,.65); font-size: clamp(2.1rem, 4.2vw, 3.2rem); font-weight:900; color:#2d3436; text-align:center; font-family: var(--font-arabic); direction: rtl; unicode-bidi: plaintext; }

        #arrangeScreen .arrange-slot.filled { cursor:pointer; border-style: solid; border-color: rgba(45,52,54,.45); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
        #arrangeScreen .arrange-slot.filled:active { transform: scale(0.98); }

        /* Flying token animation (does not affect layout) */
        .arrange-fly {
            position: fixed;
            z-index: 9998;
            padding: 14px 16px;
            border-radius: 14px;
            border: 2px solid rgba(255,255,255,.7);
            background: rgba(255,255,255,.95);
            box-shadow: 0 12px 30px rgba(0,0,0,.18);
            font-family: var(--font-arabic);
            font-size: clamp(2.0rem, 3.8vw, 3.0rem);
            font-weight: 900;
            color: #2d3436;
            text-align: center;
            direction: rtl;
            unicode-bidi: plaintext;
            pointer-events: none;
            will-change: transform;
        }

        #arrangeScreen .arrange-bank { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; justify-content:center; direction: rtl; unicode-bidi: plaintext; }
        #arrangeScreen .arrange-part { padding: 14px 16px; border-radius:14px; border:2px solid rgba(0,0,0,.12); background: rgba(255,255,255,.92); font-size: clamp(2.0rem, 3.8vw, 3.0rem); font-weight:900; cursor:pointer; user-select:none; font-family: var(--font-arabic); direction: rtl; unicode-bidi: plaintext; }
        #arrangeScreen .arrange-part:disabled { opacity:.45; cursor:not-allowed; }
        #arrangeScreen .arrange-feedback { margin-top:12px; min-height:28px; font-weight:900; color:#2d3436; text-align:center; }

#arrangeScreen .arrange-help { margin-top:12px; padding:12px; border-radius:14px; border:2px dashed rgba(45,52,54,.28); background: rgba(255,255,255,.78); display:none; }
#arrangeScreen .arrange-help-title { font-weight:900; color:#2d3436; margin-bottom:10px; text-align:center; }
#arrangeScreen .arrange-help img { display:block; width:150px; max-width:150px; height:auto; object-fit:contain; margin:0 auto; border-radius:12px; border:2px solid rgba(0,0,0,.08); background: rgba(255,255,255,.9); }
#arrangeScreen .arrange-help-note { margin-top:10px; font-weight:800; color:#444; text-align:center; line-height:1.35; }

    

/* Hint overlay (tidak menggeser layout) */
#arrangeScreen .arrange-help-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,.40);
  z-index: 9999;
}
#arrangeScreen .arrange-help-card {
  width: min(520px, 94vw);
  border-radius: 18px;
  padding: 14px 14px 16px;
  background: rgba(255,255,255,.94);
  border: 2px solid rgba(0,0,0,.10);
  box-shadow: 0 18px 50px rgba(0,0,0,.22);
  text-align: center;
}
#arrangeScreen .arrange-help-card .arrange-help-title {
  margin: 2px 0 10px;
}
#arrangeScreen .arrange-help-card img {
  display: block;
  width: 150px;
  max-width: 150px;
  height: auto;
  object-fit: contain;
  margin: 0 auto;
  border-radius: 12px;
  border: 2px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.92);
}
#arrangeScreen .arrange-help-card .arrange-help-note {
  margin-top: 10px;
}
#arrangeScreen .arrange-help-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* Apresiasi benar overlay (tidak menggeser layout) */
#arrangeScreen .arrange-praise-overlay{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  padding:18px;
  background:rgba(0,0,0,.45);
  z-index:10000;
}
#arrangeScreen .arrange-praise-card{
  width:min(560px,94vw);
  border-radius:18px;
  padding:16px 16px 18px;
  background:rgba(255,255,255,.95);
  border:2px solid rgba(0,0,0,.10);
  box-shadow:0 18px 50px rgba(0,0,0,.22);
  text-align:center;
}
#arrangeScreen .arrange-praise-title{
  font-weight:1000;
  font-size:28px;
  letter-spacing:.2px;
  margin:2px 0 6px;
}
#arrangeScreen .arrange-praise-sub{
  font-weight:800;
  color:#2d3436;
  opacity:.90;
  margin-bottom:10px;
}
#arrangeScreen .arrange-praise-ar{
  margin-top:10px;
  font-family: 'Noto Naskh Arabic', 'Amiri', serif;
  font-size: clamp(30px, 4.8vw, 44px);
  font-weight: 900;
  direction: rtl;
}
#arrangeScreen .arrange-praise-id{
  margin-top:6px;
  font-size:18px;
  font-weight:800;
  color:#333;
}
#arrangeScreen #arrangePraiseImg{
  display:block;
  margin:0 auto;
  width:min(78vw, 360px);
  max-height: 44vh;
  object-fit:contain;
  object-position:center center;
  border-radius:14px;
  border:2px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.75);
  transition: opacity .14s ease;
  opacity: 0;
}

#arrangeScreen .arrange-praise-actions{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin-top:14px;
  flex-wrap:wrap;
}
#arrangeScreen .arrange-praise-actions .btn{
  min-width:120px;
}
#arrangeScreen .arrange-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px;
}
#arrangeScreen .arrange-modal-card {
    width: min(820px, 96vw);
    background: rgba(255,255,255,.92);
    border: 2px solid rgba(255,255,255,.55);
    box-shadow: 0 18px 55px rgba(0,0,0,.35);
    border-radius: 22px;
    padding: 18px 16px;
    text-align: center;
}
#arrangeScreen .arrange-modal-title {
    font-weight: 1000;
    color: #2d3436;
    font-size: 1.25rem;
}
#arrangeScreen .arrange-modal-word {
    margin-top: 12px;
    font-family: var(--font-arabic);
    font-size: 3.2rem;
    font-weight: 1000;
    color: #2d3436;
    direction: rtl;
    unicode-bidi: plaintext;
    line-height: 1.1;
}
#arrangeScreen .arrange-modal-note {
    margin-top: 10px;
    font-weight: 800;
    color: #555;
    line-height: 1.35;
}


        /* ===== Learn Mode (Belajar) - scoped to Arrange Screen ===== */
        #arrangeScreen .arrange-mode-overlay{
          position: fixed;
          inset: 0;
          display: none;
          align-items: center;
          justify-content: center;
          padding: 18px;
          background: rgba(0,0,0,.45);
          backdrop-filter: blur(6px);
          -webkit-backdrop-filter: blur(6px);
          z-index: 10020;
        }
        #arrangeScreen .arrange-mode-card{
          width: min(560px, 94vw);
          border-radius: 18px;
          padding: 16px 16px 18px;
          background: rgba(255,255,255,.95);
          border: 2px solid rgba(0,0,0,.10);
          box-shadow: 0 18px 50px rgba(0,0,0,.22);
          text-align: center;
        }
        #arrangeScreen .arrange-mode-title{
          font-weight: 1000;
          color: #2d3436;
          font-size: 1.25rem;
        }
        #arrangeScreen .arrange-mode-sub{
          margin-top: 6px;
          font-weight: 900;
          color: #2d3436;
          opacity: .95;
        }
        #arrangeScreen .arrange-mode-note{
          margin-top: 10px;
          padding: 10px 12px;
          border-radius: 14px;
          border: 2px dashed rgba(45,52,54,.25);
          background: rgba(255,255,255,.85);
          font-weight: 800;
          color: #444;
          line-height: 1.35;
        }

        #arrangeScreen .learn-start-panel{
          margin-top: 14px;
          padding: 14px 14px 16px;
          border-radius: 18px;
          border: 2px dashed rgba(45,52,54,.25);
          background: rgba(255,255,255,.86);
          text-align: center;
        }

        #arrangeScreen .learn-stage{
          position: relative;
          margin-top: 14px;
          min-height: 260px;
        }

        #arrangeScreen .learn-grid{
          display: grid;
          grid-template-columns: repeat(3, minmax(0, 1fr));
          gap: 12px;
          margin-top: 12px;
        }
        @media (max-width: 520px){
          #arrangeScreen .learn-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        #arrangeScreen .learn-card{
          position: relative;
          border-radius: 16px;
          overflow: hidden;
          border: 2px solid rgba(0,0,0,.10);
          background: rgba(255,255,255,.92);
          box-shadow: 0 10px 25px rgba(0,0,0,.10);
          cursor: pointer;
          user-select: none;
          transition: transform .12s ease;
        }
        #arrangeScreen .learn-card:active{ transform: scale(0.98); }
        #arrangeScreen .learn-card.disabled{ opacity: .55; cursor: not-allowed; }
        #arrangeScreen .learn-flip{
          position: relative;
          width: 100%;
          height: 220px;
          perspective: 1000px;
        }
        #arrangeScreen .learn-flip-inner{
          position: absolute;
          inset: 0;
          border-radius: 16px;
          transform-style: preserve-3d;
          transition: transform .55s cubic-bezier(.2,.8,.2,1);
        }
        #arrangeScreen .learn-card.is-closed .learn-flip-inner{ transform: rotateY(180deg); }
        #arrangeScreen .learn-face{
          position: absolute;
          inset: 0;
          backface-visibility: hidden;
          border-radius: 16px;
          overflow: hidden;
          display:flex;
          align-items:center;
          justify-content:center;
          background: rgba(255,255,255,.92);
        }
        #arrangeScreen .learn-face.front{
          background: rgba(255,255,255,.92);
        }
        #arrangeScreen .learn-face.front img{
          width: 100%;
          height: 100%;
          object-fit: contain;
          display:block;
          padding: 12px;
          background: rgba(255,255,255,.90);
        }
        #arrangeScreen .learn-face.back{
          transform: rotateY(180deg);
          background:
            radial-gradient(circle at 20% 20%, rgba(52,152,219,.22), transparent 55%),
            radial-gradient(circle at 80% 30%, rgba(46,204,113,.18), transparent 60%),
            radial-gradient(circle at 35% 85%, rgba(241,196,15,.18), transparent 60%),
            rgba(255,255,255,.92);
        }
        #arrangeScreen .learn-back-mark{
          width: 76%;
          height: 76%;
          border-radius: 18px;
          border: 3px dashed rgba(45,52,54,.18);
          display:flex;
          align-items:center;
          justify-content:center;
          font-weight: 1000;
          color: rgba(45,52,54,.55);
          letter-spacing: .5px;
          text-transform: uppercase;
        }

        #arrangeScreen .learn-badge{
          position: absolute;
          top: 8px;
          right: 8px;
          padding: 6px 10px;
          border-radius: 999px;
          font-weight: 1000;
          font-size: .85rem;
          background: rgba(0,0,0,.60);
          color: white;
          box-shadow: 0 8px 18px rgba(0,0,0,.18);
        }
        #arrangeScreen .learn-badge.done{ background: rgba(46,204,113,.95); }

        #arrangeScreen .learn-float-layer{
          position: absolute;
          inset: 0;
          pointer-events: none;
          z-index: 8;
        }
        #arrangeScreen .learn-float{

          position: absolute;
          border-radius: 16px;
          overflow: hidden;
          border: 2px solid rgba(0,0,0,.10);
          background: rgba(255,255,255,.94);
          box-shadow: 0 18px 45px rgba(0,0,0,.18);
          will-change: left, top, transform;
          transition: left .55s cubic-bezier(0.25,1,0.5,1),
                      top .55s cubic-bezier(0.25,1,0.5,1),
                      transform .55s cubic-bezier(0.25,1,0.5,1);
        }
        #arrangeScreen .learn-float img{
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
          padding: 10px;
          background: rgba(255,255,255,.80);
        }

        #arrangeScreen .learn-modal-overlay{
          position: fixed;
          inset: 0;
          display: none;
          align-items: center;
          justify-content: center;
          padding: 18px;
          background: rgba(0,0,0,.50);
          backdrop-filter: blur(6px);
          -webkit-backdrop-filter: blur(6px);
          z-index: 10030;
        }
        #arrangeScreen .learn-modal-card{
          width: min(820px, 96vw);
          background: rgba(255,255,255,.94);
          border: 2px solid rgba(255,255,255,.55);
          box-shadow: 0 18px 55px rgba(0,0,0,.35);
          border-radius: 22px;
          padding: 18px 16px;
          text-align: center;
        }
        #arrangeScreen .learn-modal-title{
          font-weight: 1000;
          color: #2d3436;
          font-size: 1.25rem;
        }
        #arrangeScreen .learn-mufradat-img{
          display:block;
          width:min(78vw, 360px);
          max-height: 38vh;
          object-fit:contain;
          object-position:center center;
          margin: 12px auto 0;
          border-radius: 14px;
          border: 2px solid rgba(0,0,0,.08);
          background: rgba(255,255,255,.78);
        }
        #arrangeScreen .learn-ar{
          margin-top: 12px;
          font-family: var(--font-arabic);
          font-size: 3.2rem;
          font-weight: 1000;
          color: #2d3436;
          direction: rtl;
          unicode-bidi: plaintext;
          line-height: 1.1;
        }
        #arrangeScreen .learn-id{
          margin-top: 8px;
          font-size: 1.2rem;
          font-weight: 900;
          color: #333;
        }
        #arrangeScreen .learn-audio-req{
          margin-top: 10px;
          font-weight: 800;
          color: #555;
          line-height: 1.35;
        }
        #arrangeScreen .learn-quiz-title{
          margin-top: 10px;
          font-weight: 1000;
          color: #2d3436;
          font-size: 1.1rem;
        }
        #arrangeScreen .learn-quiz-grid{
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 12px;
          margin-top: 12px;
        }
#arrangeScreen .learn-quiz-btn{
          padding: 16px 12px;
          border-radius: 18px;
          border: 3px solid rgba(0,0,0,.12);
          background: rgba(255,255,255,.96);
          font-weight: 1000;
          cursor: pointer;
          box-shadow: 0 8px 18px rgba(0,0,0,.10);
          transition: transform .12s ease;
        }
        #arrangeScreen .learn-quiz-btn:active{ transform: scale(0.98); }
        #arrangeScreen .learn-quiz-btn.correct{ border-color: rgba(46,204,113,.85); background: rgba(213,245,227,.95); }
        #arrangeScreen .learn-quiz-btn.wrong{ border-color: rgba(231,76,60,.75); background: rgba(250,219,216,.95); }

    
        /* ===== Compact Arrange Play for small screens (no scaling transform) ===== */
        @media (max-height: 760px){
          #arrangePlayView .glass-box{ padding: 14px 12px !important; }
          #arrangePlayView #arrangeTray{ gap: 8px !important; padding: 10px !important; }
          #arrangePlayView #arrangeBank{ gap: 8px !important; padding: 10px !important; }
          #arrangePlayView .tile{
            width: 48px !important;
            height: 48px !important;
            font-size: 1.35rem !important;
          }
          #arrangePlayView .btn{ padding: 14px 14px !important; font-size: 1.05rem !important; }
          /* jangan kecilkan terjemahan Indo */
          #arrangePlayView #arrangeMeaning{ font-size: 1rem !important; }
        }
        @media (max-height: 680px){
          #arrangePlayView .glass-box{ padding: 12px 10px !important; }
          #arrangePlayView .tile{
            width: 44px !important;
            height: 44px !important;
            font-size: 1.28rem !important;
          }
          #arrangePlayView .btn{ padding: 12px 12px !important; font-size: 1.0rem !important; }
          #arrangePlayView #arrangeMeaning{ font-size: 1rem !important; }
        }

    
        /* ===== Compact Learn Modal on mobile (no scroll) + enlarge ID options ===== */
@media (max-height: 760px){
          #arrangeScreen .learn-mufradat-img{ max-height: 30vh !important; }
          #arrangeScreen .learn-ar{ font-size: 2.7rem !important; }
          #arrangeScreen .learn-id{ font-size: 1.15rem !important; }
          #arrangeScreen .learn-quiz-btn{ padding: 14px 12px !important; }
          /* opsi jawaban Indonesia (Q1) dibesarkan */
          #arrangeScreen .learn-quiz-btn.id-option{
            font-size: 1.2rem !important;
            line-height: 1.25 !important;
          }
        }

    
        /* ===== FORCE compact UI on touch devices (pointer: coarse) ===== */
        /* [REMOVED mobile coarse overrides for desktop-pure build] */


    
        /* ===== Quiz options: bigger text + bigger capsule (mobile-friendly) ===== */
        #arrangeScreen .learn-quiz-btn{
          font-size: 1.2rem !important;
          padding: 16px 14px !important;
          min-height: 60px !important;
          border-radius: 18px !important;
          white-space: normal !important;
          line-height: 1.25 !important;
        }
        #arrangeScreen .learn-quiz-btn.arabic{
          font-size: 1.45rem !important;
          line-height: 1.2 !important;
        }
        #arrangeScreen .learn-quiz-grid{
          gap: 12px !important;
        }

    
        #ultimateFinishBtn{ width:80%; max-width:520px; margin-top:18px; font-size:1.25rem; padding:16px 22px; }

/* Report mode full-screen background (only when viewing a specific report page, not the 4-button report menu) */
#scoreboardScreen.report-mode-bg {
  background-image: url('https://cdn.imgpile.com/f/cDGQy5Q_xl.png') !important;
  background-size: cover !important;
  background-position: center center !important;
  background-repeat: no-repeat !important;
}



        /* === Desktop-pure: force all characters below content (match original mobile layout) === */
        #welcomeScreen .welcome-container{ flex-direction: column !important; justify-content: center !important; align-items: center !important; gap: 0 !important; }
        #welcomeScreen .content-box{ width: 100% !important; max-width: 800px !important; text-align: center !important; align-items: center !important; order: 1 !important; margin: 0 !important; }
        #welcomeScreen .welcome-char{ order: 2 !important; height: 280px !important; margin-top: -30px !important; margin-left: 0 !important; z-index: 6 !important; position: relative !important; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.4)) !important; }

        .level-container{ flex-direction: column !important; align-items: center !important; justify-content: center !important; }
        .level-content{ order: 1 !important; margin: 0 !important; width: auto !important; max-width: 520px !important; }
        .level-char{ order: 2 !important; height: 250px !important; margin-top: -50px !important; margin-left: 0 !important; margin-right: 0 !important; animation: slideUp 0.8s cubic-bezier(0.2,0.8,0.2,1) forwards !important; }
        .level-container.pos-left .level-char,
        .level-container.pos-right .level-char{ order: 2 !important; margin-left: 0 !important; margin-right: 0 !important; animation: slideUp 0.8s cubic-bezier(0.2,0.8,0.2,1) forwards !important; }

        /* Desktop-pure refinement: make LEVEL (Sekolah/Peta) layout feel less sempit after scaling */
        #levelScreen .level-content{ max-width: 680px !important; }
        #levelScreen .header-chip-container{ margin-bottom: 22px !important; }
        #levelScreen .nav-chip{ padding: 14px 28px !important; font-size: 1rem !important; }
        #levelScreen .image-placeholder{ margin-bottom: 22px !important; }
        #levelScreen .arabic-chip{ padding: 12px 44px !important; margin: 14px 0 28px 0 !important; }
        #levelScreen .info-chip{ padding: 10px 28px !important; margin-bottom: 12px !important; }
        #levelScreen .meaning-chip{ padding: 12px 46px !important; margin-bottom: 32px !important; }
        #levelScreen .floating-action-bar{ gap: 18px !important; padding: 12px !important; margin-top: 16px !important; border-radius: 34px !important; }

</style>

    <style id="desktopPureScaler">
      :root{ --uiScale: 1; }
      html, body{ overflow-x: hidden; }
      #viewportRoot{ width: 100%; }
      #viewportRoot.scaled{
        transform: scale(var(--uiScale));
        transform-origin: top center;
        width: calc(100% / var(--uiScale));
      }
    </style>

</head>
<body>
  <div id="viewportRoot">
    <div id="assetPreloader"></div><div id="flashOverlay"></div><canvas id="canvasFireworks"></canvas>
    <div id="ultimateRewardScreen"><div class="ult-rays"></div><div class="ult-strobe"></div><div class="ult-content" id="ultContent"><div style="font-size:8rem; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));" class="anim-slam">ðŸ†</div><div class="ult-text-chip anim-slam"><h1 class="ult-arabic">Ù…ÙÙ…Ù’ØªÙŽØ§Ø²<br>ØªÙŽÙ…Ø§Ù…Ù‹Ø§</h1></div><div class="ult-score-box anim-pop">100</div><div class="ult-info-chip anim-pop"><p style="color:#2d3436; font-size:1.2rem; font-weight:600; font-style:italic; margin:0;">MasyaAllah Tabarakallah!</p></div><button id="ultimateFinishBtn" class="btn anim-pop" onclick="GameEngine.finishSession()">SELESAI & SIMPAN</button></div></div>
    <div id="mysteryOverlay"><div class="mystery-card" id="mysteryCardContent"></div></div>
    <div id="app">
        <div id="topHud">
            <div class="progress-container">
                <div class="progress-label" id="hudText">PROGRES 0/7</div>
                <div class="progress-bg"><div id="hudBar" class="progress-fill"></div></div>
            </div>
            <div class="score-box">â­ <span id="hudScore">0</span> <div id="streakBadge">ðŸ”¥ 0</div></div>
        </div>
        <img id="watermarkLogo" src="https://cdn.imgpile.com/f/O34P3DX_xl.png" alt="Logo Game">
        <div id="feedbackOverlay"><div class="popup" id="fbCard"><div id="fbEmoji">ðŸŒŸ</div><h2 id="fbTitle">Benar!</h2><p id="fbText">Jawaban kamu tepat.</p></div></div>
        <div id="challengeOverlay"><div class="challenge-card"><div style="font-size:4rem;">ðŸŽ§</div><h2 style="color:#2d3436; margin-top:5px;">Tantangan Selesai!</h2><p style="color:#7f8c8d; font-weight:600;">Skor Akhir Kamu</p><div id="challengeFinalScore" class="big-score">0</div><p id="challengeAppreciation" style="font-style:italic; color:#555; margin-bottom:20px;">Luar biasa!</p><button class="btn" onclick="UIManager.closeChallengeOverlay()">Lanjut Peta âž¡</button></div></div>
        <div id="grandFinale"><div class="finale-fragments"><div class="finale-chip"><h1 id="finalTitle" style="margin:0; font-size:2.5rem; color:var(--dark);">...</h1></div><div id="finalEmoji" class="finale-icon-solo">ðŸ†</div><div class="finale-chip"><div id="finalAppreciation" style="font-size:1.2rem; font-style:italic; color:#444; font-weight:600;">...</div></div><div class="score-chip"><span id="finalScore">0</span> / 100</div><button class="btn" style="width:fit-content; padding: 15px 50px; margin-top:10px; box-shadow:0 10px 20px rgba(0,0,0,0.2);" onclick="GameEngine.finishSession()">Selesai & Simpan</button></div></div>
        <section id="coverScreen" class="active-screen"><video id="introVideo" src="https://cdn.imgpile.com/f/UoiRMbx_lg.mp4" playsinline webkit-playsinline preload="auto" style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; display:none; z-index:20; background:black;"></video><img src="https://cdn.imgpile.com/f/vnt54eD_xl.png" class="start-btn-img" id="startBtnImg" onclick="GameEngine.startIntroSequence()" alt="Mulai Game"></section>
        <section id="welcomeScreen"><div class="welcome-container"><div class="content-box"><div class="cover-arabic">Ø£ÙŽÙ‡Ù’Ù„Ù‹Ø§ ÙˆÙŽØ³ÙŽÙ‡Ù’Ù„Ù‹Ø§</div><h1 style="color:var(--primary); margin-bottom: 10px;">Petualangan<br>Kota Arabiyah</h1><p class="welcome-text">Selamat datang para penuntut ilmu!<br>Siap menjelajahi dunia sambil menghafal kosakata?</p><div class="quote-box">"Barangsiapa menempuh jalan untuk mencari ilmu, maka Allah akan mudahkan baginya jalan menuju Surga."<br><b>(HR. Muslim)</b></div><button class="btn" onclick="GameEngine.init()">ðŸš€ Mulai Petualangan</button></div><img src="https://cdn.imgpile.com/f/lFtkSgP_xl.png" class="welcome-char" alt="Karakter"></div></section>
        <section id="chapterScreen"><div class="content-box" style="max-width:800px; background:rgba(255,255,255,0.4);"><h2 style="color:var(--dark); margin-bottom:10px;">Pilih Petualangan</h2><div class="chapter-grid"><div class="chapter-card" onclick="GameEngine.selectChapter('ch1')"><img src="https://cdn.imgpile.com/f/S1UGSrs_xl.png" class="chapter-icon-img" alt="P1"><h3 style="color:var(--primary);">Petualangan 1</h3></div><div class="chapter-card" onclick="GameEngine.selectChapter('ch2')"><img src="https://cdn.imgpile.com/f/gBlzPng_xl.png" class="chapter-icon-img" alt="P2"><h3 style="color:#e67e22;">Petualangan 2</h3></div><div class="chapter-card" onclick="GameEngine.startMysteryMode()" style="border-color:#8e44ad;"><img src="https://cdn.imgpile.com/f/1GiGzK9_xl.png" class="chapter-icon-img" alt="Mystery"><h3 style="color:#8e44ad;">Ruang Harta</h3></div><div class="chapter-card" onclick="GameEngine.startPuzzleMode()" style="border-color:var(--secondary);"><img src="https://cdn.imgpile.com/f/jBmAWF6_xl.png" class="chapter-icon-img" alt="Teka Teki"><h3 style="color:var(--secondary);">Teka-Teki</h3></div><div class="chapter-card" onclick="GameEngine.startArrangeMode()" style="border-color:var(--primary);"><img src="https://cdn.imgpile.com/f/K2Ls2l4_xl.png" class="chapter-icon-img" alt="Susun Huruf"><h3 style="color:var(--primary);">Susun Huruf</h3></div><div class="chapter-card" onclick="GameEngine.showReportMenu()" style="border-color:#9b59b6;"><img src="https://cdn.imgpile.com/f/gA15TFm_xl.png" class="chapter-icon-img" alt="Raport"><h3 style="color:#8e44ad;">Raport</h3></div></div><button class="btn" style="background:linear-gradient(to bottom, #9b59b6, #8e44ad); margin-top:20px; box-shadow:0 6px 0 #71368a;" onclick="GameEngine.showReportMenu()">Lihat Raport Belajar</button><button class="btn-secondary" style="margin-top:10px;" onclick="UIManager.showScreen('welcomeScreen')">â¬… Kembali</button></div></section>

        
        <section id="arrangeScreen">
            <div class="content-box" style="max-width:820px;">
                <div class="title-chip"><h3>Susun Huruf</h3></div>

                <!-- View: pilih chapter -->
                <div id="arrangeSelectView">
                    <p style="color:#2d3436; font-weight:800; margin:10px 0 0 0; line-height:1.5;">
                        Pilih Chapter terlebih dahulu
                    </p>
                    <p style="color:#555; font-weight:600; margin:8px 0 18px 0; line-height:1.5;">
                        Penilaian <b>harakat harus persis</b>. Metode input: <b>klik potongan</b>.
                    </p>

                    <div style="display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:14px; margin-top:10px;">
                        <button class="btn" onclick="GameEngine.arrangePickChapter('ch1')" style="padding:18px 14px; font-size:1.1rem;">ðŸ“˜ Chapter 1</button>
                        <button class="btn" onclick="GameEngine.arrangePickChapter('ch2')" style="padding:18px 14px; font-size:1.1rem; background:var(--secondary);">ðŸ“™ Chapter 2</button>
                    </div>

                                        <!-- Mode Picker: Belajar / Susun (isolated) -->
                    <div id="arrangeModePicker" class="arrange-mode-overlay" style="display:none;" role="dialog" aria-modal="true"
                         onclick="if(event.target===this) GameEngine.arrangeCloseModePicker()">
                      <div class="arrange-mode-card" onclick="event.stopPropagation()">
                        <div class="arrange-mode-title">Pilih Mode</div>
                        <div id="arrangeModeChapterText" class="arrange-mode-sub">Chapter -</div>
                        <div id="arrangeModeLockNote" class="arrange-mode-note" style="display:none;">
                          Mode <b>Belajar</b> disarankan agar lebih mudah. <b>Susun Huruf</b> boleh langsung.
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px;">
                          <button class="btn" style="min-width:160px;" onclick="GameEngine.arrangeStartLearnFromPicker()">ðŸ“š Belajar</button>
                          <button id="arrangeBtnPickerArrange" class="btn" style="min-width:160px; background:var(--secondary);" onclick="GameEngine.arrangeStartArrangeFromPicker()">ðŸ§± Susun Huruf</button>
                        </div>
                        <button class="btn-secondary" style="margin-top:14px;" onclick="GameEngine.arrangeCloseModePicker()">Tutup</button>
                      </div>
                    </div>

                    <button class="btn-secondary" style="margin-top:18px;" onclick="UIManager.showScreen('chapterScreen')">â¬… Kembali</button>
                </div>

                <!-- View: bermain -->
                <div id="arrangePlayView" style="display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:8px;">
                        <div style="font-weight:900; color:#2d3436;">
                            Chapter: <span id="arrangeChapterLabel">-</span>
                        </div>
                        <div style="text-align:right;">
                            <div id="arrangeProgressLine" style="font-weight:900; color:#2d3436;"></div>
                            <div id="arrangeStatsLine" style="font-weight:800; color:#2d3436; opacity:.9;"></div>
                        </div>
                    </div>

                    <div class="glass-box" style="margin-top:14px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                            <div style="font-weight:900; color:#2d3436;">Susun potongan menjadi kata yang benar</div>
                            <div style="font-weight:900; color:#2d3436; opacity:.85;">Streak: <span id="arrangeStreak">0</span></div>
                        </div>

                        <div id="arrangeSlots" class="arrange-slots"></div>

                        <div id="arrangeFeedback" class="arrange-feedback" aria-live="polite"></div>


<div id="arrangeHelpBox" class="arrange-help" aria-live="polite">
    <div class="arrange-help-title">Bantuan Gambar</div>
    <img id="arrangeHelpImg" src="" alt="Bantuan gambar" />
    <div id="arrangeHelpNote" class="arrange-help-note"></div>
    <button class="btn-secondary" style="margin-top:10px; padding:10px 12px;" onclick="GameEngine.arrangeHideHelp()">Sembunyikan</button>
</div>

                        
<div id="arrangeRevealOverlay" class="arrange-modal-overlay" role="dialog" aria-modal="true" style="display:none;">
  <div class="arrange-modal-card">
    <div class="arrange-modal-title">Jawaban yang benar</div>
    <div id="arrangeRevealWord" class="arrange-modal-word" dir="rtl"></div>
    <div id="arrangeRevealNote" class="arrange-modal-note">Silakan perhatikan, lalu klik <b>Lanjut</b>.</div>
    <button class="btn" style="margin-top:14px;" onclick="GameEngine.arrangeRevealContinue()">âž¡ Lanjut</button>
  </div>
</div>

<div style="margin-top:14px; font-weight:900; color:#2d3436;">Potongan</div>
                        <div id="arrangePartsBank" class="arrange-bank"></div>

                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">                            <button id="arrangeBtnCheck" class="btn" onclick="GameEngine.arrangeCheck()" disabled>âœ… Cek</button>
                            <button class="btn-secondary" onclick="GameEngine.arrangeSkip()">â­ Lewati</button>
                            <button class="btn-secondary" onclick="GameEngine.arrangeBackToSelect()">â¬… Ganti Chapter</button>
                        </div>
                    </div>
                </div>

                <!-- View: belajar -->
                <div id="arrangeLearnView" style="display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:8px;">
                        <div style="font-weight:900; color:#2d3436;">
                            Chapter: <span id="learnChapterLabel">-</span>
                        </div>
                        <div style="text-align:right;">
                            <div id="learnProgressLine" style="font-weight:900; color:#2d3436;"></div>
                            <div style="font-weight:800; color:#2d3436; opacity:.9;">Belajar dulu agar lebih mudah.</div>
                        </div>
                    </div>

                    <div class="glass-box" style="margin-top:14px; position:relative;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                            <div style="font-weight:900; color:#2d3436;">Belajar per kartu</div></div>

                        <div id="learnStartPanel" class="learn-start-panel">
                            <div style="font-weight:900; color:#2d3436;">Siap belajar?</div>
                            <div style="font-weight:700; color:#555; margin-top:6px; line-height:1.35;">
                                Klik <b>Mulai</b> untuk acak kartu, lalu pilih satu per satu.
                            </div>
                            <button class="btn" style="margin-top:10px; min-width:180px;" onclick="GameEngine.LearnMode.begin()">â–¶ Mulai</button>
                        </div>

                        <div id="learnShuffleStage" class="learn-stage">
                            <div id="learnGrid" class="learn-grid" aria-live="polite"></div>
                            <div id="learnFloatLayer" class="learn-float-layer"></div>
                        </div>

                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px;">
                            <button class="btn" style="min-width:180px;" onclick="GameEngine.LearnMode.shuffle()">ðŸ”€ Acak Kartu</button>
                            <button class="btn-secondary" onclick="GameEngine.arrangeBackToSelect()">â¬… Ganti Chapter</button>
                        </div>
                        <div style="display:flex; justify-content:center; margin-top:12px;">
                            <button id="learnBtnStartArrange" class="btn" style="background:var(--secondary); min-width:220px; display:none;"
                                    onclick="GameEngine.LearnMode.goToArrange()">ðŸ§± Main Susun Huruf</button>
                        </div>

                    </div>
                </div>

                <!-- Learn modal (material + latihan ringan) -->
                <div id="learnModal" class="learn-modal-overlay" style="display:none;" role="dialog" aria-modal="true"
                     onclick="if(event.target===this) GameEngine.LearnMode.closeModal()">
                  <div class="learn-modal-card" onclick="event.stopPropagation()">
                    <div id="learnModalTitle" class="learn-modal-title">Belajar</div>
                    <div id="learnModalBody"></div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px;">
                      <button id="learnModalPrimary" class="btn" onclick="GameEngine.LearnMode.primaryAction()">Mulai</button>
</div>
                  </div>
                </div>

            </div>
        
<!-- Hint overlay (muncul setelah 2x salah, tidak menggeser layout) -->
<div id="arrangeHelpOverlay" class="arrange-help-overlay" role="dialog" aria-modal="true" style="display:none;"
     onclick="if(event.target===this) GameEngine.arrangeHideHelp(true)">
  <div class="arrange-help-card">
    <div class="arrange-help-title">Bantuan Gambar</div>
    <img id="arrangeHelpOverlayImg" src="" alt="Bantuan gambar" />
    <div id="arrangeHelpOverlayNote" class="arrange-help-note"></div>
    <div class="arrange-help-actions">
      <button class="btn small" onclick="GameEngine.arrangeHideHelp()">Tutup</button>
    </div>
  </div>
</div>

<!-- Apresiasi benar overlay (muncul setiap jawaban benar, ditutup manual) -->
<div id="arrangePraiseOverlay" class="arrange-praise-overlay" role="dialog" aria-modal="true" style="display:none;">
  <div class="arrange-praise-card" onclick="event.stopPropagation()">
    <div class="arrange-praise-title" id="arrangePraiseTitle">Ù…ÙÙ…Ù’ØªÙŽØ§Ø²!</div>
    <div class="arrange-praise-sub" id="arrangePraiseSub">Jawaban benar</div>
    <img id="arrangePraiseImg" src="" alt="Apresiasi" style="display:none;" />
    <div class="arrange-praise-ar" id="arrangePraiseAr">â€”</div>
    <div class="arrange-praise-id" id="arrangePraiseId">â€”</div>
    <div class="arrange-praise-actions">
      <button class="btn small" onclick="GameEngine.arrangeReplayPraiseAudio()">ðŸ” Putar ulang</button>
      <button class="btn" onclick="GameEngine.arrangeHidePraise(true)">LANJUT</button>
    </div>
  </div>
</div>

</section>


<section id="arrangeVictoryScreen">
  <div class="content-box" style="max-width:820px;">
    <div class="title-chip"><h3>MUMTAZ!</h3></div>
    <div class="glass-box" style="margin-top:14px; text-align:center;">
      <div style="font-weight:1000; color:#2d3436; font-size:1.15rem;">Maa SyaaAllah Tabarakallah</div>
      <div id="arrangeVictoryScore" style="margin-top:12px; font-weight:1100; font-size:3rem; color:var(--primary);">0 / 0</div>
      <div id="arrangeVictoryMeta" style="margin-top:10px; font-weight:900; color:#2d3436; opacity:.95; line-height:1.4;"></div>
      <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:16px;">
        <button class="btn" onclick="GameEngine.arrangeVictoryDone()">âœ… Selesai & Simpan</button>
        <button style="display:none;" class="btn-secondary" onclick="GameEngine.arrangeRestartChapter()">ðŸ” Ulangi Chapter</button>
        <button class="btn-secondary" onclick="UIManager.showScreen('chapterScreen')">â¬… Kembali</button>
      </div>
    </div>
  </div>
</section>




        <section id="puzzleScreen"><div class="content-box" style="max-width:600px;"><h3>Teka-Teki Bahasa Arab</h3><div id="puzzleProgress" style="font-weight:800;color:var(--secondary);margin-bottom:10px">SOAL 1/18</div><div class="puzzle-speaker" onclick="GameEngine.playPuzzleAudio(true)">ðŸ”Š</div><div class="puzzle-riddle-box"><div id="puzzleRiddle" class="puzzle-text">...</div></div><div id="puzzleOptions" class="puzzle-options-grid"></div><button class="btn-secondary" style="margin-top:25px" onclick="UIManager.showScreen('chapterScreen')">Menyerah</button></div></section>
        <section id="mapScreen"><div class="content-box"><h2 style="margin-bottom:20px; color:var(--dark);">Peta Lokasi</h2><div id="mapGrid" class="map-grid"></div><div style="margin-top:25px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%;"><button class="btn" style="background:linear-gradient(to bottom, #9b59b6, #8e44ad); flex:1; min-width:140px; font-size:0.9rem; border:none; box-shadow:0 5px 0 #71368a;" onclick="GameEngine.startChallengeMenu()">ðŸŽ§ Tantangan</button><button id="btnQuiz" class="btn" style="background:linear-gradient(to bottom, #bdc3c7, #95a5a6); flex:1; min-width:140px; font-size:0.9rem; border:none; box-shadow:0 5px 0 #7f8c8d;" onclick="GameEngine.checkQuizAccess()">ðŸ† Final Quiz</button></div><button class="btn-secondary" style="margin-top:15px;" onclick="UIManager.showScreen('chapterScreen')">â¬… Kembali ke Menu</button></div></section>
        <section id="challengeSelectScreen"><div class="content-box"><h3>Pilih Level Tantangan</h3><div class="level-select-grid"><div id="lvlCh1" class="level-select-card" onclick="GameEngine.startChallengeLevel(1)" style="border-color:#2ecc71;"><div style="font-size:3rem;">ðŸ‘‚</div><h3>Level 1</h3><p>Dengar Arab âž¡ Pilih Gambar</p></div><div id="lvlCh2" class="level-select-card" onclick="GameEngine.startChallengeLevel(2)" style="border-color:#2ecc71;"><div style="font-size:3rem;">ðŸ‘€</div><h3>Level 2</h3><p>Lihat Gambar & Dengar Indo âž¡ Pilih Arab</p></div></div><button class="btn-secondary" style="margin-top:20px;" onclick="UIManager.showScreen('mapScreen')">Batal</button></div></section>
        <section id="levelScreen"><div id="levelWrapper" class="level-container"><img id="levelChar" src="" class="level-char" alt="Level Char"><div class="level-content"><div class="header-chip-container"><button class="nav-chip" onclick="UIManager.showScreen('mapScreen')">â¬… Peta</button><div class="title-chip"><h3 id="levelTitle">...</h3></div></div><div class="image-placeholder" onclick="GameEngine.playLevelAudio(true)"><div id="levelImg"></div></div><div id="levelArab" class="arabic-chip" onclick="GameEngine.playLevelAudio(false)">...</div><div id="levelLatin" class="info-chip">...</div><div id="levelIndo" class="meaning-chip" onclick="GameEngine.playLevelAudio(true)">...</div><div class="floating-action-bar"><button class="btn" style="background:var(--secondary); margin-top:0; width: 80px;" onclick="GameEngine.playLevelAudioFull()">ðŸ”Š</button><button class="btn" style="margin-top:0;" onclick="GameEngine.startGame1()">Latihan â–¶</button></div></div></div></section>
        <section id="game1Screen"><div class="content-box"><div class="title-chip"><h3>Tebak Kata</h3></div><div id="g1Icon" class="image-placeholder" style="margin-top:10px;"></div><div class="info-chip" style="margin-bottom:20px;" onclick="GameEngine.playCurrentQuestionAudio()"><h2 id="g1Label" style="margin:0; font-size:1.5rem; cursor:pointer;">... ??</h2></div><div id="g1Options" class="options-grid"></div></div></section>
        <section id="game2Screen"><div class="content-box"><div class="title-chip"><h3>Tebak Arti</h3></div><div id="g2Arab" class="arabic-chip" style="margin:20px 0; cursor:pointer; font-size: 3rem;" onclick="GameEngine.playCurrentQuestionAudio()">ðŸ”Š ...</div><div id="g2Options" class="options-grid"></div></div></section>
        <section id="game3Screen"><div class="content-box"><h3>Tantangan Level 1</h3><button class="btn" style="width:90px; height:90px; border-radius:50%; margin:20px auto; font-size: 2rem;" onclick="GameEngine.playChallengeAudio()">ðŸ”Š</button><p style="margin-bottom:15px; color:#666; font-size:0.9rem;">Dengarkan dan pilih gambar yang tepat!</p><div id="g3Options" class="img-grid"></div><button class="btn-secondary" style="margin-top:20px;" onclick="UIManager.showScreen('mapScreen')">Keluar</button></div></section>
        <section id="gameChallengeL2Screen"><div class="content-box"><h3>Tantangan Level 2</h3><div id="cl2Icon" class="image-placeholder" style="margin-top:20px;"></div><div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:20px;"><p style="color:#666; font-size:1rem; font-weight:bold;">Apa Bahasa Arabnya?</p><button class="btn" style="width:50px; height:50px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:50%; margin-top:0;" onclick="GameEngine.playChallengeAudio()">ðŸ”Š</button></div><div id="cl2Options" class="options-grid"></div><button class="btn-secondary" style="margin-top:20px;" onclick="UIManager.showScreen('mapScreen')">Keluar</button></div></section>
        <section id="quizScreen"><div class="content-box" style="max-width:800px;"><h3>Final Quiz</h3><div class="toggle-container"><div id="memToggle" class="toggle-btn active" onclick="GameEngine.toggleMemAudio()"><div class="toggle-circle"></div></div><small id="memToggleText" style="font-weight:bold; color:#555;">Suara Kartu: ON</small></div><div id="memoryBoard" class="memory-grid"></div><button class="btn-secondary" style="margin-top:20px;" onclick="UIManager.showScreen('mapScreen')">Keluar</button></div></section>
        <section id="scoreboardScreen">
  <div class="content-box">
<!-- MENU RAPORT (4 tombol) -->
    <div id="reportMenu" style="width:100%; display:flex; flex-direction:column; gap:10px;">
      <button class="btn" style="background:linear-gradient(to bottom, #27ae60, #219150); box-shadow:0 6px 0 #16733b;"
              onclick="GameEngine.openReportPage('adventure')">Petualangan</button>
      <button class="btn" style="background:linear-gradient(to bottom, #f1c40f, #d4ac0d); color:#2c3e50; box-shadow:0 6px 0 #b7950b;"
              onclick="GameEngine.openReportPage('mystery')">Buka Peti</button>
      <button class="btn" style="background:linear-gradient(to bottom, #3498db, #2980b9); box-shadow:0 6px 0 #1f5f8a;"
              onclick="GameEngine.openReportPage('puzzle')">Teka Teki</button>
      <button class="btn" style="background:linear-gradient(to bottom, #9b59b6, #8e44ad); box-shadow:0 6px 0 #71368a;"
              onclick="GameEngine.openReportPage('arrange')">Susun Huruf</button>

      <button class="btn-secondary" style="margin-top:10px;" onclick="UIManager.showScreen('chapterScreen')">Tutup</button>
    </div>

    <!-- HALAMAN RAPORT PER MODE -->
    <div id="reportPage" style="display:none; width:100%;">
      <h2 id="reportTitle" class="report-page-title">Raport</h2>
      <div id="scoreList" class="score-list"></div>
      <h3 id="sbTotalContainer" style="border-top:2px dashed #ccc; padding-top:15px; width:100%; margin-top:15px; font-size:1.3rem;">
        Total: <span id="sbTotal">0</span>
      </h3>
          <button class="btn-secondary report-back-btn" onclick="GameEngine.backToReportMenu()">â¬… Kembali</button>
    </div>
  </div>
</section>
        <section id="resultScreen"><div class="content-box"><div id="resEmoji" style="font-size:5rem; margin-bottom: 10px;">ðŸŽ‰</div><h1 id="resTitle" style="color:var(--primary); font-size: 2.5rem;">Selesai!</h1><h3 id="resMsg">Skor Sesi Ini: <span id="resultScore" style="color:var(--accent); font-size: 2rem;">0</span></h3><button id="resultExitBtn" class="btn" style="margin-top: 30px;" onclick="GameEngine.handleResultExit()">Lanjut Peta</button></div></section>
        <section id="mysteryScreen"><div class="content-box"><div style="background:rgba(255,255,255,0.8); padding:5px 20px; border-radius:20px; margin-bottom:10px; font-weight:bold; color:#2c3e50;">ðŸ’Ž RUANG HARTA KARUN</div><div id="mysteryGrid" class="chest-grid"></div><button class="btn" id="btnMysteryFinal" style="background:#bdc3c7; color:#7f8c8d; border:2px solid #fff; box-shadow:0 5px 0 #95a5a6; margin-top:25px; cursor:not-allowed;" onclick="GameEngine.startFinalRainGame()" disabled>ðŸ”’ Final Game (0/6)</button><button class="btn-secondary" style="margin-top:10px; font-size:0.9rem; padding:10px;" onclick="UIManager.showScreen('chapterScreen')">â¬… Keluar</button></div></section>
        <section id="mysteryFinalScreen"><div class="rain-hud"><div class="rain-target-box">â¤ï¸ <span id="rainLife">5</span></div><div class="rain-target-box" style="flex-grow:1; margin:0 10px; justify-content:center;"><div id="rainTargetText" class="target-arab">...</div><div id="rainSpeaker" class="speaker-icon" onclick="GameEngine.playRainAudio()">ðŸ”Š</div><span style="margin-left:10px;">(<span id="rainCount">0</span>/15)</span></div><div class="rain-target-box">â³ <span id="rainTimer">35</span></div></div><div id="rainContainer" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div></section>
        <section id="mysteryResultScreen"><div class="final-result-box"><div id="mrEmoji" style="font-size:5rem;">ðŸ†</div><h2 id="mrTitle" style="color:var(--dark); margin:10px 0;">Alhamdulillah!</h2><div class="score-circle" id="mrTotal">0</div><div class="detail-score"><div class="ds-item"><small>Peti</small><span id="mrScorePeti">0</span></div><div class="ds-item"><small>Final</small><span id="mrScoreFinal">0</span></div></div><p id="mrMsg" style="color:#555; font-style:italic; margin-bottom:20px;">...</p><button class="btn" onclick="GameEngine.finishMysteryFull()">Selesai & Simpan</button></div></section>
    </div>
    <script>
        'use strict';
        const RAW_DATA = {
            ch1: [
                {id:1,label:"Sekolah",arab:"Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©ÙŒ",latin:"madrasah",indo:"sekolah",icon:"ðŸ«",img:"https://cdn.imgpile.com/f/I4HlDWX_xl.png",char:"https://cdn.imgpile.com/f/4mBidN8_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/vUrM6AS_xl.png", riddle:"Aku adalah tempat kamu menuntut ilmu bersama Bapak dan Ibu Guru."},
                {id:2,label:"Masjid",arab:"Ù…ÙŽØ³Ù’Ø¬ÙØ¯ÙŒ",latin:"masjid",indo:"masjid",icon:"ðŸ•Œ",img:"https://cdn.imgpile.com/f/phzfqO3_xl.png",char:"https://cdn.imgpile.com/f/LI9qPWZ_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/1QjMYEd_xl.png", riddle:"Aku adalah rumah Allah, tempat umat Islam melaksanakan shalat berjamaah."},
                {id:3,label:"Perpustakaan",arab:"Ù…ÙŽÙƒÙ’ØªÙŽØ¨ÙŽØ©ÙŒ",latin:"maktabah",indo:"perpustakaan",icon:"ðŸ“š",img:"https://cdn.imgpile.com/f/mBL6YdR_xl.png",char:"https://cdn.imgpile.com/f/hzn8ihb_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/Ad9w8f2_xl.png", riddle:"Di dalamku ada banyak buku yang bisa kamu baca dan pinjam."},
                {id:4,label:"Kebun",arab:"Ø¨ÙØ³Ù’ØªÙŽØ§Ù†ÙŒ",latin:"bustan",indo:"kebun",icon:"ðŸŒ³",img:"https://cdn.imgpile.com/f/8RL3RSu_xl.png",char:"https://cdn.imgpile.com/f/VsQLBGN_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/y4DX9R5_xl.png", riddle:"Aku adalah tempat yang asri, penuh dengan bunga dan pepohonan hijau."},
                {id:5,label:"Rumah",arab:"Ø¨ÙŽÙŠÙ’ØªÙŒ",latin:"bait",indo:"rumah",icon:"ðŸ ",img:"https://cdn.imgpile.com/f/73iRaUz_xl.png",char:"https://cdn.imgpile.com/f/283AqMW_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/MOJIbzS_xl.png", riddle:"Aku adalah tempat tinggalmu, tempat kamu beristirahat bersama keluarga tercinta."},
                {id:6,label:"Hotel",arab:"ÙÙÙ†Ù’Ø¯ÙÙ‚ÙŒ",latin:"funduq",indo:"hotel",icon:"ðŸ¨",img:"https://cdn.imgpile.com/f/fRUN6pP_xl.png",char:"https://cdn.imgpile.com/f/6lLV6Ix_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/KC5PIzx_xl.png", riddle:"Aku adalah tempat tidur sementara saat kamu sedang jalan-jalan jauh bersama Ayah dan Bunda."}
            ],
            ch2: [
                {id:101,label:"Desa",arab:"Ù‚ÙŽØ±Ù’ÙŠÙŽØ©ÙŒ",latin:"qaryah",indo:"desa",icon:"ðŸ¡",img:"https://cdn.imgpile.com/f/hfBtxbM_xl.png",char:"https://cdn.imgpile.com/f/MWCz1yt_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/8h1zvCk_xl.png", riddle:"Aku adalah tempat yang udaranya sejuk, ada banyak pohon, dan biasanya tempat tinggal Kakek dan Nenek."},
                {id:102,label:"Sawah",arab:"Ù…ÙŽØ²Ù’Ø±ÙŽØ¹ÙŽØ©ÙŒ",latin:"mazra'ah",indo:"sawah",icon:"ðŸŒ¾",img:"https://cdn.imgpile.com/f/dMeWK1f_xl.png",char:"https://cdn.imgpile.com/f/bldN66e_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/HRYifUt_xl.png", riddle:"Aku adalah tempat luas berwarna hijau di mana Pak Tani menanam padi."},
                {id:103,label:"Kota",arab:"Ù…ÙŽØ¯ÙÙŠÙ†ÙŽØ©ÙŒ",latin:"madinah",indo:"kota",icon:"ðŸ™ï¸",img:"https://cdn.imgpile.com/f/F6AhuTh_xl.png",char:"https://cdn.imgpile.com/f/57DPolE_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/Gr1FqPy_xl.png", riddle:"Aku adalah tempat yang sangat ramai dengan gedung-gedung tinggi dan jalan raya."},
                {id:104,label:"Toko",arab:"Ø¯ÙÙƒÙŽÙ‘Ø§Ù†ÙŒ",latin:"dukkan",indo:"toko",icon:"ðŸª",img:"https://cdn.imgpile.com/f/KPnL2Sy_xl.png",char:"https://cdn.imgpile.com/f/KieMnYI_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/yPwDGVx_xl.png", riddle:"Aku adalah tempat orang-orang membeli barang kebutuhan sehari-hari."},
                {id:105,label:"Pasar",arab:"Ø³ÙÙˆÙ‚ÙŒ",latin:"suuq",indo:"pasar",icon:"ðŸ›’",img:"https://cdn.imgpile.com/f/kwYchaO_xl.png",char:"https://cdn.imgpile.com/f/4muWR3W_xl.png",side:"pos-right",bg:"https://cdn.imgpile.com/f/JYLnVDH_xl.png", riddle:"Aku adalah tempat yang ramai, biasanya Ibu ke sini untuk beli sayur, buah, atau ikan untuk dimasak."},
                {id:106,label:"Gunung",arab:"Ø¬ÙŽØ¨ÙŽÙ„ÙŒ",latin:"jabal",indo:"gunung",icon:"ðŸ”ï¸",img:"https://cdn.imgpile.com/f/hHgUvka_xl.png",char:"https://cdn.imgpile.com/f/1IOtlOm_xl.png",side:"pos-left",bg:"https://cdn.imgpile.com/f/Jbzt3MY_xl.png", riddle:"Aku adalah ciptaan Allah yang sangat besar dan tinggi sekali ke langit, puncaknya sering tertutup awan."}
            ]
        };
        const MYSTERY_DATA = [
            {id: 201, indo: "Piring", arab: "ØµÙŽØ­Ù’Ù†ÙŒ", latin: "Shahnun", icon: "ðŸ½ï¸", riddle: "Kamu meletakkan nasi dan lauk pauk di atasku sebelum mulai makan."},
            {id: 202, indo: "Gelas", arab: "ÙƒÙÙˆØ¨ÙŒ", latin: "Kuubun", icon: "ðŸ¥¤", riddle: "Kamu menggunakanku untuk mengambil air saat kamu merasa haus."},
            {id: 203, indo: "Nasi", arab: "Ø±ÙØ²Ù‘ÙŒ", latin: "Ruzzun", icon: "ðŸš", riddle: "Aku adalah makanan pokokmu yang berasal dari beras yang sudah dimasak."},
            {id: 204, indo: "Air", arab: "Ù…ÙŽØ§Ø¡ÙŒ", latin: "Maa'un", icon: "ðŸ’§", riddle: "Aku adalah karunia Allah yang bening, kamu meminumku agar badan tidak lemas."},
            {id: 205, indo: "Sendok", arab: "Ù…ÙÙ„Ù’Ø¹ÙŽÙ‚ÙŽØ©ÙŒ", latin: "Mil'aqah", icon: "ðŸ¥„", riddle: "Kamu menggunakanku untuk menyuap makanan agar tanganmu tetap bersih."},
            {id: 206, indo: "Makanan", arab: "Ø·ÙŽØ¹ÙŽØ§Ù…ÙŒ", latin: "Tha'aamun", icon: "ðŸ¥˜", riddle: "Kamu harus memakan aku setiap hari supaya badanmu sehat dan kuat untuk shalat dan belajar."}
        ];
        const ASSET_URLS = ['https://cdn.imgpile.com/f/eFKTTCz_xl.jpg', 'https://cdn.imgpile.com/f/j7g0YzS_xl.png', 'https://cdn.imgpile.com/f/K2herev_xl.png', 'https://cdn.imgpile.com/f/5RCVNjo_xl.jpg', 'https://cdn.imgpile.com/f/mOEfn9w_xl.png', 'https://cdn.imgpile.com/f/9ceOnvB_xl.png', 'https://cdn.imgpile.com/f/O34P3DX_xl.png', 'https://cdn.imgpile.com/f/vnt54eD_xl.png', 'https://cdn.imgpile.com/f/tprX7qe_xl.png', 'https://cdn.imgpile.com/f/SzEQ3nU_xl.png', 'https://cdn.imgpile.com/f/ilRYDcJ_xl.png', 'https://cdn.imgpile.com/f/AAvlgnk_xl.png', 'https://cdn.imgpile.com/f/u0hNA7p_xl.png', 'https://cdn.imgpile.com/f/2l5bkt8_xl.png', 'https://cdn.imgpile.com/f/xCjaBMb_xl.png', 'https://cdn.imgpile.com/f/417MocM_xl.png', 'https://cdn.imgpile.com/f/efTiOXg_xl.png', 'https://cdn.imgpile.com/f/EBRr2pp_xl.png'];
        [...RAW_DATA.ch1, ...RAW_DATA.ch2].forEach(l => { if(l.img) ASSET_URLS.push(l.img); if(l.char) ASSET_URLS.push(l.char); if(l.bg) ASSET_URLS.push(l.bg); });
        const GLOBAL_POOL = [...RAW_DATA.ch1, ...RAW_DATA.ch2, ...MYSTERY_DATA];
        const GAME_CONFIG = { levels: [], activeChapterId: 'ch1', appreciations: ["Baarakallah Fiik!", "Alhamdulillah Mumtaz!", "Maa SyaAllah Tabarakallah!", "Subhanallah, Hebat!"], motivations: ["Qadarullah, belum tepat", "Afwan, coba lagi ya!", "Tetap Semangat Lillah!", "Jangan Menyerah!", "Ayo Coba Lagi!"], audioUrl: 'https://media.vocaroo.com/mp3/1luh7z8Po7JC', introUrl: 'https://media.vocaroo.com/mp3/1bWJ0sORFMT4', victoryUrl: 'https://media.vocaroo.com/mp3/15invLGSWlo0', fanfareUrl: 'https://media.vocaroo.com/mp3/18r6Bprox8UL', MAX_RAW_SCORE: 1120 };
        const StorageService = { get: (k, f) => { try { const d = localStorage.getItem(k); return d ? JSON.parse(d) : f; } catch (e) { return f; } }, set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {} } };
        const SyariahFX = {
            ctx: null, init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if(this.ctx.state === 'suspended') this.ctx.resume(); },
            playOsc: function(type, freq, startT, dur, vol, slideTo = null) { const osc = this.ctx.createOscillator(); const g = this.ctx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, startT); if(slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, startT + dur); g.gain.setValueAtTime(vol, startT); g.gain.exponentialRampToValueAtTime(0.01, startT + dur); osc.connect(g); g.connect(this.ctx.destination); osc.start(startT); osc.stop(startT + dur); },
            playRumble: function() { this.init(); const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 50; const mod = this.ctx.createOscillator(); mod.type = 'square'; mod.frequency.value = 20; const g = this.ctx.createGain(); mod.connect(g.gain); osc.connect(g); g.connect(this.ctx.destination); g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t + 0.5); osc.start(t); mod.start(t); osc.stop(t+0.5); mod.stop(t+0.5); },
            playCreak: function() { this.init(); const t = this.ctx.currentTime; const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 600; const osc = this.ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(140, t); osc.frequency.exponentialRampToValueAtTime(70, t + 1.2); const noise = this.ctx.createBufferSource(); const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 1.2, this.ctx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.1; noise.buffer = buffer; const noiseG = this.ctx.createGain(); noiseG.gain.setValueAtTime(0.1, t); noiseG.gain.linearRampToValueAtTime(0, t + 1.2); const g = this.ctx.createGain(); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t + 1.2); osc.connect(filter); noise.connect(noiseG); noiseG.connect(filter); filter.connect(g); g.connect(this.ctx.destination); osc.start(t); noise.start(t); osc.stop(t + 1.2); noise.stop(t + 1.2); },
            playChime: function() { this.init(); const t = this.ctx.currentTime; [523.25, 659.25, 783.99].forEach((f, i) => this.playOsc('sine', f, t + i*0.05, 1.5, 0.3)); },
            playSlam: function() { this.init(); const t = this.ctx.currentTime; this.playOsc('square', 100, t, 0.2, 0.2, 30); },
            playBuzz: function() { this.init(); const t = this.ctx.currentTime; this.playOsc('sawtooth', 120, t, 0.6, 0.8); this.playOsc('square', 1200, t, 0.6, 0.6); this.playOsc('square', 2400, t, 0.6, 0.4); },
            playWhoosh: function() { this.init(); const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const g = this.ctx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(100, t); osc.frequency.linearRampToValueAtTime(600, t + 0.2); osc.frequency.linearRampToValueAtTime(100, t + 0.6); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t + 0.2); g.gain.linearRampToValueAtTime(0, t + 0.6); osc.connect(g); g.connect(this.ctx.destination); osc.start(t); osc.stop(t + 0.6); },
            playPing: function() { this.init(); const t = this.ctx.currentTime; this.playOsc('sine', 1200, t, 0.15, 0.2); this.playOsc('sine', 2400, t, 0.15, 0.15); },
            playThud: function() { this.init(); const t = this.ctx.currentTime; this.playOsc('square', 5000, t, 0.2, 0.15); },
            playCoinShower: function() { this.init(); const t = this.ctx.currentTime; for(let i=0; i<15; i++) { setTimeout(() => { this.playOsc('sine', 1500 + Math.random()*1500, this.ctx.currentTime, 0.1, 0.2); }, i * 100); } },
            playRewardFanfare: function() { this.init(); const t = this.ctx.currentTime; [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => { this.playOsc('triangle', f, t + i*0.1, 0.4, 0.4); }); this.playOsc('square', 1046.50, t + 0.4, 0.8, 0.3); }
        };
        const AudioManager = {
            ctx: null, sounds: {}, voiceAr: null, voiceId: null,
            init: function() { if (this.ctx) return; try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.preCacheRemoteAudio(GAME_CONFIG.audioUrl, 'correct'); this.preCacheRemoteAudio(GAME_CONFIG.introUrl, 'intro'); this.preCacheRemoteAudio(GAME_CONFIG.victoryUrl, 'victory'); this.loadVoices(); if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = () => this.loadVoices(); } catch(e) { console.error(e); } },
            preCacheRemoteAudio: async function(url, name) { try { const res = await fetch(url); const blob = await res.blob(); this.sounds[name] = new Audio(URL.createObjectURL(blob)); this.sounds[name].preload = 'auto'; } catch(e) { this.sounds[name] = new Audio(url); } },
            loadVoices: function() { const v = speechSynthesis.getVoices(); this.voiceAr = v.find(x => x.lang.includes('ar') && (x.name.includes('Male') || x.name.includes('Maged') || x.name.includes('Tarik'))) || v.find(x => x.lang.includes('ar')); this.voiceId = v.find(x => x.lang.includes('id') && (x.name.includes('Male') || x.name.includes('David'))) || v.find(x => x.lang.includes('id')); },
            ensureContext: function() { if(!this.ctx) this.init(); if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume().catch(console.warn); },
            playIntroWithSync: function() { return new Promise((resolve) => { this.ensureContext(); const intro = this.sounds.intro || new Audio(GAME_CONFIG.introUrl); intro.currentTime = 0; const onPlaying = () => { intro.removeEventListener('playing', onPlaying); resolve(true); }; intro.addEventListener('playing', onPlaying); intro.addEventListener('error', () => resolve(false), { once: true }); const p = intro.play(); if(p !== undefined) p.catch(() => resolve(false)); }); },
            playSparkle: function() { this.ensureContext(); const t = this.ctx.currentTime; for(let i=0; i<15; i++) { const osc = this.ctx.createOscillator(); const gn = this.ctx.createGain(); osc.type = 'sine'; osc.frequency.value = 1000 + Math.random() * 3000; osc.connect(gn); gn.connect(this.ctx.destination); const startTime = t + (Math.random() * 0.4); gn.gain.setValueAtTime(0, startTime); gn.gain.linearRampToValueAtTime(0.08, startTime + 0.05); gn.gain.exponentialRampToValueAtTime(0.001, startTime + 0.6); osc.start(startTime); osc.stop(startTime + 0.6); } },
            playUltimateSparkle: function(dur) { const end = Date.now() + dur; const i = setInterval(() => { if(Date.now() > end) clearInterval(i); this.playSparkle(); if(Math.random() < 0.5) this.playFireworkCrack(); }, 50); },
            playRumble: function() { this.ensureContext(); const t = this.ctx.currentTime; const noise = this.ctx.createBufferSource(); const bufferSize = this.ctx.sampleRate * 1.5; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.8; noise.buffer = buffer; const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 60; const gain = this.ctx.createGain(); gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+1.5); noise.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); noise.start(t); noise.stop(t+1.5); },
            playFireworkCrack: function() { this.ensureContext(); const t = this.ctx.currentTime; const noise = this.ctx.createBufferSource(); const bufferSize = this.ctx.sampleRate * 0.4; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.8; noise.buffer = buffer; const filter = this.ctx.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = 800; const gain = this.ctx.createGain(); noise.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3); noise.start(t); noise.stop(t + 0.3); },
            playSFX: function(type) { this.ensureContext(); if(!this.ctx) return; try { const t = this.ctx.currentTime; if(type === 'correct') { if(this.sounds.correct) { this.sounds.correct.currentTime = 0; this.sounds.correct.play().catch(() => {}); } return; } if(type === 'challengeSuccess') { new Audio(GAME_CONFIG.fanfareUrl).play().catch(()=>{}); return; } if(type === 'fanfare') { const now = this.ctx.currentTime; const playTone = (freq, startTime, duration, st = 'square', v = 0.4) => { const osc = this.ctx.createOscillator(); const gn = this.ctx.createGain(); osc.type = st; osc.frequency.value = freq; gn.gain.setValueAtTime(v, startTime); gn.gain.exponentialRampToValueAtTime(0.01, startTime + duration); osc.connect(gn); gn.connect(this.ctx.destination); osc.start(startTime); osc.stop(startTime + duration + 0.1); }; const runNotes = [523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77]; runNotes.forEach((f, i) => { playTone(f, now + (i * 0.08), 0.1, 'triangle', 0.3); }); const bounceTime = now + (runNotes.length * 0.08); playTone(783.99, bounceTime, 0.15, 'square', 0.3); playTone(783.99, bounceTime + 0.2, 0.15, 'square', 0.3); const finalTime = bounceTime + 0.4; const osc1 = this.ctx.createOscillator(), osc2 = this.ctx.createOscillator(), g1 = this.ctx.createGain(); osc1.type = 'sawtooth'; osc1.frequency.setValueAtTime(1046.50, finalTime); osc2.type = 'sawtooth'; osc2.frequency.setValueAtTime(1318.51, finalTime); g1.gain.setValueAtTime(0, finalTime); g1.gain.linearRampToValueAtTime(0.4, finalTime + 0.05); g1.gain.exponentialRampToValueAtTime(0.001, finalTime + 2.0); osc1.connect(g1); osc2.connect(g1); g1.connect(this.ctx.destination); osc1.start(finalTime); osc2.start(finalTime); osc1.stop(finalTime + 2.5); osc2.stop(finalTime + 2.5); return; } const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); switch(type) { case 'click': o.frequency.setValueAtTime(600, t); g.gain.setValueAtTime(0.3, t); o.start(t); o.stop(t+0.05); break; case 'flip': o.type='triangle'; o.frequency.setValueAtTime(400, t); g.gain.setValueAtTime(0.3, t); o.start(t); o.stop(t+0.1); break; case 'wrong': const ow1 = this.ctx.createOscillator(); ow1.type='sawtooth'; ow1.frequency.value=120; const ow2 = this.ctx.createOscillator(); ow2.type='square'; ow2.frequency.value=1200; const ow3 = this.ctx.createOscillator(); ow3.type='square'; ow3.frequency.value=2400; const gw=this.ctx.createGain(); gw.gain.setValueAtTime(0.8, t); gw.gain.exponentialRampToValueAtTime(0.01, t+0.6); ow1.connect(gw); ow2.connect(gw); ow3.connect(gw); gw.connect(this.ctx.destination); ow1.start(t); ow2.start(t); ow3.start(t); ow1.stop(t+0.6); ow2.stop(t+0.6); ow3.stop(t+0.6); break; case 'mismatch': o.type='triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t+0.3); g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.3); o.start(t); o.stop(t+0.3); break; case 'streak1': [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => { const s1o=this.ctx.createOscillator(), s1g=this.ctx.createGain(); s1o.type='triangle'; s1o.frequency.value=f; s1o.connect(s1g); s1g.connect(this.ctx.destination); s1g.gain.setValueAtTime(0.3, t); s1g.gain.exponentialRampToValueAtTime(0.001, t+0.6); s1o.start(t); s1o.stop(t+0.6); }); break; case 'streak2': [523.25, 659.25, 783.99].forEach((f, i) => { const s2o=this.ctx.createOscillator(), s2g=this.ctx.createGain(); s2o.type='square'; s2o.frequency.value=f; s2o.connect(s2g); s2g.connect(this.ctx.destination); const time=t+(i*0.08); s2g.gain.setValueAtTime(0.2, time); s2g.gain.exponentialRampToValueAtTime(0.001, time+0.3); s2o.start(time); s2o.stop(time+0.3); }); [1046.50, 1318.51, 1567.98].forEach(f => { const s2co=this.ctx.createOscillator(), s2cg=this.ctx.createGain(); s2co.type='sawtooth'; s2co.frequency.value=f; s2co.connect(s2cg); s2cg.connect(this.ctx.destination); s2cg.gain.setValueAtTime(0.2, t+0.24); s2cg.gain.exponentialRampToValueAtTime(0.001, t+0.6); s2co.start(t+0.24); s2co.stop(t+0.6); }); break; case 'streak3': [783.99, 987.77, 783.99, 1046.50].forEach((f, i) => { const s3o=this.ctx.createOscillator(), s3g=this.ctx.createGain(); s3o.type='square'; s3o.frequency.value=f; s3o.connect(s3g); s3g.connect(this.ctx.destination); g.gain.setValueAtTime(0.3, t+i*0.1); s3g.gain.exponentialRampToValueAtTime(0.001, t+i*0.1+0.3); s3o.start(t+i*0.1); s3o.stop(t+i*0.1+0.3); }); break; case 'streak4': [523.25, 659.25, 783.99, 1046.50, 1318.51].forEach((f, i) => { const s4o1=this.ctx.createOscillator(), s4o2=this.ctx.createOscillator(), s4g=this.ctx.createGain(); s4o1.type='sawtooth'; s4o1.frequency.value=f; s4o2.type='sawtooth'; s4o2.frequency.value=f*1.01; s4o1.connect(s4g); s4o2.connect(s4g); s4g.connect(this.ctx.destination); s4g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t+0.1); s4g.gain.exponentialRampToValueAtTime(0.001, t+1.5); s4o1.start(t); s4o2.start(t); s4o1.stop(t+1.5); s4o2.stop(t+1.5); }); this.playSparkle(); break; case 'grandFanfare': if(this.sounds.victory){ this.sounds.victory.currentTime=0; this.sounds.victory.volume=0.7; this.sounds.victory.play().catch(()=>{}); } break; case 'gentle': o.type='sine'; o.frequency.setValueAtTime(440,t); o.frequency.exponentialRampToValueAtTime(880,t+0.5); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+1); o.start(t); o.stop(t+1); break; case 'sparkle': this.playSparkle(); break; case 'firework': this.playFireworkCrack(); break; case 'rumble': this.playRumble(); break; case 'whoosh': this.playWhoosh(); break; } } catch(e){} },
            playTTS: function(text, lang = 'ar-EG') { if(!('speechSynthesis' in window)) return; speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.rate = 0.8; if(lang === 'ar-EG' && this.voiceAr) u.voice = this.voiceAr; if(lang === 'id-ID' && this.voiceId) u.voice = this.voiceId; u.lang = lang; speechSynthesis.speak(u); }
        };
        const UIManager = {
            domCache: {}, $: function(id) { if(!this.domCache[id]) this.domCache[id] = document.getElementById(id); return this.domCache[id]; },
            showScreen: function(id) {
                document.querySelectorAll('section').forEach(s => { s.classList.remove('active-screen'); s.style.display = 'none'; });
                const t = this.$(id);
                if(t) { t.style.display = 'flex'; t.classList.add('active-screen'); window.scrollTo(0, 0); }
                const screensWithHud = ['mapScreen', 'levelScreen', 'game1Screen', 'game2Screen', 'game3Screen', 'gameChallengeL2Screen', 'quizScreen'];
                const isHudRequired = screensWithHud.includes(id);
                const hud = this.$('topHud'), app = this.$('app'), logo = this.$('watermarkLogo');
                if(hud) hud.style.display = isHudRequired ? 'flex' : 'none';
                if(app) isHudRequired ? app.classList.add('with-hud') : app.classList.remove('with-hud');
                if(logo) isHudRequired ? logo.classList.add('lowered') : logo.classList.remove('lowered');
                // Auto-refresh MAP UI whenever mapScreen is shown (Solution 2)
                if (id === 'mapScreen' && window.GameEngine && typeof GameEngine.renderMap === 'function') {
                    // Throttle to avoid duplicate renders when multiple calls happen quickly
                    if (!this._mapRenderScheduled) {
                        this._mapRenderScheduled = true;
                        setTimeout(() => {
                            this._mapRenderScheduled = false;
                            GameEngine.renderMap();
                        }, 0);
                    }
                }
            },
            updateHud: function(prog, scores, streak) { const currentProg = prog[GAME_CONFIG.activeChapterId] || []; const currentScore = scores[GAME_CONFIG.activeChapterId] || { lvl: [], ch: [0, 0], chDone: [0, 0], mem: 0 }; const done = currentProg.filter(Boolean).length; const totalLvls = GAME_CONFIG.levels.length; const pct = totalLvls > 0 ? (done / totalLvls) * 100 : 0; const hb = this.$('hudBar'), ht = this.$('hudText'), hs = this.$('hudScore'), sb = this.$('streakBadge'); if(hb) hb.style.width = pct + '%'; if(ht) ht.innerText = `LEVEL ${done}/${totalLvls}`; const tot = currentScore.lvl.reduce((a, b) => a + b, 0) + (Array.isArray(currentScore.ch) ? currentScore.ch.reduce((a, b) => a + b, 0) : currentScore.ch) + currentScore.mem; if(hs) hs.innerText = tot; if(sb) { sb.innerText = `ðŸ”¥ ${streak}`; sb.style.display = streak > 0 ? 'flex' : 'none'; sb.style.background = streak >= 16 ? 'linear-gradient(135deg, #8e44ad, #ff00ff)' : (streak >= 12 ? 'linear-gradient(135deg, #f1c40f, #e67e22)' : (streak >= 8 ? '#e67e22' : '#e74c3c')); } },
            triggerFlash: function(mode = 0) { const f = this.$('flashOverlay'); f.style.background = mode === 2 ? 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,255,255,0) 70%)' : (mode === 1 ? 'red' : 'white'); f.classList.remove('flash-anim'); void f.offsetWidth; f.classList.add('flash-anim'); if(mode === 3) { document.body.classList.add('glitch-mode'); setTimeout(() => document.body.classList.remove('glitch-mode'), 500); } },
            triggerShake: function() { document.body.style.animation = 'shakeScreen 0.5s'; setTimeout(() => document.body.style.animation = '', 500); },
            showFeedback: function(isCorrect, cb, streakMsg = null, title = null, emoji = null) { const ov = this.$('feedbackOverlay'), c = this.$('fbCard'); if(!ov || !c) return; c.className = 'popup ' + (isCorrect ? 'fb-correct' : 'fb-wrong'); this.$('fbEmoji').innerText = emoji ? emoji : (isCorrect ? "âœ¨" : "âŒ"); this.$('fbTitle').innerText = title ? title : (isCorrect ? "Benar!" : "Belum Tepat"); this.$('fbText').innerText = streakMsg ? streakMsg : (isCorrect ? "Jawaban kamu tepat." : "Coba lagi ya!"); ov.style.display = 'flex'; ov.classList.add('active'); if(this.ft) clearTimeout(this.ft); this.ft = setTimeout(() => { ov.classList.remove('active'); ov.style.display = 'none'; if(cb) cb(); }, 2200); },
            showCustomAlert: function(t, m) { const ov = this.$('feedbackOverlay'), c = this.$('fbCard'); if(!ov || !c) return; c.className = 'popup'; c.style.border = '4px solid var(--secondary)'; this.$('fbEmoji').innerText = "â„¹ï¸"; this.$('fbTitle').innerText = t; this.$('fbText').innerText = m; ov.style.display = 'flex'; ov.classList.add('active'); setTimeout(() => { ov.classList.remove('active'); ov.style.display = 'none'; }, 2000); },
            showChallengeResult: function(s) { const ov = this.$('challengeOverlay'); if(!ov) return; this.$('challengeFinalScore').innerText = s; this.$('challengeAppreciation').innerText = GAME_CONFIG.appreciations[Math.floor(Math.random() * GAME_CONFIG.appreciations.length)]; ov.style.display = 'flex'; setTimeout(()=>ov.classList.add('active'), 10); this.triggerConfetti(); AudioManager.playSFX('challengeSuccess'); },
            closeChallengeOverlay: function() { const ov = this.$('challengeOverlay'); if(ov) { ov.classList.remove('active'); setTimeout(()=>ov.style.display='none',300); } this.showScreen('mapScreen'); },
            triggerConfetti: function(intensity = 1, type = 0) { const f = document.createDocumentFragment(); const count = 50 * intensity; for(let i=0; i<count; i++){ let c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + '%'; c.style.background = type === 1 ? ['#ffd700', '#ffec8b', '#daa520'][Math.floor(Math.random()*3)] : ['red', 'gold', 'blue', '#00b894'][Math.floor(Math.random() * 4)]; if(type === 2) { c.style.background = 'cyan'; c.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)'; c.style.boxShadow = "0 0 10px cyan"; } c.style.animationDuration = (1.5 + Math.random()) + 's'; f.appendChild(c); } document.body.appendChild(f); setTimeout(() => { document.querySelectorAll('.confetti').forEach(el => el.remove()); }, 3000); }
        };
        // === PATCH: Challenge completion flag (score can be 0) + Final Quiz lock requires Challenge 1 & 2 ===
        function _clampArray(arr, len, fill) {
            const out = Array.isArray(arr) ? arr.slice(0, len) : [];
            while (out.length < len) out.push(fill);
            return out;
        }
        function _normalizeChapterScore(sc, lenLevels) {
            const out = (sc && typeof sc === 'object') ? { ...sc } : {};
            out.lvl = _clampArray(out.lvl, lenLevels, 0);
            out.ch  = _clampArray(out.ch, 2, 0);
            // chDone: [doneChallenge1, doneChallenge2] (1/0)
            if (!Array.isArray(out.chDone)) {
                // Backward-compatible: old saves didn't have this; infer minimal from score>0.
                out.chDone = [ (out.ch[0] || 0) > 0 ? 1 : 0, (out.ch[1] || 0) > 0 ? 1 : 0 ];
            } else {
                out.chDone = _clampArray(out.chDone, 2, 0).map(v => v ? 1 : 0);
            }
            out.mem = Number.isFinite(out.mem) ? out.mem : 0;
            return out;
        }
        function _normalizeAllScores(scores, lenLevels) {
            const s = (scores && typeof scores === 'object') ? scores : {};
            return {
                ch1: _normalizeChapterScore(s.ch1, lenLevels),
                ch2: _normalizeChapterScore(s.ch2, lenLevels)
            };
        }
        const GameEngine = {
            state: { progress: { ch1: new Array(6).fill(0), ch2: new Array(6).fill(0) }, scores: { ch1: { lvl: new Array(6).fill(0), ch: [0, 0], chDone: [0, 0], mem: 0 }, ch2: { lvl: new Array(6).fill(0), ch: [0, 0], chDone: [0, 0], mem: 0 } }, history: [], currentLevelIdx: 0, tempScore: 0, challengeQueue: [], challengeIdx: 0, challengeMode: 1, memory: { matches: 0, lock: false, first: null, second: null, audioOn: true }, streak: 0, hasMistake: false, isBusy: false, mystery: { unlocked: [], failedIds: [] }, finalGame: { active: false, level: 0, life: 5, timer: 35, correctCount: 0, totalCorrect: 0, mistakeCount: 0, streak: 0, interval: null, spawnInterval: null, items: [] }, puzzleQueue: [], puzzleIdx: 0, puzzleCorrect: 0, isFromPuzzle: false, activeTab: 'adventure' },
            ChapterReport: {
                _key: 'chapterScore_v1',
                _load: function() {
                    let raw = null;
                    try { raw = JSON.parse(localStorage.getItem(this._key) || 'null'); } catch(e) { raw = null; }
                    if(!raw || typeof raw !== 'object') raw = {};
                    return raw;
                },
                _save: function(store) {
                    try { localStorage.setItem(this._key, JSON.stringify(store || {})); } catch(e) {}
                },
                _ensureChapter: function(store, chapterId) {
                    const ch = chapterId || 'ch1';
                    if(!store[ch] || typeof store[ch] !== 'object') store[ch] = {};
                    const o = store[ch];
                    if(!o.learn) o.learn = { last: 0, best: 0, answered: 0, correct: 0, total: 12, updatedAt: null };
                    if(!o.arrange) o.arrange = { last: 0, best: 0, updatedAt: null };
                    if(!o.final) o.final = { last: 0, best: 0, updatedAt: null };
                    return o;
                },
                _clamp100: function(n) {
                    n = Math.round(Number(n || 0));
                    if(n < 0) n = 0;
                    if(n > 100) n = 100;
                    return n;
                },
                computeFinal: function(learnScore, arrangeScore) {
                    // Bobot B: 40% belajar + 60% susun
                    const l = this._clamp100(learnScore);
                    const a = this._clamp100(arrangeScore);
                    return this._clamp100((0.4 * l) + (0.6 * a));
                },
                get: function(chapterId) {
                    const store = this._load();
                    const rec = this._ensureChapter(store, chapterId);
                    return JSON.parse(JSON.stringify(rec));
                },
                recordLearn: function(chapterId, learnScore, answered, correct, total) {
                    const store = this._load();
                    const rec = this._ensureChapter(store, chapterId);
                    const score = this._clamp100(learnScore);
                    rec.learn.last = score;
                    rec.learn.best = Math.max(this._clamp100(rec.learn.best), score);
                    rec.learn.answered = Math.max(0, Number(answered || 0));
                    rec.learn.correct = Math.max(0, Number(correct || 0));
                    rec.learn.total = Math.max(1, Number(total || 12));
                    rec.learn.updatedAt = new Date().toISOString();
                    this._save(store);
                    return score;
                },
                recordArrangeAndFinal: function(chapterId, arrangeScore, learnScoreMaybe) {
                    const store = this._load();
                    const rec = this._ensureChapter(store, chapterId);
                    const a = this._clamp100(arrangeScore);
                    const l = (typeof learnScoreMaybe === 'number') ? this._clamp100(learnScoreMaybe) : this._clamp100(rec.learn.last || 0);
                    const f = this.computeFinal(l, a);

                    rec.arrange.last = a;
                    rec.arrange.best = Math.max(this._clamp100(rec.arrange.best), a);
                    rec.arrange.updatedAt = new Date().toISOString();

                    rec.final.last = f;
                    rec.final.best = Math.max(this._clamp100(rec.final.best), f);
                    rec.final.updatedAt = new Date().toISOString();

                    if(!Array.isArray(store.history)) store.history = [];
                    store.history.push({ chapter: chapterId, learn: l, arrange: a, final: f, at: Date.now() });
                    if(store.history.length > 60) store.history = store.history.slice(-60);

                    this._save(store);
                    return { learn: l, arrange: a, final: f, bestFinal: rec.final.best };
                }
            },

            loadData: function() {
                const len = (GAME_CONFIG && GAME_CONFIG.levels && GAME_CONFIG.levels.length) ? GAME_CONFIG.levels.length : 6;
                let sp = StorageService.get('prog_v2', { ch1: new Array(len).fill(0), ch2: new Array(len).fill(0) });
                if(!sp || typeof sp !== 'object') sp = { ch1: new Array(len).fill(0), ch2: new Array(len).fill(0) };
                if(!Array.isArray(sp.ch1)) sp.ch1 = new Array(len).fill(0);
                if(!Array.isArray(sp.ch2)) sp.ch2 = new Array(len).fill(0);
                sp.ch1 = _clampArray(sp.ch1, len, 0);
                sp.ch2 = _clampArray(sp.ch2, len, 0);
                const rawScores = StorageService.get('scr_v2', null);
                const normalized = _normalizeAllScores(rawScores || this.state.scores, len);
                this.state.progress = sp;
                this.state.scores = normalized;
                this.state.history = StorageService.get('hist_v2', []);
                this.state.mystery = StorageService.get('mystery_v1', { unlocked: [], failedIds: [] });
                this.state.mystery.failedIds = [];
            },
            saveData: function() { StorageService.set('prog_v2', this.state.progress); StorageService.set('scr_v2', this.state.scores); StorageService.set('hist_v2', this.state.history); StorageService.set('mystery_v1', this.state.mystery); },
            preloadAssets: function() { const preloader = document.getElementById('assetPreloader'); ASSET_URLS.forEach(url => { const img = new Image(); img.src = url; preloader.appendChild(img); }); const audioPreload = new Audio(GAME_CONFIG.victoryUrl); audioPreload.preload = 'auto'; audioPreload.load(); },
            startIntroSequence: function() { AudioManager.playSFX('click'); const v = document.getElementById('introVideo'); const b = document.getElementById('startBtnImg'); if(v){ b.style.display = 'none'; v.style.display = 'block'; v.play().catch(e => { v.style.display = 'none'; UIManager.showScreen('welcomeScreen'); }); v.onended = () => { v.style.display = 'none'; UIManager.showScreen('welcomeScreen'); }; } else { UIManager.showScreen('welcomeScreen'); } },
            init: function() { AudioManager.playSFX('click'); AudioManager.playIntroWithSync().then(() => { UIManager.showScreen('chapterScreen'); }); },
            selectChapter: function(chapId) { AudioManager.playSFX('click'); GAME_CONFIG.activeChapterId = chapId; GAME_CONFIG.levels = RAW_DATA[chapId]; this.state.streak = 0; this.state.hasMistake = false; const mapBg = (chapId === 'ch1') ? 'https://cdn.imgpile.com/f/mOEfn9w_xl.png' : 'https://cdn.imgpile.com/f/9ceOnvB_xl.png'; const mapEl = UIManager.$('mapScreen'); if(mapEl) mapEl.style.backgroundImage = `url('${mapBg}')`; UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); UIManager.showScreen('mapScreen'); },
            boot: function() { this.loadData(); this.preloadAssets(); },
            resetLevelState: function() { this.state.tempScore = 0; this.state.isBusy = false; },
            isFinalQuizUnlocked: function(ch) {
                const cid = ch || GAME_CONFIG.activeChapterId;
                const prog = this.state.progress[cid] || [];
                const sc = this.state.scores[cid] || { chDone: [0,0] };
                const adventureDone = Array.isArray(prog) && prog.length > 0 && prog.every(Boolean);
                const doneArr = Array.isArray(sc.chDone) ? sc.chDone : [0,0];
                const challengeDone = !!doneArr[0] && !!doneArr[1];
                return adventureDone && challengeDone;
            },
            renderMap: function() { const g = UIManager.$('mapGrid'); if(!g) return; g.innerHTML = ''; const currentProg = this.state.progress[GAME_CONFIG.activeChapterId] || new Array(6).fill(0); GAME_CONFIG.levels.forEach((l, i) => { const d = document.createElement('div'), done = currentProg[i]; d.className = `location-card ${done ? 'completed' : ''}`; d.onclick = () => this.startLevel(i); const iconHTML = l.img ? `<img src="${l.img}">` : `<div style="font-size:3rem;">${l.icon}</div>`; d.innerHTML = iconHTML + `<div style="font-weight:bold;margin-top:5px;font-size:0.9rem;">${l.label}</div>` + (done ? '<small style="color:green;font-weight:bold;">Selesai</small>' : ''); g.appendChild(d); }); const b = UIManager.$('btnQuiz'); if(b) { if(this.isFinalQuizUnlocked(GAME_CONFIG.activeChapterId)){ b.style.background = 'linear-gradient(to bottom, #f1c40f, #f39c12)'; b.style.boxShadow = '0 5px 0 #d35400'; b.innerText = "ðŸ† Final Quiz (Buka!)"; } else { b.style.background = 'linear-gradient(to bottom, #bdc3c7, #95a5a6)'; b.style.boxShadow = '0 5px 0 #7f8c8d'; b.innerText = "ðŸ”’ Final Quiz"; } } },
            startLevel: function(idx) { AudioManager.playSFX('click'); this.resetLevelState(); this.state.currentLevelIdx = idx; const d = GAME_CONFIG.levels[idx]; const bg = d.bg ? `url('${d.bg}')` : `url('https://cdn.imgpile.com/f/5RCVNjo_xl.jpg')`; ['levelScreen', 'game1Screen', 'game2Screen', 'resultScreen'].forEach(id => { const el = UIManager.$(id); if(el) el.style.backgroundImage = bg; }); UIManager.$('levelTitle').innerText = d.label; UIManager.$('levelImg').innerHTML = d.img ? `<img src="${d.img}">` : `<div style="font-size:4rem;">${d.icon}</div>`; UIManager.$('levelArab').innerText = d.arab; UIManager.$('levelLatin').innerText = d.latin; UIManager.$('levelIndo').innerText = d.indo; const c = UIManager.$('levelChar'), w = UIManager.$('levelWrapper'); if(c && w){ if(d.char) { c.src = d.char; c.style.display = 'block'; } else { c.style.display = 'none'; } w.className = 'level-container ' + d.side; c.style.animation = 'none'; c.offsetHeight; if(window.innerWidth > 850) c.style.animation = (d.side === 'pos-left') ? 'slideInLeft 0.8s cubic-bezier(0.25,1,0.5,1) forwards' : 'slideInRight 0.8s cubic-bezier(0.25,1,0.5,1) forwards'; else c.style.animation = 'slideUp 0.8s cubic-bezier(0.25,1,0.5,1) forwards'; } UIManager.showScreen('levelScreen'); },
            playLevelAudio: function(isIndo) { const d = GAME_CONFIG.levels[this.state.currentLevelIdx]; if(d) AudioManager.playTTS(isIndo ? d.indo : d.arab, isIndo ? 'id-ID' : 'ar-EG'); },
            playLevelAudioFull: function() { const d = GAME_CONFIG.levels[this.state.currentLevelIdx]; if(d) { AudioManager.playTTS(d.arab, 'ar-EG'); setTimeout(() => AudioManager.playTTS(d.indo, 'id-ID'), 1500); } },
            playMysteryAudioFull: function(ar, id) { AudioManager.playTTS(ar, 'ar-EG'); setTimeout(() => AudioManager.playTTS(id, 'id-ID'), 1500); },
            playCurrentQuestionAudio: function() { const d = GAME_CONFIG.levels[this.state.currentLevelIdx]; if(UIManager.$('game1Screen').style.display === 'flex') { AudioManager.playTTS(d.indo, 'id-ID'); } else if(UIManager.$('game2Screen').style.display === 'flex') { AudioManager.playTTS(d.arab, 'ar-EG'); } },
            startGame1: function() { const d = GAME_CONFIG.levels[this.state.currentLevelIdx]; UIManager.$('g1Icon').innerHTML = d.img ? `<img src="${d.img}">` : `<div style="font-size:4rem;">${d.icon}</div>`; UIManager.$('g1Label').innerText = d.label + " ðŸ”Š"; let o = [{ t: d.arab, c: true }]; GAME_CONFIG.levels.filter((_, x) => x !== this.state.currentLevelIdx).slice(0, 2).forEach(x => o.push({ t: x.arab, c: false })); o.sort(() => Math.random() - 0.5); const g = UIManager.$('g1Options'); g.innerHTML = ''; o.forEach(x => { const row = document.createElement('div'); row.className = 'option-wrapper'; const btnSound = document.createElement('button'); btnSound.className = 'btn-sound-opt'; btnSound.innerHTML = 'ðŸ”Š'; btnSound.onclick = (e) => { e.stopPropagation(); AudioManager.playTTS(x.t, 'ar-EG'); }; const btnAns = document.createElement('button'); btnAns.className = "btn-option arabic btn-opt-main"; btnAns.innerText = x.t; btnAns.onclick = () => this.checkAnswer(x.c, () => this.startGame2()); row.appendChild(btnSound); row.appendChild(btnAns); g.appendChild(row); }); UIManager.showScreen('game1Screen'); },
            startGame2: function() { const idx = this.state.currentLevelIdx; const d = GAME_CONFIG.levels[idx]; UIManager.$('g2Arab').innerText = "ðŸ”Š " + d.arab; let o = [{ t: d.indo, c: true }]; GAME_CONFIG.levels.filter((_, x) => x !== idx).slice(0, 2).forEach(x => o.push({ t: x.indo, c: false })); o.sort(() => Math.random() - 0.5); const g = UIManager.$('g2Options'); g.innerHTML = ''; o.forEach(x => { const row = document.createElement('div'); row.className = 'option-wrapper'; const btnSound = document.createElement('button'); btnSound.className = 'btn-sound-opt'; btnSound.innerHTML = 'ðŸ”Š'; btnSound.onclick = (e) => { e.stopPropagation(); AudioManager.playTTS(x.t, 'id-ID'); }; const btnAns = document.createElement('button'); btnAns.className = "btn-option btn-opt-main"; btnAns.innerText = x.t; btnAns.onclick = () => this.checkAnswer(x.c, () => this.finishLevel()); row.appendChild(btnSound); row.appendChild(btnAns); g.appendChild(row); }); UIManager.showScreen('game2Screen'); },
            getStreakFeedback: function(s) {
                if (s % 4 !== 0) return { msg: "Ahsanta! Jawabanmu Benar.", sfx: 'correct', intensity: 1, type: 0, emoji: "âœ¨" };
                if (s >= 16) return { msg: `Allahu Akbar! Luar Biasa Sempurna! (${s}x Berturut-turut)`, sfx: 'streak4', intensity: 5, type: 2, emoji: "ðŸ‘‘" };
                if (s >= 12) return { msg: `MasyaAllah Tabarakallah! Cerdas Sekali! (${s}x Berturut-turut)`, sfx: 'streak3', intensity: 4, type: 1, emoji: "ðŸ†" };
                if (s >= 8) return { msg: `Alhamdulillah! Hafalanmu Kuat! (${s}x Berturut-turut)`, sfx: 'streak2', intensity: 3, type: 0, emoji: "ðŸ’Ž" };
                return { msg: `Barakallahu Fiik! Terus Semangat! (${s}x Berturut-turut)`, sfx: 'streak1', intensity: 1.5, type: 0, emoji: "ðŸ”¥" };
            },
            checkAnswer: function(c, n) { if(this.state.isBusy) return; this.state.isBusy = true; if(c) { this.state.streak++; this.state.tempScore += 50; const fb = this.getStreakFeedback(this.state.streak); AudioManager.playSFX(fb.sfx); if(fb.intensity >= 1.5) UIManager.triggerFlash(0); if(fb.intensity >= 3) AudioManager.playSparkle(); if(fb.intensity === 4) { UIManager.triggerFlash(2); UIManager.triggerShake(); Fireworks.start(1, 1); setTimeout(()=>Fireworks.stop(), 2500); } if(fb.intensity === 5) { UIManager.triggerFlash(3); UIManager.triggerShake(); UIManager.triggerConfetti(3, 2); Fireworks.start(2, 2); setTimeout(()=>Fireworks.stop(), 3500); } UIManager.showFeedback(true, () => { this.state.isBusy = false; if(n) n(); }, fb.msg, "Benar!", fb.emoji); } else { this.state.streak = 0; this.state.hasMistake = true; AudioManager.playSFX('wrong'); UIManager.showFeedback(false, () => { this.state.isBusy = false; if(n) n(); }, "Qadarullah, belum tepat. Ayo coba lagi!", "Belum Tepat", "âŒ"); } UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); },
            handleResultExit: function() { if(this.state.isFromPuzzle) { this.state.isFromPuzzle = false; UIManager.showScreen('chapterScreen'); Fireworks.stop(); } else { UIManager.showScreen('mapScreen'); } },
            finishLevel: function() { try { const idx = this.state.currentLevelIdx; const ch = GAME_CONFIG.activeChapterId; this.state.isFromPuzzle = false; if (!this.state.progress[ch]) this.state.progress[ch] = new Array(6).fill(0); this.state.progress[ch][idx] = 1; if (!this.state.scores[ch]) this.state.scores[ch] = { lvl: new Array(6).fill(0), ch: [0,0], chDone: [0,0], mem: 0 }; if (!this.state.scores[ch].lvl) this.state.scores[ch].lvl = new Array(6).fill(0); if(!this.state.scores[ch].chDone || !Array.isArray(this.state.scores[ch].chDone)) this.state.scores[ch].chDone = [0,0]; if(this.state.tempScore > this.state.scores[ch].lvl[idx]) this.state.scores[ch].lvl[idx] = this.state.tempScore; this.saveData(); UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); UIManager.$('resEmoji').innerText = "ðŸŽ‰"; UIManager.$('resTitle').innerText = "Selesai!"; UIManager.$('resMsg').innerHTML = `Skor Sesi Ini: <span id="resultScore" style="color:var(--accent); font-size: 2rem;">${this.state.tempScore}</span>`; UIManager.$('resultExitBtn').innerText = "Lanjut Peta"; UIManager.showScreen('resultScreen'); if(this.state.tempScore >= 100) UIManager.triggerConfetti(); } catch(e) { console.error("Save error fixed:", e); UIManager.showScreen('mapScreen'); } },
            startChallengeMenu: function() { const ch = GAME_CONFIG.activeChapterId; // normalize in case of old save
                const len = (GAME_CONFIG && GAME_CONFIG.levels && GAME_CONFIG.levels.length) ? GAME_CONFIG.levels.length : 6;
                this.state.scores = _normalizeAllScores(this.state.scores, len);
                const done = (this.state.scores[ch] && Array.isArray(this.state.scores[ch].chDone)) ? this.state.scores[ch].chDone : [0,0];
                const c1 = UIManager.$('lvlCh1'); const c2 = UIManager.$('lvlCh2');
                if(done[0]) c1.classList.add('done'); else c1.classList.remove('done');
                if(done[1]) c2.classList.add('done'); else c2.classList.remove('done');
                UIManager.showScreen('challengeSelectScreen'); },
            startChallengeLevel: function(l) { this.resetLevelState(); this.state.challengeMode = l; this.state.challengeQueue = GAME_CONFIG.levels.slice().sort(() => Math.random() - 0.5); this.state.challengeIdx = 0; this.state.scores[GAME_CONFIG.activeChapterId].ch[l - 1] = 0; this.nextChallenge(); },
            nextChallenge: function() { if(this.state.challengeIdx >= this.state.challengeQueue.length){ const ch = GAME_CONFIG.activeChapterId; const len = (GAME_CONFIG && GAME_CONFIG.levels && GAME_CONFIG.levels.length) ? GAME_CONFIG.levels.length : 6; this.state.scores = _normalizeAllScores(this.state.scores, len); if(!this.state.scores[ch].chDone) this.state.scores[ch].chDone = [0,0]; this.state.scores[ch].chDone[this.state.challengeMode - 1] = 1; this.saveData(); UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); UIManager.showChallengeResult(this.state.scores[ch].ch[this.state.challengeMode - 1]); this.state.isBusy = false; return; } const d = this.state.challengeQueue[this.state.challengeIdx]; if(this.state.challengeMode === 1) { AudioManager.playTTS(d.arab, 'ar-EG'); let o = [{ d: d, c: true }]; GAME_CONFIG.levels.filter(l => l.id !== d.id).slice(0, 2).forEach(x => o.push({ d: x, c: false })); o.sort(() => Math.random() - 0.5); const g = UIManager.$('g3Options'); g.innerHTML = ''; o.forEach(x => { const c = document.createElement('div'); c.className = "btn-img"; c.innerHTML = x.d.img ? `<img src="${x.d.img}">` : `<span style="font-size:3rem;">${x.d.icon}</span>`; c.onclick = () => this.checkChallenge(c, x.c); g.appendChild(c); }); UIManager.showScreen('game3Screen'); } else { AudioManager.playTTS(d.indo, 'id-ID'); UIManager.$('cl2Icon').innerHTML = d.img ? `<img src="${d.img}">` : `<div style="font-size:4rem;">${d.icon}</div>`; let o = [{ t: d.arab, c: true }]; GLOBAL_POOL.filter(l => l.id !== d.id).sort(() => Math.random() - 0.5).slice(0, 2).forEach(x => o.push({ t: x.arab, c: false })); o.sort(() => Math.random() - 0.5); const g = UIManager.$('cl2Options'); g.innerHTML = ''; o.forEach(x => { const r = document.createElement('div'); r.className = "option-row"; const bp = document.createElement('button'); bp.className = "btn-sound"; bp.innerHTML = "ðŸ”Š"; bp.onclick = (e) => { e.stopPropagation(); AudioManager.playTTS(x.t, 'ar-EG'); }; const ba = document.createElement('button'); ba.className = "btn-option arabic btn-answer-split"; ba.innerText = x.t; ba.onclick = () => this.checkChallenge(ba, x.c); r.appendChild(bp); r.appendChild(ba); g.appendChild(r); }); UIManager.showScreen('gameChallengeL2Screen'); } },
            checkChallenge: function(el, c) { if(this.state.isBusy || el.classList.contains('processed')) return; this.state.isBusy = true; el.classList.add('processed'); const nextStep = () => { setTimeout(() => { this.state.isBusy = false; this.state.challengeIdx++; this.nextChallenge(); }, 1800); }; if(c){ this.state.streak++; if(el.tagName === 'BUTTON') el.style.background = '#d5f5e3'; else el.classList.add('correct-anim'); const fb = this.getStreakFeedback(this.state.streak); AudioManager.playSFX(fb.sfx); if(fb.intensity >= 1.5) UIManager.triggerFlash(0); if(fb.intensity >= 3) AudioManager.playSparkle(); if(fb.intensity === 4) { UIManager.triggerFlash(2); UIManager.triggerShake(); Fireworks.start(1, 1); setTimeout(()=>Fireworks.stop(), 2500); } if(fb.intensity === 5) { UIManager.triggerFlash(3); UIManager.triggerShake(); UIManager.triggerConfetti(3, 2); Fireworks.start(2, 2); setTimeout(()=>Fireworks.stop(), 3500); } UIManager.showFeedback(true, null, fb.msg, "Benar!", fb.emoji); this.state.scores[GAME_CONFIG.activeChapterId].ch[this.state.challengeMode - 1] += 20; } else { this.state.streak = 0; this.state.hasMistake = true; if(el.tagName === 'BUTTON') el.style.background = '#fadbd8'; else el.classList.add('wrong-anim'); AudioManager.playSFX('wrong'); UIManager.showFeedback(false, null, "Salah! Streak reset.", "Salah", "âŒ"); } this.saveData(); UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); nextStep(); },
            playChallengeAudio: function() { const d = this.state.challengeQueue[this.state.challengeIdx]; AudioManager.playTTS(this.state.challengeMode === 1 ? d.arab : d.indo, this.state.challengeMode === 1 ? 'ar-EG' : 'id-ID'); },
            checkQuizAccess: function() { const ch = GAME_CONFIG.activeChapterId; if(this.isFinalQuizUnlocked(ch)) { this.startMemory(); return; } const prog = this.state.progress[ch] || []; const sc = this.state.scores[ch] || { chDone: [0,0] }; const done = Array.isArray(sc.chDone) ? sc.chDone : [0,0]; const needAdventure = !(Array.isArray(prog) && prog.length > 0 && prog.every(Boolean)); const needCh1 = !done[0]; const needCh2 = !done[1]; const todo = [ needAdventure ? 'â€¢ Selesaikan semua level petualangan (6/6)' : null, needCh1 ? 'â€¢ Selesaikan Tantangan Level 1' : null, needCh2 ? 'â€¢ Selesaikan Tantangan Level 2' : null ].filter(Boolean).join('\n'); UIManager.showCustomAlert('Final Quiz Terkunci', todo || 'Syarat belum terpenuhi.'); },
            startMemory: function() { this.resetLevelState(); const ch = GAME_CONFIG.activeChapterId; this.state.scores[ch].mem = 0; this.state.memory = { matches: 0, lock: false, first: null, second: null, audioOn: true }; let c = []; GAME_CONFIG.levels.forEach(l => { c.push({ val: l.indo, t: 'txt', id: l.id }); c.push({ val: l.arab, t: 'ar', id: l.id }); }); c.sort(() => Math.random() - 0.5); const g = UIManager.$('memoryBoard'); g.innerHTML = ''; c.forEach(x => { const d = document.createElement('div'); d.className = "memory-card"; d.dataset.id = x.id; d.innerHTML = `<div class="face front">?</div><div class="face back ${x.t}">${x.val}</div>`; d.onclick = () => this.flipCard(d, x.val, x.t); g.appendChild(d); }); UIManager.showScreen('quizScreen'); },
            toggleMemAudio: function() { this.state.memory.audioOn = !this.state.memory.audioOn; const btn = document.getElementById('memToggle'); const txt = document.getElementById('memToggleText'); if(this.state.memory.audioOn) { btn.classList.add('active'); txt.innerText = "Suara Kartu: ON"; } else { btn.classList.remove('active'); txt.innerText = "Suara Kartu: OFF"; } },
            flipCard: function(c, val, type) { let m = this.state.memory; if(m.lock || c === m.first || c.classList.contains('matched')) return; AudioManager.playSFX('flip'); if(m.audioOn) { if(type === 'ar') AudioManager.playTTS(val, 'ar-EG'); else AudioManager.playTTS(val, 'id-ID'); } c.classList.add('flipped'); if(!m.first){ m.first = c; return; } m.second = c; this.checkMatch(); },
            checkMatch: function() { let m = this.state.memory; m.lock = true; const match = m.first.dataset.id === m.second.dataset.id; const ch = GAME_CONFIG.activeChapterId; if(match) { AudioManager.playSFX('correct'); m.first.classList.add('matched'); m.second.classList.add('matched'); this.state.scores[ch].mem += 20; m.matches++; this.saveData(); UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); this.resetBoard(); if(m.matches === GAME_CONFIG.levels.length) this.showFinale(); } else { AudioManager.playSFX('mismatch'); setTimeout(() => { if(m.first) m.first.classList.remove('flipped'); if(m.second) m.second.classList.remove('flipped'); this.resetBoard(); }, 1000); } },
            resetBoard: function() { this.state.memory.lock = false; this.state.memory.first = null; this.state.memory.second = null; },
            showFinale: function() { const sc = this.state.scores[GAME_CONFIG.activeChapterId]; const rt = sc.lvl.reduce((a, b) => a + b, 0) + sc.ch.reduce((a, b) => a + b, 0) + sc.mem; const maxScore = (GAME_CONFIG.levels.length * 100) + (2 * GAME_CONFIG.levels.length * 20) + (GAME_CONFIG.levels.length * 20); const fs = Math.round((rt / maxScore) * 100); if(fs === 100 && !this.state.hasMistake) { const ult = UIManager.$('ultimateRewardScreen'); ult.classList.add('active'); AudioManager.playSFX('whoosh'); const strobe = ult.querySelector('.ult-strobe'); if(strobe) strobe.classList.add('running'); setTimeout(() => { AudioManager.playSFX('grandFanfare'); AudioManager.playSFX('fanfare'); AudioManager.playSFX('impact'); AudioManager.playSFX('rumble'); UIManager.triggerShake(); AudioManager.playUltimateSparkle(3000); Fireworks.start(2, 3); setTimeout(() => { Fireworks.stop(true); }, 3000); }, 500); } else { UIManager.$('finalScore').innerText = fs; const c = UIManager.$('grandFinale'); const t = UIManager.$('finalTitle'); const e = UIManager.$('finalEmoji'); const tx = UIManager.$('finalAppreciation'); const isGoodScore = fs >= 80; c.style.backgroundImage = isGoodScore ? "url('https://cdn.imgpile.com/f/ilRYDcJ_xl.png')" : "url('https://cdn.imgpile.com/f/AAvlgnk_xl.png')"; e.style.opacity = 1; UIManager.$('finalScore').parentNode.style.opacity = 1; if(isGoodScore) { t.innerText = "MUMTAZ!"; t.style.color = "#2d3436"; tx.innerText = GAME_CONFIG.appreciations[Math.floor(Math.random() * GAME_CONFIG.appreciations.length)]; AudioManager.playSFX('grandFanfare'); AudioManager.playSFX('fanfare'); Fireworks.start(3, 2); } else { t.innerText = "JANGAN MENYERAH!"; t.style.color = "#d35400"; e.innerText = "ðŸ’ª"; tx.innerText = GAME_CONFIG.motivations[Math.floor(Math.random() * GAME_CONFIG.motivations.length)]; AudioManager.playSFX('gentle'); Fireworks.stop(); } c.classList.add('active'); c.style.display = 'flex'; } this.saveData(); UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak); },
            finishSession: function() { const ch = GAME_CONFIG.activeChapterId; const len = GAME_CONFIG.levels.length; const sc = this.state.scores[ch]; const rt = sc.lvl.reduce((a, b) => a + b, 0) + sc.ch.reduce((a, b) => a + b, 0) + sc.mem; const maxScore = (len * 100) + (2 * len * 20) + (len * 20); const finalGrade = Math.round((rt / maxScore) * 100); this.state.history.unshift({ type: 'adventure', ch: ch, score: finalGrade, date: new Date().toLocaleDateString('id-ID'), time: new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) }); this.state.progress[ch] = new Array(len).fill(0); this.state.scores[ch] = { lvl: new Array(len).fill(0), ch: [0, 0], chDone: [0, 0], mem: 0 }; this.state.streak = 0; this.state.hasMistake = false; this.saveData(); UIManager.$('grandFinale').classList.remove('active'); setTimeout(() => UIManager.$('grandFinale').style.display='none', 300); UIManager.$('ultimateRewardScreen').classList.remove('active'); const strobe = document.querySelector('.ult-strobe'); if(strobe) strobe.classList.remove('running'); Fireworks.stop(); UIManager.updateHud(this.state.progress, this.state.scores, 0); UIManager.showScreen('chapterScreen'); },
                        showReportMenu: function() {
                // Use default background on the report menu
                try { const sb = UIManager.$('scoreboardScreen'); if(sb) sb.classList.remove('report-mode-bg'); } catch(e) {}

                try { AudioManager.playSFX('click'); } catch(e) {}
                UIManager.showScreen('scoreboardScreen');
                const menu = UIManager.$('reportMenu');
                const page = UIManager.$('reportPage');
                if(menu) menu.style.display = 'flex';
                if(page) page.style.display = 'none';
            },

            backToReportMenu: function() {
                // Use default background on the report menu
                try { const sb = UIManager.$('scoreboardScreen'); if(sb) sb.classList.remove('report-mode-bg'); } catch(e) {}

                try { AudioManager.playSFX('click'); } catch(e) {}
                // reset internal report UI so next time user opens Raport it starts from the menu
                const menu = UIManager.$('reportMenu');
                const page = UIManager.$('reportPage');
                if(page) page.style.display = 'none';
                if(menu) menu.style.display = 'flex';

                // "Kembali" goes back to the Raport menu (4 tombol raport)
                UIManager.showScreen('scoreboardScreen');
            },

            openReportPage: function(mode) {
                try { AudioManager.playSFX('click'); } catch(e) {}
                UIManager.showScreen('scoreboardScreen');
                const menu = UIManager.$('reportMenu');
                const page = UIManager.$('reportPage');
                const title = UIManager.$('reportTitle');
                if(menu) menu.style.display = 'none';
                if(page) page.style.display = 'block';
                // Enable full-screen raport background only on report pages (after UI is visible)
                try { const sb = UIManager.$('scoreboardScreen'); if(sb) sb.classList.add('report-mode-bg'); } catch(e) {}

                const m = (mode || 'adventure');
                if(title) {
                    title.textContent =
                        (m === 'adventure') ? 'Petualangan' :
                        (m === 'mystery')   ? 'Buka Peti' :
                        (m === 'puzzle')    ? 'Teka Teki' :
                        (m === 'arrange')   ? 'Susun Huruf' :
                        'Raport';
                }

                if(m === 'arrange') {
                    this.showArrangeReport();
                } else {
                    this.showScoreboard(m);
                }
            },

            showArrangeReport: function() {
                const listEl = UIManager.$('scoreList');
                const totContainer = UIManager.$('sbTotalContainer');
                if(totContainer) totContainer.style.display = 'none';

                const store = (this.ChapterReport && this.ChapterReport._load) ? this.ChapterReport._load() : {};
                const getRec = (cid) => (this.ChapterReport && this.ChapterReport.get) ? this.ChapterReport.get(cid) : (store[cid] || null);

                const card = (cid) => {
                    const rec = getRec(cid) || {};
                    const name = (cid === 'ch1') ? 'Chapter 1' : 'Chapter 2';

                    const learnLast = rec.learn ? (rec.learn.last || 0) : 0;
                    const learnBest = rec.learn ? (rec.learn.best || 0) : 0;
                    const learnCorrect = rec.learn ? (rec.learn.correct || 0) : 0;
                    const learnTotal = rec.learn ? (rec.learn.total || 12) : 12;

                    const arrLast  = rec.arrange ? (rec.arrange.last || 0) : 0;
                    const arrBest  = rec.arrange ? (rec.arrange.best || 0) : 0;

                    const finLast  = rec.final ? (rec.final.last || 0) : 0;
                    const finBest  = rec.final ? (rec.final.best || 0) : 0;

                    return `
                      <div style="background:rgba(155,89,182,.10); border:1px solid rgba(155,89,182,.18); border-radius:14px; padding:12px; margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px;">
                          <div style="font-weight:900; color:#6c3483;">${name}</div>
                          <div style="font-weight:900; color:#6c3483; opacity:.75; font-size:.95rem;">High Score: ${finBest} / 100</div>
                        </div>

                        <div style="margin-top:6px; font-size:1.25rem; font-weight:900;">
                          Nilai Akhir: <span style="color:#8e44ad;">${finLast}</span> / 100
                        </div>

                        <div style="margin-top:6px; font-size:.95rem; opacity:.92; line-height:1.35;">
                          Belajar: <b>${learnLast}</b>/100 <span style="opacity:.75;">(${learnCorrect}/${learnTotal})</span>
                          <span style="opacity:.7;">| best ${learnBest}</span><br/>
                          Susun: <b>${arrLast}</b>/100 <span style="opacity:.7;">| best ${arrBest}</span>
                        </div>

                        <div style="margin-top:8px; font-size:.85rem; opacity:.85;">
                          Rumus: Nilai Akhir = 40% Belajar + 60% Susun (maks 100)
                        </div>
                      </div>
                    `;
                };

                let out = "";
                out += `
`;
                out += card('ch1');
                out += card('ch2');

                // History: tampilkan 12 sesi terakhir (berdasarkan kemenangan susun huruf)
                const hist = Array.isArray(store.history) ? store.history.slice().reverse() : [];
                out += `<div style="background:rgba(0,0,0,.10); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; margin-top:10px;">`;
                out += `<div style="font-weight:900; margin-bottom:8px;">Riwayat Sesi (terakhir)</div>`;

                if(hist.length === 0) {
                    out += `<div style="opacity:.85; font-size:.95rem;">Belum ada riwayat. Riwayat akan tercatat setiap kali menang mode Susun Huruf.</div>`;
                } else {
                    const show = hist.slice(0, 12);
                    out += `<table style="width:100%; border-collapse:collapse; font-size:.95rem;">`;
                    out += `<tr style="opacity:.75;"><td style="padding:6px 4px;">Waktu</td><td style="padding:6px 4px;">Ch</td><td style="padding:6px 4px; text-align:right;">Akhir</td></tr>`;
                    show.forEach(row => {
                        const d = new Date(row.at || Date.now());
                        const when = isNaN(d.getTime()) ? '-' : d.toLocaleString('id-ID', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                        const ch = (row.chapter === 'ch2') ? '2' : '1';
                        const fin = (row.final ?? 0);
                        out += `<tr style="border-top:1px solid rgba(255,255,255,.08);">
                                <td style="padding:8px 4px; opacity:.9;">${when}</td>
                                <td style="padding:8px 4px; opacity:.9;">${ch}</td>
                                <td style="padding:8px 4px; text-align:right; font-weight:900; color:#8e44ad;">${fin} / 100</td>
                              </tr>`;
                    });
                    out += `</table>`;
                }
                out += `</div>`;

                if(listEl) listEl.innerHTML = out;
                UIManager.showScreen('scoreboardScreen');

            },

            showScoreboard: function(mode = 'adventure') {
                this.state.activeTab = mode;
                // Ensure report page is visible (used by raport menu)
                try {
                    const menu = UIManager.$('reportMenu');
                    const page = UIManager.$('reportPage');
                    if(menu) menu.style.display = 'none';
                    if(page) page.style.display = 'block';
                    const title = UIManager.$('reportTitle');
                    if(title) {
                        title.textContent =
                            (mode === 'adventure') ? 'Petualangan' :
                            (mode === 'mystery')   ? 'Buka Peti' :
                            (mode === 'puzzle')    ? 'Teka Teki' : 'Raport';
                    }
                } catch(e) {}

                const listEl = UIManager.$('scoreList');
                const totEl = UIManager.$('sbTotal');
                const totContainer = UIManager.$('sbTotalContainer');

                let h = "";
                if(mode === 'adventure') {
                    const ch = GAME_CONFIG.activeChapterId;
                    const sc = this.state.scores[ch];
                    h += `<h3 style="color:var(--primary); margin-bottom:10px;">Progres Peta (${ch === 'ch1' ? 'P1' : 'P2'})</h3>`;
                    GAME_CONFIG.levels.forEach((v, i) => {
                        h += `<div class="score-row"><span>${v.label}</span><b>${sc.lvl[i]}</b></div>`;
                    });
                    h += `<div class="score-row" style="color:#8e44ad"><span>ðŸŽ§ Tantangan</span><b>${sc.ch.reduce((a, b) => a + b, 0)}</b></div>`;
                    h += `<div class="score-row" style="color:#f1c40f"><span>ðŸ† Quiz</span><b>${sc.mem}</b></div>`;
                    const rt = sc.lvl.reduce((a, b) => a + b, 0) + sc.ch.reduce((a, b) => a + b, 0) + sc.mem;
                    const max = (GAME_CONFIG.levels.length * 100) + (2 * GAME_CONFIG.levels.length * 20) + (GAME_CONFIG.levels.length * 20);
                    totEl.innerText = Math.round((rt / max) * 100) + " / 100";
                    totContainer.style.display = 'block';
} else if(mode === 'puzzle') {
                    h += `<h3 style="color:var(--secondary); margin-bottom:10px;">Statistik Teka-Teki</h3>`;
                    const puzzleHist = this.state.history.filter(x => x.type === 'puzzle');
                    if(puzzleHist.length > 0) {
                        const best = Math.max(...puzzleHist.map(x => x.score));
                        h += `<div class="score-row" style="background:var(--secondary); color:white;"><span>Skor Terbaik</span><b>${best}</b></div>`;
                    } else {
                        h += `<p style="text-align:center; color:#999; font-style:italic;">Belum ada riwayat teka-teki.</p>`;
                    }
                    totContainer.style.display = 'none';
                } else if(mode === 'mystery') {
                    h += `<h3 style="color:#8e44ad; margin-bottom:10px;">Statistik Ruang Harta</h3>`;
                    const unlocked = this.state.mystery.unlocked.length;
                    h += `<div class="score-row"><span>Peti Terbuka</span><b>${unlocked} / 6</b></div>`;
                    const rainHist = this.state.history.filter(x => x.type === 'mystery');
                    if(rainHist.length > 0) {
                        const best = Math.max(...rainHist.map(x => x.score));
                        h += `<div class="score-row" style="background:#8e44ad; color:white;"><span>Skor Final Rain</span><b>${best}</b></div>`;
                    }
                    totContainer.style.display = 'none';
                }
                // Render Filtered History
                const filteredHist = this.state.history.filter(x => x.type === mode);
                if(filteredHist.length > 0) {
                    h += `<div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;"><h3 style="color:#666; font-size:1rem; margin-bottom:10px;">ðŸ•’ Riwayat Sesi</h3>`;
                    filteredHist.forEach(hist => {
                        let badgeColor = hist.score >= 80 ? '#27ae60' : (hist.score >= 60 ? '#f39c12' : '#c0392b');
                        h += `<div class="score-row" style="font-size:0.85rem;"><span>${hist.date} <small>(${hist.time})</small></span><b style="color:white; background:${badgeColor}; padding:2px 8px; border-radius:10px;">${hist.score}</b></div>`;
                    });
                    h += `</div>`;
                }
                listEl.innerHTML = h;
                UIManager.showScreen('scoreboardScreen');
            },
            startMysteryMode: function() { AudioManager.playSFX('click'); UIManager.showScreen('mysteryScreen'); this.renderMysteryGrid(); },
            renderMysteryGrid: function() { const grid = UIManager.$('mysteryGrid'); grid.innerHTML = ''; const unlocked = this.state.mystery.unlocked; const failed = this.state.mystery.failedIds; const totalBoxes = MYSTERY_DATA.length; const finishedCount = unlocked.length + failed.length; MYSTERY_DATA.forEach(item => { const isUnlocked = unlocked.includes(item.id); const isFailed = failed.includes(item.id); const el = document.createElement('div'); el.className = 'chest-wrapper'; if(isFailed) el.style.opacity = '0.7'; let imgUrl = isUnlocked ? 'https://cdn.imgpile.com/f/2l5bkt8_xl.png' : 'https://cdn.imgpile.com/f/u0hNA7p_xl.png'; let html = `<div class="chest-base" id="chest-${item.id}"><div class="burst-fan"></div><img src="${imgUrl}" class="chest-img"></div><div class="chest-plate"></div>`; el.innerHTML = html; el.onclick = () => this.handleMysteryClick(item, isUnlocked, isFailed); grid.appendChild(el); }); const btn = document.getElementById('btnMysteryFinal'); if(finishedCount === totalBoxes) { btn.disabled = false; btn.innerHTML = "ðŸŽ® Mulai Final Game"; btn.style.background = "linear-gradient(to bottom, #e74c3c, #c0392b)"; btn.style.color = "white"; btn.style.cursor = "pointer"; btn.style.boxShadow = "0 5px 0 #96281b"; } else { btn.disabled = true; btn.innerHTML = `ðŸ”’ Selesaikan Peti (${finishedCount}/${totalBoxes})`; btn.style.background = "#bdc3c7"; btn.style.color = "#7f8c8d"; btn.style.cursor = "not-allowed"; btn.style.boxShadow = "0 5px 0 #95a5a6"; } },
            handleMysteryClick: function(item, isUnlocked, isFailed) { if(this.state.isBusy) return; if(isFailed) { const el = document.getElementById(`chest-${item.id}`); el.classList.add('anim-rumble'); setTimeout(()=>el.classList.remove('anim-rumble'), 500); SyariahFX.playBuzz(); return; } if(isUnlocked) { SyariahFX.playChime(); return; } this.state.isBusy = true; const chestEl = document.getElementById(`chest-${item.id}`); chestEl.classList.add('anim-rumble'); SyariahFX.playRumble(); setTimeout(() => { chestEl.classList.remove('anim-rumble'); chestEl.querySelector('.chest-img').src = 'https://cdn.imgpile.com/f/2l5bkt8_xl.png'; chestEl.classList.add('anim-reveal'); SyariahFX.playCreak(); setTimeout(()=>SyariahFX.playChime(), 200);
                const rect = chestEl.getBoundingClientRect();
                const flyer = document.createElement('div');
                flyer.className = 'flying-item';
                flyer.innerText = item.icon;
                flyer.style.top = rect.top + 'px'; flyer.style.left = rect.left + 'px';
                document.body.appendChild(flyer);
                setTimeout(() => {
                    AudioManager.playSFX('whoosh');
                    flyer.style.top = '50%'; flyer.style.left = '50%';
                    flyer.style.transform = 'translate(-50%, -50%) scale(4)';
                }, 100);
                setTimeout(() => {
                    flyer.style.opacity = '0';
                    this.showMysteryPopup(item);
                    setTimeout(() => { flyer.remove(); this.state.isBusy = false; }, 400);
                }, 900);
            }, 600); },
            showMysteryPopup: function(item) { const overlay = UIManager.$('mysteryOverlay'); const content = UIManager.$('mysteryCardContent'); content.innerHTML = `<div style="font-size:6rem;">${item.icon}</div><div style="display:flex; align-items:center; justify-content:center; gap:10px; margin: 10px 0;"><h1 class="ult-arabic" style="font-size:3.5rem; margin:0;">${item.arab}</h1><button class="quiz-btn-big" onclick="GameEngine.playMysteryAudioFull('${item.arab}', '${item.indo}')">ðŸ”Š</button></div><h2 style="color:#555; margin:0; font-size: 1.8rem;">${item.latin}</h2><h3 style="color:#27ae60; margin:10px 0; font-size:2rem;">${item.indo}</h3><button class="btn" style="margin-top:20px; font-size: 1.4rem;" onclick="GameEngine.startMysteryQuiz(${item.id})">Latihan ðŸŽ¯</button>`; overlay.classList.add('active'); overlay.style.display = 'flex'; },
            startMysteryQuiz: function(itemId) { const item = MYSTERY_DATA.find(i => i.id === itemId); const overlay = UIManager.$('mysteryCardContent'); let opts = [item]; MYSTERY_DATA.filter(i => i.id !== itemId).sort(()=>Math.random()-0.5).slice(0, 3).forEach(x => opts.push(x)); opts.sort(()=>Math.random()-0.5).slice(0, 4); let html = `<h2 style="color:#8e44ad; font-size: 2.2rem; margin-bottom: 10px;">Soal 1/2</h2><p style="margin-bottom:15px; font-weight: bold; font-size: 1.1rem;">Dengarkan & pilih gambar yang tepat!</p><button class="quiz-btn-big" style="width:85px; height:85px; margin:0 auto 20px auto; font-size: 2.5rem;" onclick="AudioManager.playTTS('${item.arab}', 'ar-EG')">ðŸ”Š</button><div class="quiz-opt-grid">`; opts.forEach(o => { html += `<button class="quiz-btn" onclick="GameEngine.checkMysteryAns(1, ${o.id}, ${itemId})"><div style="font-size:3.5rem;">${o.icon}</div></button>`; }); html += `</div>`; overlay.innerHTML = html; AudioManager.playTTS(item.arab, 'ar-EG'); },
            checkMysteryAns: function(step, selectedId, correctId) {
                if(selectedId !== correctId) { this.failMysteryBox(correctId); return; }
                this.state.streak++;
                const fb = this.getStreakFeedback(this.state.streak);
                AudioManager.playSFX(fb.sfx);
                if(fb.intensity >= 1.5) UIManager.triggerFlash(0);
                if(fb.intensity >= 3) AudioManager.playSparkle();
                if(fb.intensity === 4) { UIManager.triggerFlash(2); UIManager.triggerShake(); Fireworks.start(1, 1); setTimeout(()=>Fireworks.stop(), 2500); }
                if(fb.intensity === 5) { UIManager.triggerFlash(3); UIManager.triggerShake(); UIManager.triggerConfetti(3, 2); Fireworks.start(2, 2); setTimeout(()=>Fireworks.stop(), 3500); }
                if(step === 1) {
                    UIManager.showFeedback(true, () => {
                        const item = MYSTERY_DATA.find(i => i.id === correctId);
                        const overlay = UIManager.$('mysteryCardContent');
                        let opts = [item];
                        MYSTERY_DATA.filter(i => i.id !== correctId).sort(()=>Math.random()-0.5).slice(0, 2).forEach(x => opts.push(x));
                        opts.sort(()=>Math.random()-0.5);
                        let html = `<h2 style="color:#8e44ad; font-size: 2.2rem; margin-bottom: 10px;">Soal 2/2</h2><p style="margin-bottom:15px; font-weight: bold; font-size: 1.1rem;">Apa bahasa Arabnya?</p><div style="font-size:5rem; margin-bottom:15px;">${item.icon}</div><div class="options-grid">`;
                        opts.forEach(o => { html += `<div class="option-row"><button class="btn-sound" onclick="event.stopPropagation(); AudioManager.playTTS('${o.arab}', 'ar-EG')">ðŸ”Š</button><button class="btn-option arabic btn-answer-split" onclick="GameEngine.checkMysteryAns(2, ${o.id}, ${correctId})">${o.arab}</button></div>`; });
                        html += `</div>`; overlay.innerHTML = html;
                    }, fb.msg, "Benar!", fb.emoji);
                } else {
                    UIManager.showFeedback(true, () => { this.successMysteryBox(correctId); }, fb.msg, "Benar!", fb.emoji);
                }
                UIManager.updateHud(this.state.progress, this.state.scores, this.state.streak);
            },
            failMysteryBox: function(id) {
                this.state.streak = 0;
                AudioManager.playSFX('wrong');
                UIManager.showFeedback(false, () => {
                    const overlay = UIManager.$('mysteryOverlay');
                    overlay.classList.remove('active');
                    setTimeout(()=>overlay.style.display='none', 200);
                    this.state.mystery.failedIds.push(id);
                    const chestEl = document.getElementById(`chest-${id}`);
                    chestEl.classList.remove('anim-reveal');
                    chestEl.querySelector('.chest-img').src = 'https://cdn.imgpile.com/f/u0hNA7p_xl.png';
                    chestEl.classList.add('anim-slam');
                    SyariahFX.playSlam();
                    this.state.isBusy = false;
                    this.renderMysteryGrid();
                }, "Qadarullah, belum tepat. Ayo coba lagi!", "Belum Tepat", "âŒ");
                UIManager.updateHud(this.state.progress, this.state.scores, 0);
            },
            successMysteryBox: function(id) { SyariahFX.playCoinShower(); const overlay = UIManager.$('mysteryOverlay'); overlay.classList.remove('active'); setTimeout(()=>overlay.style.display='none', 200); this.state.mystery.unlocked.push(id); this.saveData(); this.state.isBusy = false; this.renderMysteryGrid(); },
            startFinalRainGame: function() { this.state.finalGame = { active: true, level: 0, life: 5, timer: 35, correctCount: 0, totalCorrect: 0, mistakeCount: 0, streak: 0, items: [] }; UIManager.showScreen('mysteryFinalScreen'); this.nextRainLevel(); },
            nextRainLevel: function() { const fg = this.state.finalGame; if(fg.level >= 6) { this.finishFinalGame(true); return; } fg.level++; fg.timer = 35; fg.correctCount = 0; this.state.currentTarget = MYSTERY_DATA[fg.level - 1]; document.getElementById('rainTargetText').innerText = this.state.currentTarget.arab; this.updateRainHud(); AudioManager.playTTS(this.state.currentTarget.arab, 'ar-EG'); if(fg.interval) clearInterval(fg.interval); if(fg.spawnInterval) clearInterval(fg.spawnInterval); fg.interval = setInterval(() => { fg.timer--; this.updateRainHud(); if(fg.timer <= 0) { clearInterval(fg.interval); clearInterval(fg.spawnInterval); this.clearRainItems(); this.nextRainLevel(); } }, 1000); fg.spawnInterval = setInterval(() => this.spawnRainItem(), 600); },
            playRainAudio: function() { if(this.state.currentTarget) { AudioManager.playTTS(this.state.currentTarget.arab, 'ar-EG'); } },
            updateRainHud: function() { document.getElementById('rainLife').innerText = this.state.finalGame.life; document.getElementById('rainTimer').innerText = this.state.finalGame.timer; document.getElementById('rainCount').innerText = this.state.finalGame.correctCount; },
            spawnRainItem: function() { const container = document.getElementById('rainContainer'); const isCorrect = Math.random() < 0.4; const itemData = isCorrect ? this.state.currentTarget : MYSTERY_DATA.filter(i => i.id !== this.state.currentTarget.id).sort(()=>Math.random()-0.5)[0]; const el = document.createElement('div'); el.className = 'rain-item'; el.innerText = itemData.icon; el.style.left = (Math.random() * 85 + 5) + '%'; el.style.top = '-60px'; let top = -60; const speed = 2 + Math.random() * 3; const fall = () => { if(!this.state.finalGame.active || !el.parentNode) return; top += speed; el.style.top = top + 'px'; if(top > window.innerHeight) { el.remove(); } else { requestAnimationFrame(fall); } }; requestAnimationFrame(fall); el.onmousedown = (e) => { e.stopPropagation(); el.remove(); this.checkRainClick(isCorrect, e.clientX, e.clientY); }; container.appendChild(el); },
            checkRainClick: function(isCorrect, x, y) { const fg = this.state.finalGame; const splash = document.createElement('div'); splash.className = 'rain-splash'; splash.style.left = x + 'px'; splash.style.top = y + 'px'; let streakIcon = ""; if(isCorrect) { fg.streak++; fg.correctCount++; if(fg.correctCount <= 15) fg.totalCorrect++; if (fg.streak >= 10 && fg.streak < 20) streakIcon = "âœ¨"; else if (fg.streak >= 20 && fg.streak < 30) streakIcon = "ðŸŒŸ"; else if (fg.streak >= 30 && fg.streak < 40) streakIcon = "ðŸ’¥"; else if (fg.streak >= 40) streakIcon = "ðŸ‘‘"; splash.innerText = `+1 ${streakIcon} ðŸ”¥${fg.streak}`; if(fg.streak === 10) { AudioManager.playSFX('streak1'); UIManager.triggerFlash(0); } else if(fg.streak === 20) { AudioManager.playSFX('streak2'); UIManager.triggerFlash(2); UIManager.triggerConfetti(1.5, 0); } else if(fg.streak === 30) { AudioManager.playSFX('streak3'); UIManager.triggerFlash(2); UIManager.triggerShake(); Fireworks.start(1, 1); setTimeout(()=>Fireworks.stop(), 2500); } else if(fg.streak >= 40 && fg.streak % 10 === 0) { AudioManager.playSFX('streak4'); UIManager.triggerFlash(3); UIManager.triggerShake(); UIManager.triggerConfetti(3, 2); Fireworks.start(3, 2); setTimeout(()=>Fireworks.stop(), 4000); } else { SyariahFX.playPing(); } if(fg.correctCount >= 15) { clearInterval(fg.interval); clearInterval(fg.spawnInterval); this.clearRainItems(); setTimeout(() => this.nextRainLevel(), 500); } } else { fg.streak = 0; SyariahFX.playThud(); fg.life--; fg.mistakeCount++; streakIcon = "ðŸ’”"; splash.innerText = streakIcon; UIManager.triggerFlash(1); if(fg.life <= 0) { this.gameOverFinal(); } } splash.style.color = isCorrect ? "#2ecc71" : "#e74c3c"; document.body.appendChild(splash); setTimeout(()=>splash.remove(), 500); this.updateRainHud(); },
            clearRainItems: function() { document.getElementById('rainContainer').innerHTML = ''; },
            gameOverFinal: function() { const fg = this.state.finalGame; fg.active = false; clearInterval(fg.interval); clearInterval(fg.spawnInterval); this.clearRainItems(); UIManager.showScreen('mysteryScreen'); },
            finishFinalGame: function(completed) { const fg = this.state.finalGame; fg.active = false; clearInterval(fg.interval); clearInterval(fg.spawnInterval); this.clearRainItems(); const petiRaw = this.state.mystery.unlocked.length; const finalRaw = fg.totalCorrect; const petiNorm = Math.round((petiRaw / 6) * 20); let finalNorm = Math.round((finalRaw / 90) * 80); finalNorm = Math.max(0, finalNorm - fg.mistakeCount); const totalScore = petiNorm + finalNorm; const resScreen = document.getElementById('mysteryResultScreen'); if(totalScore >= 75) { resScreen.style.backgroundImage = "url('https://cdn.imgpile.com/f/efTiOXg_xl.png')"; } else { resScreen.style.backgroundImage = "url('https://cdn.imgpile.com/f/EBRr2pp_xl.png')"; } document.getElementById('mrScorePeti').innerText = petiNorm; document.getElementById('mrScoreFinal').innerText = finalNorm; document.getElementById('mrTotal').innerText = totalScore; const title = document.getElementById('mrTitle'); const msg = document.getElementById('mrMsg'); const emoji = document.getElementById('mrEmoji'); if(totalScore >= 75) { title.innerText = "Baarakallahu Fiik!"; title.style.color = "#27ae60"; msg.innerText = "Alhamdulillah, luar biasa!"; emoji.innerText = "ðŸŽ‰"; SyariahFX.playRewardFanfare(); Fireworks.start(2, 3); UIManager.triggerConfetti(2); setTimeout(() => { Fireworks.stop(true); }, 3000); } else { title.innerText = "Tetap Semangat!"; title.style.color = "#e67e22"; msg.innerText = "InsyaAllah makin lancar. Coba lagi yuk!"; emoji.innerText = "ðŸ’ª"; } UIManager.showScreen('mysteryResultScreen'); },
            finishMysteryFull: function() {
                const score = parseInt(document.getElementById('mrTotal').innerText);
                this.state.history.unshift({ type: 'mystery', score: score, date: new Date().toLocaleDateString('id-ID'), time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) });
                this.state.mystery.unlocked = []; this.state.mystery.failedIds = []; this.saveData(); this.renderMysteryGrid(); Fireworks.stop(); UIManager.showScreen('chapterScreen');
            },
            startPuzzleMode: function() {
                AudioManager.playSFX('click');
                const all = [...RAW_DATA.ch1, ...RAW_DATA.ch2, ...MYSTERY_DATA];
                this.state.puzzleQueue = all.sort(() => Math.random() - 0.5);
                this.state.puzzleIdx = 0; this.state.puzzleCorrect = 0; this.state.streak = 0; this.nextPuzzle();
            },
            startArrangeMode: function() {
                // Safe additive entry point: does not touch existing modes
                AudioManager.playSFX('click');
                UIManager.showScreen('arrangeScreen');
                this.arrangeShowSelect();
            },

            /* ============================
               Arrange Mode (Susun Huruf)
               - Bank B (terpisah, additive)
               - Input: klik potongan
               - Harakat harus persis
               ============================ */

            // Utility: split Arabic word into clickable parts (huruf + harakat).
            // Rules:
            // - Default: each base letter with its combining marks is one part.
            // - Madd letters (Ø§ Ùˆ ÙŠ Ù‰) without marks are attached to the previous part (e.g., Ù†ÙŽ + Ø§ => Ù†ÙŽØ§).
            // - Weak letter with sukun (ÙŠÙ’ / ÙˆÙ’) is attached to previous part to form diphthong (e.g., Ø£ÙŽ + ÙŠÙ’ => Ø£ÙŽÙŠÙ’).
            splitArabicParts: function(word) {
                if(!word) return [];
                const isMark = (ch) => /[\u064B-\u0652\u0670]/.test(ch); // tanwin..sukun + dagger alif
                const SUKUN = '\u0652';
                const FATHA = '\u064E';
                const DAMMA = '\u064F';
                const KASRA = '\u0650';

                // Step 1: build grapheme-like clusters: base + marks
                const clusters = [];
                for(let i=0;i<word.length;i++) {
                    const ch = word[i];
                    if(isMark(ch)) {
                        if(clusters.length) clusters[clusters.length-1] += ch;
                        else clusters.push(ch);
                    } else {
                        clusters.push(ch);
                    }
                }

                const has = (s, c) => s.indexOf(c) !== -1;
                const hasVowel = (s) => (has(s, FATHA) || has(s, DAMMA) || has(s, KASRA) || /[\u064B-\u064D]/.test(s)); // incl tanwin
                const hasSukun = (s) => has(s, SUKUN);
                const isBareMadd = (s) => (s.length === 1 && ['Ø§','Ùˆ','ÙŠ','Ù‰'].includes(s));

                // Step 2: merge based on rules above
                const merged = [];
                for(let i=0;i<clusters.length;i++) {
                    const cur = clusters[i];
                    const prev = merged.length ? merged[merged.length-1] : null;

                    // attach bare madd letter to previous vowel (but never after sukun)
                    if(prev && isBareMadd(cur) && hasVowel(prev) && !hasSukun(prev)) {
                        merged[merged.length-1] = prev + cur;
                        continue;
                    }

                    // attach weak letter with sukun (ÙŠÙ’ / ÙˆÙ’) to previous vowel to form diphthong (e.g., Ø£ÙŽ + ÙŠÙ’ => Ø£ÙŽÙŠÙ’)
                    if(prev && cur.length >= 2 && (cur[0] === 'ÙŠ' || cur[0] === 'Ùˆ') && hasSukun(cur) && hasVowel(prev) && !hasSukun(prev)) {
                        merged[merged.length-1] = prev + cur;
                        continue;
                    }

                    merged.push(cur);
                }

                return merged;
            },

            arrangeBank: {
                ch1: [
                    // Chapter 1 (6 mufradat): petunjuk gambar muncul setelah salah 2x (hintType/hintImg)
                    // Catatan aset hint (isi nanti):
                    // Chapter 1: ch1_ayn.png, ch1_hunaka.png, ch1_huna.png, ch1_ala.png, ch1_tahta.png, ch1_bijanibi.png
                    // Chapter 2: ch2_amama.png, ch2_waraa.png, ch2_min.png, ch2_limadha.png, ch2_man.png, ch2_kayfa.png
                                        { meaning: 'Di mana',    word: 'Ø£ÙŽÙŠÙ’Ù†ÙŽ',    parts: ['Ø£ÙŽÙŠÙ’','Ù†ÙŽ'],             hintType: 'where',  hintImg: 'https://cdn.imgpile.com/f/xn7EOZv_xl.png' },
                    { meaning: 'Di sana',    word: 'Ù‡ÙÙ†ÙŽØ§ÙƒÙŽ',   parts: ['Ù‡Ù','Ù†ÙŽØ§','ÙƒÙŽ'],        hintType: 'there',  hintImg: 'https://cdn.imgpile.com/f/sjswHX7_xl.png' },
                    { meaning: 'Di sini',    word: 'Ù‡ÙÙ†ÙŽØ§',     parts: ['Ù‡Ù','Ù†ÙŽØ§'],             hintType: 'here',   hintImg: 'https://cdn.imgpile.com/f/LlCYBCv_xl.png' },
                    { meaning: 'Di atas',    word: 'Ø¹ÙŽÙ„ÙŽÙ‰',     parts: ['Ø¹ÙŽ','Ù„ÙŽÙ‰'],             hintType: 'above',  hintImg: 'https://cdn.imgpile.com/f/ep3Qh7u_xl.png' },
                    { meaning: 'Di bawah',   word: 'ØªÙŽØ­Ù’ØªÙŽ',    parts: ['ØªÙŽ','Ø­Ù’','ØªÙŽ'],         hintType: 'below',  hintImg: 'https://cdn.imgpile.com/f/wRh5ZMI_xl.png' },
                    { meaning: 'Di samping', word: 'Ø¨ÙØ¬ÙŽØ§Ù†ÙØ¨Ù', parts: ['Ø¨Ù','Ø¬ÙŽØ§','Ù†Ù','Ø¨Ù'],  hintType: 'beside', hintImg: 'https://cdn.imgpile.com/f/rKU0GMi_xl.png' }
                ],
                ch2: [
                    // Chapter 2 (6 mufradat)
                    { meaning: 'Di depan',    word: 'Ø£ÙŽÙ…ÙŽØ§Ù…ÙŽ',  parts: ['Ø£ÙŽ','Ù…ÙŽØ§','Ù…ÙŽ'],        hintType: 'front', hintImg: 'https://cdn.imgpile.com/f/FreDD3T_xl.png' },
                    { meaning: 'Di belakang', word: 'ÙˆÙŽØ±ÙŽØ§Ø¡ÙŽ',  parts: ['ÙˆÙŽ','Ø±ÙŽØ§','Ø¡ÙŽ'],        hintType: 'back',  hintImg: 'https://cdn.imgpile.com/f/r9kn7w5_xl.png' },
                    { meaning: 'Dari',        word: 'Ù…ÙÙ†Ù’',     parts: ['Ù…Ù','Ù†Ù’'],              hintType: 'from',  hintImg: 'https://cdn.imgpile.com/f/rBSUPJL_xl.png' },
                    { meaning: 'Kenapa',      word: 'Ù„ÙÙ…ÙŽØ§Ø°ÙŽØ§', parts: ['Ù„Ù','Ù…ÙŽØ§','Ø°ÙŽØ§'],       hintType: 'why',   hintImg: 'https://cdn.imgpile.com/f/hu3Z53s_xl.png' },
                    { meaning: 'Siapa',       word: 'Ù…ÙŽÙ†Ù’',     parts: ['Ù…ÙŽ','Ù†Ù’'],              hintType: 'who',   hintImg: 'https://cdn.imgpile.com/f/j5RCZJd_xl.png' },
                    { meaning: 'Bagaimana',   word: 'ÙƒÙŽÙŠÙ’ÙÙŽ',   parts: ['ÙƒÙŽÙŠÙ’','ÙÙŽ'],            hintType: 'how',   hintImg: 'https://cdn.imgpile.com/f/O5C6gVF_xl.png' }
                ]
            },

                        arrangeShowSelect: function() {
                const sel = document.getElementById('arrangeSelectView');
                const play = document.getElementById('arrangePlayView');
                const learn = document.getElementById('arrangeLearnView');
                if(sel) sel.style.display = '';
                if(play) play.style.display = 'none';
                if(learn) learn.style.display = 'none';
                // close overlays safely (avoid state leaks)
                const mp = document.getElementById('arrangeModePicker');
                if(mp) mp.style.display = 'none';
                const lm = document.getElementById('learnModal');
                if(lm) lm.style.display = 'none';
            },

            arrangeBackToSelect: function() {
                AudioManager.playSFX('click');
                this.arrangeShowSelect();
            },
            // ===== Arrange: chapter -> pilih mode (Belajar / Susun), minim perubahan =====
            arrangePickChapter: function(chapterId) {
                AudioManager.playSFX('click');
                this.state._arrangePick = { chapter: chapterId };

                const mp = document.getElementById('arrangeModePicker');
                const ct = document.getElementById('arrangeModeChapterText');
                const lockNote = document.getElementById('arrangeModeLockNote');
                const btnArrange = document.getElementById('arrangeBtnPickerArrange');

                if(ct) ct.textContent = (chapterId === 'ch1') ? 'Chapter 1' : 'Chapter 2';

                // Susun Huruf tidak dikunci (boleh langsung)
                if(btnArrange) btnArrange.disabled = false;
                if(lockNote) lockNote.style.display = 'none';
                if(mp) mp.style.display = 'flex';
            },

            arrangeCloseModePicker: function() {
                const mp = document.getElementById('arrangeModePicker');
                if(mp) mp.style.display = 'none';
            },

            arrangeStartLearnFromPicker: function() {
                const ch = (this.state._arrangePick && this.state._arrangePick.chapter) ? this.state._arrangePick.chapter : 'ch1';
                this.arrangeCloseModePicker();
                this.LearnMode.start(ch);
            },

            arrangeStartArrangeFromPicker: function() {
                const ch = (this.state._arrangePick && this.state._arrangePick.chapter) ? this.state._arrangePick.chapter : 'ch1';
                // (info popup dihapus)
this.arrangeCloseModePicker();
                this.startArrangeChapter(ch);
            },

            // ===== LearnMode (Belajar) for Arrange Bank =====
            LearnMode: {
                _shuffleTimers: [],
                _state: null, // in-memory; persistence handled via localStorage

                _bank: function(chapterId) {
                    return (GameEngine.arrangeBank && GameEngine.arrangeBank[chapterId]) ? GameEngine.arrangeBank[chapterId] : [];
                },

                _key: function(chapterId) {
                    return `learn_arrange_${chapterId}_v2`;
                },

                _load: function(chapterId) {
                    // v2 (done + quiz matrix). fallback to v1 (done only).
                    let raw = null;
                    try { raw = JSON.parse(localStorage.getItem(this._key(chapterId)) || 'null'); } catch(e) { raw = null; }

                    if(!raw || typeof raw !== 'object') {
                        // fallback v1
                        try { raw = JSON.parse(localStorage.getItem(`learn_arrange_${chapterId}_v1`) || 'null'); } catch(e) { raw = null; }
                    }

                    const done = Array.isArray(raw && raw.done) ? raw.done.slice(0, 6).map(v => v ? 1 : 0) : new Array(6).fill(0);
                    while(done.length < 6) done.push(0);

                    // q: 6x2 matrix (quiz1, quiz2) per kartu. value: 1 correct, 0 wrong, null not answered yet
                    let q = null;
                    if(Array.isArray(raw && raw.q)) q = raw.q;
                    if(!Array.isArray(q) || q.length < 6) q = Array.from({length:6}, () => [null, null]);
                    q = q.slice(0,6).map(row => {
                        const r = Array.isArray(row) ? row.slice(0,2) : [null,null];
                        while(r.length < 2) r.push(null);
                        return r.map(v => (v === 1 || v === 0) ? v : null);
                    });

                    return { done, q, updatedAt: (raw && raw.updatedAt) ? raw.updatedAt : null };
                },

                _save: function(chapterId, doneArr, qArr) {
                    const done = Array.isArray(doneArr) ? doneArr.slice(0,6).map(v => v ? 1 : 0) : new Array(6).fill(0);
                    while(done.length < 6) done.push(0);

                    let q = Array.isArray(qArr) ? qArr.slice(0,6) : Array.from({length:6}, () => [null,null]);
                    q = q.map(row => {
                        const r = Array.isArray(row) ? row.slice(0,2) : [null,null];
                        while(r.length < 2) r.push(null);
                        return r.map(v => (v === 1 || v === 0) ? v : null);
                    });

                    try {
                        localStorage.setItem(this._key(chapterId), JSON.stringify({
                            done,
                            q,
                            updatedAt: new Date().toISOString()
                        }));
                    } catch(e) {}
                },

                resetChapter: function(chapterId) {
                    const done = new Array(6).fill(0);
                    this._save(chapterId, done, Array.from({length:6}, () => [null, null]));
                    if(this._state && this._state.chapter === chapterId) {
                        this._state.done = done.slice();
                        this._state.closed = new Array(6).fill(false);
                        this._renderGrid();
                        this._renderProgress();
                    }
                },

                getDoneCount: function(chapterId) {
                    const p = this._load(chapterId);
                    return p.done.filter(Boolean).length;
                },

                _ensureState: function(chapterId) {
                    const bank = this._bank(chapterId);
                    if(!bank || !bank.length) return null;

                    const persisted = this._load(chapterId);

                    const order = Array.from({length: Math.min(6, bank.length)}, (_, i) => i);
                    // Keep a deterministic base, but shuffle for session variety.
                    for(let i = order.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [order[i], order[j]] = [order[j], order[i]];
                    }

                    this._state = {
                        chapter: chapterId,
                        started: false,
                        isShuffling: false,
                        closed: new Array(6).fill(false),
                        order,
                        done: persisted.done,
                        q: (persisted && persisted.q) ? persisted.q : Array.from({length:6}, () => [null, null]),
                        // modal flow
                        activeCard: null,
                        phase: null,           // 'material' | 'quiz1' | 'quiz1_fb' | 'quiz2' | 'quiz2_fb' | 'review'
                        audioCount: 0,
                        quiz: null,            // {qType, prompt, options, correctIndex}
                        feedback: null         // {isCorrect, correctText}
                    };
                    return this._state;
                },

                start: function(chapterId) {
                    AudioManager.playSFX('click');

                    const bank = this._bank(chapterId);
                    const fb = document.getElementById('arrangeFeedback');
                    if(!bank.length) {
                        if(fb) fb.textContent = 'Bank kata untuk chapter ini belum diisi.';
                        return;
                    }

                    // view switching (isolated)
                    const sel = document.getElementById('arrangeSelectView');
                    const play = document.getElementById('arrangePlayView');
                    const learn = document.getElementById('arrangeLearnView');
                    if(sel) sel.style.display = 'none';
                    if(play) play.style.display = 'none';
                    if(learn) learn.style.display = '';

                    // label
                    const lbl = document.getElementById('learnChapterLabel');
                    if(lbl) lbl.textContent = (chapterId === 'ch1') ? '1' : '2';

                    // init state + render
                    this._ensureState(chapterId);
                    this._renderGrid();
                    this._renderProgress();
                    this._setStarted(false);
                },

                begin: function() {
                    if(!this._state) return;
                    AudioManager.playSFX('click');
                    this._ensureShuffleAudio();
                    this._setStarted(true);
// Wajib acak: tutup semua kartu dulu, lalu shuffle
                    this._closeAllCards();
                    setTimeout(() => this._doShuffleHybrid(4000), 520);
                },

                goToArrange: function() {
                    if(!this._state) return;
                    const ch = this._state.chapter;
                    GameEngine.startArrangeChapter(ch);
                },

                _closeAllCards: function() {
                    if(!this._state) return;

                    const grid = document.getElementById('learnGrid');
                    const cards = grid ? Array.from(grid.querySelectorAll('.learn-card')) : [];

                    // Tutup hanya kartu yang BELUM selesai; kartu selesai tetap terbuka (reward)
                    for(let i=0;i<6;i++){
                        if(this._state.done[i]) {
                            this._state.closed[i] = false;
                        } else {
                            this._state.closed[i] = true;
                        }
                    }

                    if(cards.length){
                        let closeSeq = 0;
                        cards.forEach((c) => {
                            const cardIdx = Number(c.dataset.cardIdx);
                            const isDone = !!this._state.done[cardIdx];

                            if(isDone){
                                // pastikan reward tetap terbuka
                                c.classList.remove('is-closed');
                                return;
                            }
                            // flip menutup per kartu (stagger ringan)
                            const d = closeSeq * 70;
                            closeSeq++;
                            setTimeout(() => { this._flipSfx(false); c.classList.add('is-closed'); }, d);
                        });
                    }
                },

                _openCardFace: function(cardIdx) {
                    if(!this._state) return;
                    this._state.closed[cardIdx] = false;
                    const grid = document.getElementById('learnGrid');
                    if(grid) {
                        const el = grid.querySelector(`.learn-card[data-card-idx="${cardIdx}"]`);
                        if(el) el.classList.remove('is-closed');
                    }
                },

_setStarted: function(v) {
                    if(!this._state) return;
                    this._state.started = !!v;
                    const p = document.getElementById('learnStartPanel');
                    if(p) p.style.display = this._state.started ? 'none' : '';
                    // lock cards until started (tombol mulai)
                    const grid = document.getElementById('learnGrid');
                    if(grid) {
                        const cards = grid.querySelectorAll('.learn-card');
                        cards.forEach(c => {
                            if(this._state.started) c.classList.remove('disabled');
                            else c.classList.add('disabled');
                        });
                    }
                },

                _renderProgress: function() {
                    if(!this._state) return;
                    const doneCount = this._state.done.filter(Boolean).length;

                    // scoring: when all 6 cards finished, finalize LearnScore (0-100) and store to raport
                    if(doneCount >= 6) {
                        try {
                            const total = 12;
                            let correct = 0;
                            const q = Array.isArray(this._state.q) ? this._state.q : [];
                            for(let i=0;i<6;i++){
                                const row = Array.isArray(q[i]) ? q[i] : [];
                                if(row[0] === 1) correct += 1;
                                if(row[1] === 1) correct += 1;
                            }
                            const learnScore = Math.round((correct / total) * 100);
                            if(GameEngine && GameEngine.ChapterReport && typeof GameEngine.ChapterReport.recordLearn === 'function') {
                                GameEngine.ChapterReport.recordLearn(ch, learnScore, correct, total);
                            }
                        } catch(e) {}
                    }
                    const prog = document.getElementById('learnProgressLine');
                    if(prog) prog.textContent = `Selesai: ${doneCount}/6`;

                    const btn = document.getElementById('learnBtnStartArrange');
                    if(btn) {
                        btn.disabled = false;
                        btn.textContent = 'ðŸ§± Main Susun Huruf';
                        btn.style.display = (doneCount >= 6) ? '' : 'none';
                    }
                },

                _cardTitle: function(idx) {
                    // simple numbering for kids
                    return `Kartu ${idx + 1}`;
                },

                _renderGrid: function() {
                    if(!this._state) return;
                    const bank = this._bank(this._state.chapter);
                    const grid = document.getElementById('learnGrid');
                    if(!grid) return;

                    grid.innerHTML = '';
                    this._state.order.forEach(cardIdx => {
                        const item = bank[cardIdx];
                        const done = !!this._state.done[cardIdx];
                        const isClosed = !!this._state.closed[cardIdx];

                        const card = document.createElement('div');
                        card.className = 'learn-card' + (this._state.started ? '' : ' disabled') + (isClosed ? ' is-closed' : '');
                        card.dataset.cardIdx = String(cardIdx);

                        const flip = document.createElement('div');
                        flip.className = 'learn-flip';

                        const inner = document.createElement('div');
                        inner.className = 'learn-flip-inner';

                        const front = document.createElement('div');
                        front.className = 'learn-face front';
                        const img = document.createElement('img');
                        img.src = item.hintImg || '';
                        img.alt = 'mufradat';
                        front.appendChild(img);

                        const back = document.createElement('div');
                        back.className = 'learn-face back';
                        const mark = document.createElement('div');
                        mark.className = 'learn-back-mark';
                        mark.textContent = 'KARTU';
                        back.appendChild(mark);

                        inner.appendChild(front);
                        inner.appendChild(back);
                        flip.appendChild(inner);

                        const badge = document.createElement('div');
                        badge.className = 'learn-badge' + (done ? ' done' : '');
                        badge.textContent = done ? 'Selesai' : 'Belum';

                        card.appendChild(flip);
                        card.appendChild(badge);

                        card.onclick = () => {
                            if(!this._state || !this._state.started || this._state.isShuffling) return;
                            this.openCard(cardIdx);
                        };

                        grid.appendChild(card);
                    });
                },

                shuffle: function(isAuto=false) {
                    if(!this._state) return;
                    this._ensureShuffleAudio();
                    if(!this._state.started){
                        if(isAuto) return;
                        UIManager.showCustomAlert('Mulai dulu', 'Klik tombol Mulai untuk memulai belajar.');
                        return;
                    }
                    if(!isAuto) AudioManager.playSFX('click');
                    // Shuffle posisi saja (tanpa menutup kartu massal). Tutup massal + flip beruntun hanya saat awal mulai belajar.
                    setTimeout(() => this._doShuffleHybrid(4000), 20);
                },

                _clearShuffleTimers: function() {
                    try { this._shuffleTimers.forEach(t => clearTimeout(t)); } catch(e) {}
                    this._shuffleTimers = [];
                    const fl = document.getElementById('learnFloatLayer');
                    if(fl) fl.innerHTML = '';
                },

                
                _ensureShuffleAudio: function() {
                    // Procedural shuffle SFX (no external assets)
                    if(this._shuffleAudio && this._shuffleAudio.ctx) {
                        try { this._shuffleAudio.ctx.resume(); } catch(e) {}
                        return;
                    }
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if(!AudioCtx) return;
                    const ctx = new AudioCtx();

                    // stronger compressor/limiter chain for higher loudness
                    const comp = ctx.createDynamicsCompressor();
                    comp.threshold.value = -26;
                    comp.knee.value = 18;
                    comp.ratio.value = 8;
                    comp.attack.value = 0.002;
                    comp.release.value = 0.14;

                    const master = ctx.createGain();
                    master.gain.value = 2.2; // lebih kencang lagi

                    const makeup = ctx.createGain();
                    makeup.gain.value = 1.15; // sedikit makeup setelah kompresi

                    master.connect(comp);
                    comp.connect(makeup);
                    makeup.connect(ctx.destination);

                    this._shuffleAudio = { ctx, master, comp, makeup };
                    try { ctx.resume(); } catch(e) {}
                },

                _shuffleSfxPulse: function(k, steps) {
                    // "Ribbon Whoosh" (Natural) per movement-step (tanpa click yang tajam)
                    this._ensureShuffleAudio();
                    if(!this._shuffleAudio || !this._shuffleAudio.ctx) return;

                    const ctx = this._shuffleAudio.ctx;
                    const master = this._shuffleAudio.master;

                    const t0 = ctx.currentTime;
                    const phase = (steps <= 1) ? 0 : (k / (steps - 1));
                    const intensity = 1.0 - (phase * 0.35); // tetap terasa sampai akhir

                    const dur = 0.17 + Math.random() * 0.09; // 170â€“260ms

                    const env = (gn, peak) => {
                        gn.gain.setValueAtTime(0.0001, t0);
                        const a = Math.min(0.02, dur * 0.25);
                        gn.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), t0 + a);
                        gn.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
                    };

                    // tonal ribbon (sine glide)
                    const osc = ctx.createOscillator();
                    osc.type = 'sine';
                    const f0 = 820 + Math.random() * 240;
                    const f1 = 250 + Math.random() * 120;
                    osc.frequency.setValueAtTime(f0, t0);
                    osc.frequency.exponentialRampToValueAtTime(f1, t0 + dur);

                    const og = ctx.createGain();
                    env(og, 0.34 * intensity);

                    // airy noise layer (dibuat halus supaya tidak memekik)
                    const sr = ctx.sampleRate;
                    const n = Math.floor(sr * dur);
                    const buf = ctx.createBuffer(1, n, sr);
                    const data = buf.getChannelData(0);
                    for(let i=0;i<n;i++) data[i] = (Math.random() * 2 - 1);

                    const src = ctx.createBufferSource();
                    src.buffer = buf;

                    const hp = ctx.createBiquadFilter();
                    hp.type = 'highpass';
                    hp.frequency.value = 850 + Math.random() * 220;

                    const lp = ctx.createBiquadFilter();
                    lp.type = 'lowpass';
                    lp.frequency.value = 2600 + Math.random() * 520;

                    const ng = ctx.createGain();
                    env(ng, 0.26 * intensity);

                    osc.connect(og);
                    og.connect(master);

                    src.connect(hp);
                    hp.connect(lp);
                    lp.connect(ng);
                    ng.connect(master);

                    try {
                        osc.start(t0);
                        osc.stop(t0 + dur + 0.01);
                        src.start(t0);
                        src.stop(t0 + dur + 0.01);
                    } catch(e) {}
                },

                _stopShuffleAudio: function() {
                    // Pulses are short; nothing persistent to stop. Keep context alive for next gesture.
                    // Placeholder for future (if loop is added).
                },

                _flipSfx: function(isOpen) {
                    // Card Tap + Flip (tanpa file audio eksternal)
                    // isOpen=true: flip buka; false: flip tutup
                    this._ensureShuffleAudio();
                    if(!this._shuffleAudio || !this._shuffleAudio.ctx) return;
                    const ctx = this._shuffleAudio.ctx;
                    const master = this._shuffleAudio.master;

                    const t0 = ctx.currentTime;

                    // Local gain so flip SFX stays controlled even if master is high for shuffle
                    const local = ctx.createGain();
                    local.gain.value = 0.35; // kontrol umum (bisa dinaikkan kalau perlu)
                    local.connect(master);

                    const env = (g, peak, dur) => {
                        g.gain.setValueAtTime(0.0001, t0);
                        g.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), t0 + Math.min(0.02, dur*0.25));
                        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
                    };

                    // Thump (low) â€” gives "tap" feeling
                    const osc = ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = isOpen ? (160 + Math.random()*40) : (120 + Math.random()*35);
                    const og = ctx.createGain();
                    env(og, isOpen ? 0.18 : 0.22, 0.08);
                    osc.connect(og);
                    og.connect(local);

                    // Swish (mid) â€” short filtered noise
                    const dur = isOpen ? (0.11 + Math.random()*0.05) : (0.13 + Math.random()*0.06);
                    const sr = ctx.sampleRate;
                    const n = Math.floor(sr * dur);
                    const buf = ctx.createBuffer(1, n, sr);
                    const data = buf.getChannelData(0);
                    let last = 0;
                    for(let i=0;i<n;i++){
                        const white = (Math.random()*2 - 1);
                        last = last*0.85 + white*0.15; // smoothing to avoid harsh hiss
                        data[i] = last;
                    }
                    const noise = ctx.createBufferSource();
                    noise.buffer = buf;

                    const bp = ctx.createBiquadFilter();
                    bp.type = 'bandpass';
                    bp.frequency.value = isOpen ? (900 + Math.random()*260) : (650 + Math.random()*260);
                    bp.Q.value = 0.9;

                    const lp = ctx.createBiquadFilter();
                    lp.type = 'lowpass';
                    lp.frequency.value = isOpen ? (2200 + Math.random()*600) : (1900 + Math.random()*520);

                    const ng = ctx.createGain();
                    env(ng, isOpen ? 0.28 : 0.32, dur);

                    noise.connect(bp);
                    bp.connect(lp);
                    lp.connect(ng);
                    ng.connect(local);

                    try {
                        osc.start(t0);
                        osc.stop(t0 + 0.09);
                        noise.start(t0);
                        noise.stop(t0 + dur + 0.01);
                    } catch(e) {}
                },
_doShuffleHybrid: function(totalMs) {
                    const stage = document.getElementById('learnShuffleStage');
                    const grid = document.getElementById('learnGrid');
                    const floatLayer = document.getElementById('learnFloatLayer');
                    if(!stage || !grid || !floatLayer) return;

                    this._clearShuffleTimers();

                    this._state.isShuffling = true;

                    const cards = Array.from(grid.querySelectorAll('.learn-card'));
                    if(cards.length < 2) return;

                    const stageRect = stage.getBoundingClientRect();
                    const rects = cards.map(c => {
                        const r = c.getBoundingClientRect();
                        return {
                            left: r.left - stageRect.left + stage.scrollLeft,
                            top: r.top - stageRect.top + stage.scrollTop,
                            width: r.width,
                            height: r.height
                        };
                    });

                    // create floating clones
                    floatLayer.innerHTML = '';
                    const floats = cards.map((c, i) => {
                        const cardIdx = Number(c.dataset.cardIdx || i);
                        const item = this._bank(this._state.chapter)[cardIdx];

                        const f = document.createElement('div');
                        f.className = 'learn-float';
                        f.style.background = "radial-gradient(circle at 20% 20%, rgba(52,152,219,.22), transparent 55%), radial-gradient(circle at 80% 30%, rgba(46,204,113,.18), transparent 60%), radial-gradient(circle at 35% 85%, rgba(241,196,15,.18), transparent 60%), rgba(255,255,255,.92)";
                        f.style.left = rects[i].left + 'px';
                        f.style.top = rects[i].top + 'px';
                        f.style.width = rects[i].width + 'px';
                        f.style.height = rects[i].height + 'px';
                        f.style.transform = `rotate(${(Math.random()*6 - 3).toFixed(2)}deg) scale(1)`;

                                                const showFront = !this._state.closed[cardIdx];
                        if(showFront && item && item.hintImg){
                            const img = document.createElement('img');
                            img.src = item.hintImg;
                            img.alt = 'mufradat';
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '16px';
                            f.appendChild(img);
                        } else {
                            const mark = document.createElement('div');
                            mark.className = 'learn-back-mark';
                            mark.style.width = '100%';
                            mark.style.height = '100%';
                            mark.style.border = '3px dashed rgba(45,52,54,.18)';
                            mark.style.borderRadius = '16px';
                            mark.style.display = 'flex';
                            mark.style.alignItems = 'center';
                            mark.style.justifyContent = 'center';
                            mark.style.fontWeight = '1000';
                            mark.style.color = 'rgba(45,52,54,.55)';
                            mark.textContent = 'KARTU';
                            f.appendChild(mark);
                        }
floatLayer.appendChild(f);
                        return f;
                    });

                    // hide real grid visually (layout stays)
                    grid.style.opacity = '0';
                    grid.style.pointerEvents = 'none';

                    const stepMs = 600;
                    const steps = Math.max(4, Math.floor(totalMs / stepMs)); // intensitas sedang
                    const jitter = 12; // boleh overlap

                    // start with current order mapping from floats index -> order position
                    // We will compute a new permutation each step and at the end apply it to order.
                    let currentPos = Array.from({length: rects.length}, (_, i) => i);

                    const permute = (n) => {
                        const a = Array.from({length:n}, (_, i) => i);
                        for(let i=n-1;i>0;i--){
                            const j = Math.floor(Math.random()*(i+1));
                            [a[i],a[j]]=[a[j],a[i]];
                        }
                        return a;
                    };

                    const applyToOrder = (posMap) => {
                        // posMap: for each float index (which corresponds to card in current DOM order),
                        // the target position index it moves to. We convert that to a reordering of this._state.order.
                        // DOM order is same as this._state.order currently (renderGrid respects order).
                        const oldOrder = this._state.order.slice();
                        const newOrder = new Array(oldOrder.length);
                        for(let i=0;i<posMap.length;i++){
                            newOrder[posMap[i]] = oldOrder[i];
                        }
                        this._state.order = newOrder;
                    };

                    const tick = (k) => {
                        const p = permute(rects.length);

                        // shuffle SFX synced with movement (abaikan klik saat shuffling sudah di-handle)
                        this._shuffleSfxPulse(k, steps);
// move floats to new places
                        floats.forEach((f, i) => {
                            const targetIndex = p[i];
                            const base = rects[targetIndex];

                            const dx = (Math.random()*2 - 1) * jitter;
                            const dy = (Math.random()*2 - 1) * jitter;
                            const rot = (Math.random()*18 - 9);
                            const scale = 1 + (Math.random()*0.08);

                            f.style.left = (base.left + dx) + 'px';
                            f.style.top  = (base.top + dy) + 'px';
                            f.style.transform = `rotate(${rot.toFixed(2)}deg) scale(${scale.toFixed(3)})`;
                        });

                        // update mapping
                        currentPos = p;

                        if(k < steps - 1) {
                            this._shuffleTimers.push(setTimeout(() => tick(k+1), stepMs));
                        } else {
                            // settle: remove jitter and apply final order
                            this._shuffleTimers.push(setTimeout(() => {
                                floats.forEach((f, i) => {
                                    const targetIndex = currentPos[i];
                                    const base = rects[targetIndex];
                                    f.style.left = base.left + 'px';
                                    f.style.top  = base.top + 'px';
                                    f.style.transform = 'rotate(0deg) scale(1)';
                                });
                            }, stepMs));

                            this._shuffleTimers.push(setTimeout(() => {
                                applyToOrder(currentPos);
                                this._clearShuffleTimers();
                                grid.style.opacity = '1';
                                grid.style.pointerEvents = '';
                                this._renderGrid();
                                this._state.isShuffling = false;
                                this._stopShuffleAudio();
                                this._setStarted(true); // keep enabled
                            }, stepMs + 220));
                        }
                    };

                    // kick
                    requestAnimationFrame(() => {
                        // ensure floating clones are painted at the current (pre-shuffle) positions first
                        requestAnimationFrame(() => tick(0));
                    });
                },

                openCard: function(cardIdx) {
                    if(!this._state) return;
                    const bank = this._bank(this._state.chapter);
                    const item = bank[cardIdx];
                    if(!item) return;

                    // buka kartu dulu (animasi flip), baru tampilkan modal materi
                    this._flipSfx(true);
                    this._openCardFace(cardIdx);

                    this._state.activeCard = cardIdx;
                    this._state.audioCount = 0;
                    this._state.feedback = null;

                    const showModal = () => {
                        if(this._state.done[cardIdx]) {
                            this._state.phase = 'review';
                            this._renderModal();
                            this._showModal(true);
                            return;
                        }
                        this._state.phase = 'material';
                        this._renderModal();
                        this._showModal(true);
                    };

                    setTimeout(showModal, 520);
                },

                closeModal: function() {
                    const lm = document.getElementById('learnModal');
                    if(lm) lm.style.display = 'none';
                    // cancel speech just in case (avoid overlap)
                    try { if(window.speechSynthesis) window.speechSynthesis.cancel(); } catch(e) {}
                },

                _showModal: function(v) {
                    const lm = document.getElementById('learnModal');
                    if(lm) lm.style.display = v ? 'flex' : 'none';
                },

                playAudioId: function() {
                    if(!this._state) return;
                    const bank = this._bank(this._state.chapter);
                    const item = bank[this._state.activeCard];
                    if(!item) return;
                    AudioManager.playSFX('click');
                    AudioManager.playTTS(item.meaning || '', 'id-ID');
                },

                playAudio: function() {
                    if(!this._state) return;
                    const bank = this._bank(this._state.chapter);
                    const item = bank[this._state.activeCard];
                    if(!item) return;

                    AudioManager.playSFX('click');
                    AudioManager.playTTS(item.word || '', 'ar-EG');
                    this._state.audioCount = Math.min(99, (this._state.audioCount || 0) + 1);
                    this._renderModal();
                },

                primaryAction: function() {
                    if(!this._state) return;

                    if(this._state.phase === 'material') {
                        if((this._state.audioCount || 0) < 3) return;
                        this._state.phase = 'quiz1';
                        this._state.feedback = null;
                        this._buildQuiz('ar2id');
                        this._renderModal();
                        return;
                    }

                    if(this._state.phase === 'quiz1_fb') {
                        this._state.phase = 'quiz2';
                        this._state.feedback = null;
                        this._buildQuiz('id2ar');
                        this._renderModal();
                        return;
                    }

                    if(this._state.phase === 'quiz2_fb') {
                        this._completeCard();
                        return;
                    }

                    if(this._state.phase === 'review') {
                        this.closeModal();
                        return;
                    }
                },

                _buildQuiz: function(type) {
                    if(!this._state) return;
                    const bank = this._bank(this._state.chapter);
                    const idx = this._state.activeCard;
                    const item = bank[idx];

                    const want = 4;

                    // Helper: collect fallback items from all chapters (allowed by user).
                    const allItems = (() => {
                        const all = [];
                        try{
                            for(const chId in GameEngine.data.chapters){
                                const b = GameEngine.data.chapters[chId].bank || [];
                                for(const it of b) all.push(it);
                            }
                        }catch(e){}
                        return all;
                    })();

                    const normalize = (s) => (s || '').toString().trim();

                    // pick field based on quiz type
                    const pickText = (it) => {
                        if(type === 'ar2id') return normalize(it.meaning);
                        return normalize(it.word);
                    };

                    const correctText = (type === 'ar2id') ? normalize(item.meaning) : normalize(item.word);

                    const opts = [];
                    const seen = new Set();

                    const pushOpt = (txt, isCorrect) => {
                        const t = normalize(txt);
                        if(!t) return false;
                        if(seen.has(t)) return false;
                        seen.add(t);
                        opts.push({ text: t, isCorrect: !!isCorrect });
                        return true;
                    };

                    // correct always included
                    pushOpt(correctText, true);

                    // Prepare chapter pool (excluding idx)
                    const chapterPool = bank.map((_, i) => i).filter(i => i !== idx);
                    for(let i = chapterPool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [chapterPool[i], chapterPool[j]] = [chapterPool[j], chapterPool[i]];
                    }

                    // Fill distractors from same chapter first
                    for(const i of chapterPool){
                        if(opts.length >= want) break;
                        const t = pickText(bank[i]);
                        if(t && t !== correctText) pushOpt(t, false);
                    }

                    // If still not enough, fall back to all chapters
                    if(opts.length < want){
                        // shuffle allItems lightly
                        const pool = allItems.slice();
                        for(let i = pool.length - 1; i > 0; i--){
                            const j = Math.floor(Math.random() * (i + 1));
                            [pool[i], pool[j]] = [pool[j], pool[i]];
                        }
                        for(const it of pool){
                            if(opts.length >= want) break;
                            if(!it) continue;
                            const t = pickText(it);
                            if(t && t !== correctText) pushOpt(t, false);
                        }
                    }

                    // Shuffle options
                    for(let i = opts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [opts[i], opts[j]] = [opts[j], opts[i]];
                    }
                    const correctIndex = opts.findIndex(o => o.isCorrect);

                    if(type === 'ar2id') {
                        this._state.quiz = {
                            type,
                            prompt: item.word,      // Arab prompt (text)
                            options: opts.slice(0, want),
                            correctIndex
                        };
                    } else {
                        this._state.quiz = {
                            type,
                            prompt: item.meaning,   // Indonesia prompt (text)
                            options: opts.slice(0, want),
                            correctIndex
                        };
                    }
                },

                answer: function(optIdx) {
                    if(!this._state || !this._state.quiz) return;
                    const q = this._state.quiz;

                    const chosen = q.options[optIdx];
                    const isCorrect = !!(chosen && chosen.isCorrect);

                    // scoring: record correctness per-card per-quiz (q[cardIdx][0|1])
                    try {
                        const cIdx = this._state.activeCard;
                        const qIdx = (this._state.phase === 'quiz1') ? 0 : ((this._state.phase === 'quiz2') ? 1 : null);
                        if(typeof cIdx === 'number' && cIdx >= 0 && cIdx < 6 && (qIdx === 0 || qIdx === 1)) {
                            if(!Array.isArray(this._state.q) || this._state.q.length < 6) this._state.q = Array.from({length:6}, () => [null, null]);
                            if(!Array.isArray(this._state.q[cIdx])) this._state.q[cIdx] = [null, null];
                            this._state.q[cIdx][qIdx] = isCorrect ? 1 : 0;
                            this._save(this._state.chapter, this._state.done, this._state.q);

                            // progress scoring: update learn score (0..100) on every answered quiz
                            try {
                                const totalQ = 12;
                                let answered = 0, correct = 0;
                                for(let i=0;i<6;i++){
                                    const row = (this._state.q && this._state.q[i]) ? this._state.q[i] : null;
                                    if(row && row.length >= 2){
                                        for(let j=0;j<2;j++){
                                            const v = row[j];
                                            if(v === 0 || v === 1){
                                                answered++;
                                                if(v === 1) correct++;
                                            }
                                        }
                                    }
                                }
                                const learnScore = Math.round((correct / totalQ) * 100);
                                if(GameEngine && GameEngine.ChapterReport && GameEngine.ChapterReport.recordLearn){
                                    GameEngine.ChapterReport.recordLearn(this._state.chapter, learnScore, answered, correct, totalQ);
                                }
                            } catch(e) {}
                        }
                    } catch(e) {}

                    AudioManager.playSFX(isCorrect ? 'correct' : 'wrong');

                    // Build correct text for display
                    const correctText = q.options[q.correctIndex] ? q.options[q.correctIndex].text : '';

                    this._state.feedback = { isCorrect, correctText };

                    if(this._state.phase === 'quiz1') this._state.phase = 'quiz1_fb';
                    else if(this._state.phase === 'quiz2') this._state.phase = 'quiz2_fb';

                    this._renderModal();
                },

                _completeCard: function() {
                    if(!this._state) return;
                    const ch = this._state.chapter;
                    const idx = this._state.activeCard;

                    this._state.done[idx] = 1;
                    // reward: kartu selesai selalu terbuka
                    if(this._state.closed) this._state.closed[idx] = false;
                    this._save(ch, this._state.done, this._state.q);

                    this.closeModal();
                    this._renderGrid();
                    this._renderProgress();

                    // Auto-shuffle wajib setelah 1 kartu selesai (feedback A: jeda singkat)
                    // Kartu selesai tetap terbuka dan ikut berpindah; kartu lain tetap tertutup
                    const doneCount = this._state.done.filter(Boolean).length;
                    if(doneCount < 6){
                        setTimeout(() => {
                            if(!this._state || !this._state.started) return;
                            if(this._state.isShuffling) return;
                            this._doShuffleHybrid(4000);
                        }, 520);
                    }
},

                _renderModal: function() {
                    if(!this._state) return;

                    const bank = this._bank(this._state.chapter);
                    const idx = this._state.activeCard;
                    const item = bank[idx];
                    if(!item) return;

                    const titleEl = document.getElementById('learnModalTitle');
                    const bodyEl = document.getElementById('learnModalBody');
                    const primaryBtn = document.getElementById('learnModalPrimary');
                    if(!bodyEl || !primaryBtn) return;

                    const imgHtml = item.hintImg ? `<img class="learn-mufradat-img" src="${item.hintImg}" alt="mufradat">` : '';

                    if(this._state.phase === 'review') {
                        if(titleEl) titleEl.textContent = 'Review Materi';
                        bodyEl.innerHTML = `
                            ${imgHtml}
                            <div class="learn-ar">${item.word || ''}</div>
                            <div class="learn-id">${item.meaning || ''}</div>
                            <div class="learn-audio-req">Audio boleh diputar (opsional).</div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
                                <button class="btn" style="min-width:180px;" onclick="GameEngine.LearnMode.playAudio()">ðŸ”Š Audio Arab</button>
                                <button class="btn" style="min-width:180px; background:var(--secondary);" onclick="GameEngine.LearnMode.playAudioId()">ðŸ”Š Audio Indonesia</button>
                            </div>
                        `;
                        primaryBtn.textContent = 'Tutup';
                        primaryBtn.disabled = false;
                        return;
                    }

                    if(this._state.phase === 'material') {
                        if(titleEl) titleEl.textContent = 'Materi';
                        const c = (this._state.audioCount || 0);
                        const need = Math.max(0, 3 - c);
                        bodyEl.innerHTML = `
                            ${imgHtml}
                            <div class="learn-ar">${item.word || ''}</div>
                            <div class="learn-id">${item.meaning || ''}</div>
                            <div class="learn-audio-req">
                                Wajib dengar audio <b>3x</b> untuk lanjut. 
                                <br>Sudah: <b>${Math.min(3,c)}/3</b> ${need ? `(kurang ${need})` : '(cukup)'}.
                            </div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
                                <button class="btn" style="min-width:180px;" onclick="GameEngine.LearnMode.playAudio()">ðŸ”Š Audio Arab</button>
                                <button class="btn" style="min-width:180px; background:var(--secondary);" onclick="GameEngine.LearnMode.playAudioId()">ðŸ”Š Audio Indonesia</button>
                            </div>
                        `;
                        primaryBtn.textContent = (c >= 3) ? 'Mulai Latihan' : 'Putar Audio 3x';
                        primaryBtn.disabled = (c < 3);
                        return;
                    }

                    if(this._state.phase === 'quiz1' || this._state.phase === 'quiz2') {
                        const q = this._state.quiz;
                        if(!q) return;

                        const isArPrompt = (q.type === 'ar2id');
                        if(titleEl) titleEl.textContent = 'Latihan Ringan';

                        const promptHtml = isArPrompt
                            ? `<div class="learn-quiz-title">Arab âžœ Indonesia</div><div class="learn-ar">${q.prompt}</div>`
                            : `<div class="learn-quiz-title">Indonesia âžœ Arab</div><div class="learn-id" style="font-size:1.35rem;">${q.prompt}</div>`;

                        const optionsHtml = q.options.map((o, i) => {
                            const cls = isArPrompt ? '' : ' arabic';
                            const btnText = isArPrompt ? o.text : `<span style="font-family: var(--font-arabic); font-size:2.2rem; font-weight:1000; direction:rtl; unicode-bidi:plaintext;">${o.text}</span>`;
                            return `<button class="learn-quiz-btn${cls}" onclick="GameEngine.LearnMode.answer(${i})">${btnText}</button>`;
                        }).join('');

                                                const audioBtnHtml = isArPrompt
                            ? `<button class="btn" style="min-width:180px;" onclick="GameEngine.LearnMode.playAudio()">ðŸ”Š Audio Arab</button>`
                            : `<button class="btn" style="min-width:180px; background:var(--secondary);" onclick="GameEngine.LearnMode.playAudioId()">ðŸ”Š Audio Indonesia</button>`;

                        bodyEl.innerHTML = `
                            ${promptHtml}
                            ${imgHtml}
                            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
                                ${audioBtnHtml}
                            </div>
                            <div class="learn-quiz-grid">${optionsHtml}</div>
                        `;
                        primaryBtn.textContent = 'Pilih Jawaban';
                        primaryBtn.disabled = true;
                        return;
                    }

                    if(this._state.phase === 'quiz1_fb' || this._state.phase === 'quiz2_fb') {
                        const q = this._state.quiz;
                        const fb = this._state.feedback || {isCorrect:false, correctText:''};
                        if(titleEl) titleEl.textContent = 'Hasil';

                        const msg = fb.isCorrect ? 'Benar.' : 'Salah, ini jawabannya.';
                        const msgTitle = fb.isCorrect ? 'âœ… Benar' : 'âŒ Salah';
                        const correctLine = fb.isCorrect ? '' : `<div style="margin-top:8px; font-weight:900; color:#2d3436;">Jawaban benar: <b>${fb.correctText}</b></div>`;

                        bodyEl.innerHTML = `
                            ${imgHtml}
                            <div class="learn-ar">${item.word || ''}</div>
                            <div class="learn-id">${item.meaning || ''}</div>
                            <div style="margin-top:10px; font-weight:1000; color:#2d3436; font-size:1.15rem;">${msgTitle}</div>
                            <div style="margin-top:6px; font-weight:800; color:#555; line-height:1.35;">${msg}</div>
                            ${correctLine}
                        `;
                        primaryBtn.textContent = 'Lanjut';
                        primaryBtn.disabled = false;
                        return;
                    }
                }
            },

            arrangePreloadHintImages: function(items) {
                try {
                    const cache = this._arrangeHintCache || (this._arrangeHintCache = {});
                    if(!Array.isArray(items)) return;
                    items.forEach(it => {
                        const url = it && it.hintImg;
                        if(!url) return;
                        if(cache[url]) return;
                        const im = new Image();
                        im.decoding = 'async';
                        im.src = url;
                        cache[url] = im;
                    });
                } catch(e) { /* noop */ }
            },

                        startArrangeChapter: function(chapterId) {
                AudioManager.playSFX('click');
                // safety: ensure learn view is not visible (avoid layout overlap)
                const learn = document.getElementById('arrangeLearnView');
                if(learn) learn.style.display = 'none';
                const lm = document.getElementById('learnModal');
                if(lm) lm.style.display = 'none';

                const bank = (this.arrangeBank && this.arrangeBank[chapterId]) ? this.arrangeBank[chapterId] : [];
                const fb = document.getElementById('arrangeFeedback');
                if(!bank.length) {
                    if(fb) fb.textContent = 'Bank kata untuk chapter ini belum diisi.';
                    return;
                }

                // preload semua hint gambar chapter (anti flicker)
                this.arrangePreloadHintImages(bank);

                // 1 chapter = 6 soal (atau kurang jika bank belum cukup)
                const targetCount = Math.min(6, bank.length);

                // pilih index soal untuk sesi ini (unik)
                let indices = [];
                if(bank.length <= targetCount) {
                    indices = Array.from({length: bank.length}, (_, i) => i);
                } else {
                    const pool = Array.from({length: bank.length}, (_, i) => i);
                    for(let i = pool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [pool[i], pool[j]] = [pool[j], pool[i]];
                    }
                    indices = pool.slice(0, targetCount);
                }

                // acak urutan main queue
                for(let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }

                // init state (isolated)
                this.state.arrange = {
                    chapter: chapterId,
                    // queues (index bank)
                    mainQueue: indices.slice(),
                    remedialQueue: [],
                    currentId: null,
                    currentSource: 'main',

                    // per soal
                    answerParts: [],
                    currentQ: null,
                    wrongAttempts: 0,
                    helpShown: false,

                    // session metrics
                    session: {
                        totalWords: targetCount,
                        mastered: 0,
                        score: 0,
                        maxScore: targetCount * 10,
                        totalChecks: 0,
                        correctChecks: 0,
                        bestStreak: 0
                    },

                    // gameplay streak
                    streak: 0,
                    // set mastered ids
                    masteredIds: {}
                };

                // chapter label
                const lbl = document.getElementById('arrangeChapterLabel');
                if(lbl) lbl.textContent = (chapterId === 'ch1') ? '1' : '2';

                // view: play
                const sel = document.getElementById('arrangeSelectView');
                const play = document.getElementById('arrangePlayView');
                if(sel) sel.style.display = 'none';
                if(play) play.style.display = '';

                // reset overlays/help
                this.arrangeHideHelp(true);
                this.arrangeHideReveal(true);

                // load overall stats (persist)
                this.arrangeEnsureStats(chapterId);

                // start first question
                this.arrangeNextQuestion();
            },

            arrangeEnsureStats: function(chapterId) {
                const key = `arrangeStats_${chapterId}`;
                let stats = null;
                try { stats = JSON.parse(localStorage.getItem(key) || 'null'); } catch(e) { stats = null; }
                if(!stats || typeof stats !== 'object') {
                    stats = { played: 0, correct: 0, wrong: 0, bestStreak: 0 };
                } else {
                    stats.played = Number(stats.played || 0);
                    stats.correct = Number(stats.correct || 0);
                    stats.wrong = Number(stats.wrong || 0);
                    stats.bestStreak = Number(stats.bestStreak || 0);
                }
                localStorage.setItem(key, JSON.stringify(stats));
                this.state.arrange.stats = stats;
                this.arrangeRenderStats();
            },

            arrangeSaveStats: function() {
                if(!this.state.arrange) return;
                const chapterId = this.state.arrange.chapter;
                const key = `arrangeStats_${chapterId}`;
                localStorage.setItem(key, JSON.stringify(this.state.arrange.stats || { played:0, correct:0, wrong:0, bestStreak:0 }));
                this.arrangeRenderStats();
            },

            arrangeRenderStats: function() {
                const a = this.state.arrange;
                if(!a) return;

                // progress
                const prog = document.getElementById('arrangeProgressLine');
                if(prog && a.session) {
                    const mastered = Number(a.session.mastered || 0);
                    const total = Number(a.session.totalWords || 0);
                    const rem = (a.remedialQueue && a.remedialQueue.length) ? a.remedialQueue.length : 0;
                    prog.textContent = `Progress: ${mastered}/${total}` + (rem ? ` | Remedial: ${rem}` : '');
                }

                // stats line (session)
                const line = document.getElementById('arrangeStatsLine');
                if(line && a.session) {
                    const score = Math.max(0, Number(a.session.score || 0));
                    const maxScore = Math.max(0, Number(a.session.maxScore || 0));
                    const totalChecks = Math.max(0, Number(a.session.totalChecks || 0));
                    const correctChecks = Math.max(0, Number(a.session.correctChecks || 0));
                    const acc = totalChecks ? Math.round((correctChecks / totalChecks) * 100) : 0;
                    const best = Math.max(Number(a.session.bestStreak || 0), Number((a.stats && a.stats.bestStreak) ? a.stats.bestStreak : 0));
                    line.textContent = `Skor: ${score}/${maxScore} | Akurasi: ${acc}% | Best Streak: ${best}`;
                } else if(line && a.stats) {
                    const s = a.stats;
                    line.textContent = `Benar: ${s.correct} | Salah: ${s.wrong} | Best Streak: ${s.bestStreak}`;
                }

                // streak (live)
                const st = document.getElementById('arrangeStreak');
                if(st) st.textContent = String(a.streak || 0);
            },



            // ===== Susun Huruf: bantuan gambar (inline SVG, aman & offline) =====
            arrangeHintSvgs: {
                school: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <rect x="12" y="22" width="40" height="30" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M20 22v-8h24v8" fill="none" stroke="black" stroke-width="3"/>
  <path d="M28 52V38h8v14" fill="none" stroke="black" stroke-width="3"/>
  <path d="M18 30h10M36 30h10M18 38h10M36 38h10" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                mosque: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M14 52V28h36v24" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 18c6 0 10 5 10 10H22c0-5 4-10 10-10Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 8v10" fill="none" stroke="black" stroke-width="3"/>
  <path d="M26 52V40h12v12" fill="none" stroke="black" stroke-width="3"/>
  <path d="M10 52h44" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                book: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M14 18h18c4 0 6 2 6 6v30c-2-2-4-3-8-3H14V18Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M50 18H32c-4 0-6 2-6 6v30c2-2 4-3 8-3h16V18Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 18v36" fill="none" stroke="black" stroke-width="2"/>
</svg>`,
                pen: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M16 48l4 4 30-30-4-4-30 30Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M14 50l-2 8 8-2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M42 18l4-4 8 8-4 4" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                car: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M16 38l6-12h20l6 12" fill="none" stroke="black" stroke-width="3"/>
  <rect x="12" y="38" width="40" height="10" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <circle cx="20" cy="50" r="4" fill="none" stroke="black" stroke-width="3"/>
  <circle cx="44" cy="50" r="4" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                airport: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M32 10l6 20 16 8-2 4-16-6-4 18h-6l-4-18-16 6-2-4 16-8 6-20Z" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                garden: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M32 50V28" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 28c-10 0-16-8-16-16 10 0 16 8 16 16Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 28c10 0 16-8 16-16-10 0-16 8-16 16Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M18 52h28" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                library: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <rect x="14" y="14" width="10" height="38" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <rect x="27" y="18" width="10" height="34" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <rect x="40" y="16" width="10" height="36" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M12 52h40" fill="none" stroke="black" stroke-width="3"/>
</svg>`
            , 
                where: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M32 58s16-14 16-28a16 16 0 1 0-32 0c0 14 16 28 16 28Z" fill="none" stroke="black" stroke-width="3"/>
  <path d="M28 26c0-3 2-5 5-5 3 0 5 2 5 5 0 4-5 4-5 9" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
  <circle cx="33" cy="43" r="2" fill="black"/>
</svg>`,
                here: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M32 58s14-12 14-26a14 14 0 1 0-28 0c0 14 14 26 14 26Z" fill="none" stroke="black" stroke-width="3"/>
  <circle cx="32" cy="32" r="3" fill="black"/>
  <path d="M12 56h40" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                there: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M22 54c0-10 20-10 20-20 0-8-6-14-14-14S14 26 14 34" fill="none" stroke="black" stroke-width="3"/>
  <path d="M40 54c0-10 12-10 12-20 0-6-4-10-10-10" fill="none" stroke="black" stroke-width="3"/>
  <path d="M10 54h44" fill="none" stroke="black" stroke-width="3"/>
  <path d="M46 10l8 0" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
</svg>`,
                above: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M32 10v26" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M24 18l8-8 8 8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M14 54h36" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <rect x="22" y="36" width="20" height="14" rx="2" fill="none" stroke="black" stroke-width="3"/>
</svg>`,
                below: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <path d="M14 10h36" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <rect x="22" y="14" width="20" height="14" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 28v26" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M24 46l8 8 8-8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,
                beside: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <rect x="10" y="18" width="16" height="28" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <rect x="38" y="18" width="16" height="28" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M28 32h8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M34 26l6 6-6 6" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,
                front: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <rect x="12" y="20" width="18" height="24" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 32h18" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M44 24l8 8-8 8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,
                back: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <rect x="34" y="20" width="18" height="24" rx="2" fill="none" stroke="black" stroke-width="3"/>
  <path d="M32 32H14" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M20 24l-8 8 8 8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,
                from: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="14" cy="32" r="4" fill="black"/>
  <path d="M20 32h28" fill="none" stroke="black" stroke-width="4" stroke-linecap="round"/>
  <path d="M40 24l8 8-8 8" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,
                why: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="22" fill="none" stroke="black" stroke-width="3"/>
  <path d="M27 26c0-3 2-6 6-6 4 0 6 3 6 6 0 6-6 6-6 12" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
  <circle cx="33" cy="46" r="2" fill="black"/>
  <path d="M14 14l8 0" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
</svg>`,
                who: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="24" r="10" fill="none" stroke="black" stroke-width="3"/>
  <path d="M14 54c2-10 12-16 18-16s16 6 18 16" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
</svg>`,
                how: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="14" cy="18" r="3" fill="black"/>
  <circle cx="32" cy="32" r="3" fill="black"/>
  <circle cx="50" cy="46" r="3" fill="black"/>
  <path d="M16 18h10" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
  <path d="M35 32h10" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
  <path d="M24 22l6 6" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
  <path d="M42 36l6 6" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/>
</svg>`
            },

            arrangeResolveHintImg: function(q) {
                if(!q) return null;
                if(q.hintImg) return q.hintImg; // allow override if user later supplies real assets
                const t = q.hintType;
                if(!t || !this.arrangeHintSvgs || !this.arrangeHintSvgs[t]) return null;
                return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(this.arrangeHintSvgs[t]);
            },

arrangeHideHelp: function(silent) {
    const ov = document.getElementById('arrangeHelpOverlay');
    const img = document.getElementById('arrangeHelpOverlayImg');
    const note = document.getElementById('arrangeHelpOverlayNote');
    if(ov) ov.style.display = 'none';
    if(img) img.src = '';
    if(note) note.textContent = '';
    if(!silent) AudioManager.playSFX('click');
},

arrangeShowHelp: function() {
    const a = this.state.arrange;
    if(!a || !a.currentQ) return;

    const ov = document.getElementById('arrangeHelpOverlay');
    const img = document.getElementById('arrangeHelpOverlayImg');
    const note = document.getElementById('arrangeHelpOverlayNote');
    if(!ov) return;

    const src = this.arrangeResolveHintImg(a.currentQ);
    if(src) {
        if(img) { img.style.display = 'block'; img.src = src; }
        if(note) note.textContent = '';
    } else {
        if(img) { img.style.display = 'none'; img.src = ''; }
        if(note) note.textContent = 'Bantuan gambar untuk soal ini belum tersedia.';
    }

    ov.style.display = 'flex';
},

            // ===== Susun Huruf: reveal jawaban & flow mutqin =====
            arrangeHideReveal: function(force) {
                const ov = document.getElementById('arrangeRevealOverlay');
                if(ov) ov.style.display = 'none';
                const img = document.getElementById('arrangePraiseImg');
                if(img) {
                    img.onload = null;
                    img.onerror = null;
                    img.style.opacity = '0';
                    img.style.display = 'none';
                    img.removeAttribute('src');
                    img.setAttribute('src','');
                }
                const w = document.getElementById('arrangeRevealWord');
                if(w) w.textContent = '';
                if(!force) AudioManager.playSFX('click');
                // re-enable buttons if needed
                this.arrangeSetPlayEnabled(true);
            },
            arrangeStopTTS: function(silent) {
                try {
                    if(window.speechSynthesis) window.speechSynthesis.cancel();
                } catch(e) {}
                const a = this.state && this.state.arrange;
                if(a && a._praiseTtsTimer) {
                    clearTimeout(a._praiseTtsTimer);
                    a._praiseTtsTimer = null;
                }
            },

            arrangeSpeakMufradat: function(arText, idText) {
                if(!('speechSynthesis' in window)) return;
                if(!arText && !idText) return;

                // Pastikan tidak tumpang tindih
                try { window.speechSynthesis.cancel(); } catch(e) {}

                const synth = window.speechSynthesis;
                const voices = synth.getVoices ? synth.getVoices() : [];

                const pickVoice = (prefixes) => {
                    if(!voices || !voices.length) return null;
                    const lower = (s) => String(s||'').toLowerCase();
                    for(const p of prefixes) {
                        const v = voices.find(v => lower(v.lang).startsWith(lower(p)));
                        if(v) return v;
                    }
                    return null;
                };

                const speakUtter = (text, lang, voicePref) => {
                    return new Promise((resolve) => {
                        if(!text) return resolve();
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = lang;
                        const v = pickVoice(voicePref);
                        if(v) u.voice = v;
                        u.rate = 0.95;
                        u.pitch = 1.0;
                        u.onend = () => resolve();
                        u.onerror = () => resolve();
                        synth.speak(u);
                    });
                };

                // Rantai: Arab dulu, lalu Indonesia
                (async () => {
                    await speakUtter(arText, 'ar', ['ar-SA','ar','ar-EG','ar-AE']);
                    await new Promise(r => setTimeout(r, 220));
                    await speakUtter(idText, 'id-ID', ['id-ID','id','ms-ID','ms']);
                })();
            },

            arrangeShowPraise: function(item) {
                const a = this.state.arrange;
                if(!a || !item) return;
                const ov = document.getElementById('arrangePraiseOverlay');
                if(!ov) return;

                // Simpan item terakhir untuk tombol replay
                a._praiseItem = item;

                const t = document.getElementById('arrangePraiseTitle');
                if(t) t.textContent = 'Ù…ÙÙ…Ù’ØªÙŽØ§Ø²!';

                const ar = document.getElementById('arrangePraiseAr');
                if(ar) ar.textContent = item.word || 'â€”';

                const id = document.getElementById('arrangePraiseId');
                if(id) id.textContent = item.meaning || '';

                const img = document.getElementById('arrangePraiseImg');
                const imgUrl = item.hintImg || '';

                // Anti "flash gambar sebelumnya":
                // 1) kosongkan dulu state img
                // 2) tampilkan overlay
                // 3) set src di frame berikutnya, lalu fade-in saat onload
                if(img) {
                    // token untuk menghindari race onload lama
                    a._praiseImgToken = (a._praiseImgToken || 0) + 1;
                    const token = a._praiseImgToken;

                    a._praiseImgPendingUrl = imgUrl;
                    a._praiseImgPendingToken = token;

                    img.onload = null;
                    img.onerror = null;

                    // clear dulu supaya tidak sempat render gambar sebelumnya
                    img.style.opacity = '0';
                    img.style.display = imgUrl ? 'block' : 'none';
                    img.removeAttribute('src');
                    img.setAttribute('src', '');

                    if(imgUrl) {
                        img.onerror = () => {
                            if(token !== a._praiseImgToken) return;
                            img.style.display = 'none';
                        };
                        img.onload = () => {
                            if(token !== a._praiseImgToken) return;
                            // pastikan 1 frame untuk apply opacity transition
                            requestAnimationFrame(() => { img.style.opacity = '1'; });
                        };
                    }
                }
                ov.style.display = 'flex';

                // Set src setelah overlay tampil (hindari flash gambar sebelumnya)
                if(img && imgUrl) {
                    requestAnimationFrame(() => {
                        if(a && (a._praiseImgPendingToken === a._praiseImgToken)) {
                            img.src = imgUrl;
                        }
                    });
                }

                // lock input di belakang
                this.arrangeSetPlayEnabled(false);

                // sequencing audio: SFX benar sudah diputar, mulai TTS setelah jeda aman
                this.arrangeStopTTS(true);
                a._praiseTtsTimer = setTimeout(() => {
                    this.arrangeSpeakMufradat(item.word || '', item.meaning || '');
                }, 850);
            },

            arrangeReplayPraiseAudio: function() {
                const a = this.state.arrange;
                if(!a || !a._praiseItem) return;
                this.arrangeStopTTS(true);
                // tidak perlu tunggu SFX; replay langsung
                this.arrangeSpeakMufradat(a._praiseItem.word || '', a._praiseItem.meaning || '');
            },

            arrangeHidePraise: function(proceed) {
                if(!proceed) return;
                const ov = document.getElementById('arrangePraiseOverlay');
                if(ov) ov.style.display = 'none';
                const img = document.getElementById('arrangePraiseImg');
                if(img) {
                    img.onload = null;
                    img.onerror = null;
                    img.style.opacity = '0';
                    img.style.display = 'none';
                    img.removeAttribute('src');
                    img.setAttribute('src','');
                }
                this.arrangeStopTTS(true);
                this.arrangeSetPlayEnabled(true);
                if(proceed) {
                    // lanjut soal berikutnya hanya setelah user siap
                    this.arrangeNextQuestion();
                } else {
                    // klik backdrop: tetap diam (belajar dulu)
                }
            },


            arrangeRevealAnswer: function(expectedWord, noteText) {
                const ov = document.getElementById('arrangeRevealOverlay');
                const w = document.getElementById('arrangeRevealWord');
                const n = document.getElementById('arrangeRevealNote');
                if(w) w.textContent = expectedWord;
                if(n && noteText) n.textContent = noteText;
                if(ov) ov.style.display = 'flex';
                this.arrangeSetPlayEnabled(false);
            },

            arrangeRevealContinue: function() {
                AudioManager.playSFX('click');
                this.arrangeHideReveal(true);
                this.arrangeNextQuestion();
            },

            arrangeSetPlayEnabled: function(enabled) {
                const ids = ['arrangeBtnCheck'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.disabled = !enabled || (id === 'arrangeBtnCheck' && this.state.arrange && this.state.arrange.answerParts && this.state.arrange.answerParts.includes(null));
                });
                const bank = document.getElementById('arrangePartsBank');
                if(bank) {
                    const btns = bank.querySelectorAll('button');
                    btns.forEach(b => b.disabled = !enabled || b.disabled);
                }
            },

            arrangeApplyFailAndReveal: function(prefixText) {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;

                // penalti score
                if(a.session) {
                    a.session.score = Math.max(0, Number(a.session.score || 0) - 5);
                }

                a.streak = 0;

                // masuk remedial (jika belum mastered)
                const id = String(a.currentId);
                if(!a.masteredIds[id]) {
                    if(!a.remedialQueue) a.remedialQueue = [];
                    if(a.remedialQueue.indexOf(a.currentId) === -1) {
                        a.remedialQueue.push(a.currentId);
                    }
                }

                // tampil jawaban + render slot jawaban yang benar
                const expected = (a.currentParts || []).join('');
                const slots = document.getElementById('arrangeSlots');
                if(slots) {
                    // isi slot sesuai jawaban benar (biar langsung terlihat)
                    for(let i = 0; i < a.currentParts.length; i++) {
                        if(slots.children[i]) slots.children[i].textContent = a.currentParts[i];
                    }
                }

                const fb = document.getElementById('arrangeFeedback');
                if(fb) fb.textContent = (prefixText ? (prefixText + ' ') : '') + 'Soal ini masuk remedial. Perhatikan jawaban benar.';
                this.arrangeSaveStats();
                this.arrangeRenderStats();

                AudioManager.playSFX('impact');
                this.arrangeRevealAnswer(expected, 'Perhatikan jawaban benar. Setelah siap, klik Lanjut.');
            },

            arrangeFinishChapter: function() {
                const a = this.state.arrange;
                if(!a || !a.session) return;

                // reset progres belajar untuk chapter ini
                try { if(this.LearnMode && typeof this.LearnMode.resetChapter === 'function') this.LearnMode.resetChapter(a.chapter); } catch(e) {}

                // victory SFX
                AudioManager.playSFX('grandFanfare');

                // render victory UI
                const score = Math.max(0, Number(a.session.score || 0));
                const maxScore = Math.max(0, Number(a.session.maxScore || 0));
                const totalChecks = Math.max(0, Number(a.session.totalChecks || 0));
                const correctChecks = Math.max(0, Number(a.session.correctChecks || 0));
                const acc = totalChecks ? Math.round((correctChecks / totalChecks) * 100) : 0;
                const best = Math.max(Number(a.session.bestStreak || 0), Number((a.stats && a.stats.bestStreak) ? a.stats.bestStreak : 0));

                // scoring: normalize Arrange score to 0-100
                const arrangeScore100 = maxScore ? Math.round((score / maxScore) * 100) : 0;

                // read Learn score (last) from raport store; if belum belajar, dianggap 0
                let learnLast = 0;
                try {
                    if(this.ChapterReport && typeof this.ChapterReport.get === 'function') {
                        const r = this.ChapterReport.get(a.chapter);
                        learnLast = (r && r.learn && typeof r.learn.last === 'number') ? r.learn.last : 0;
                    }
                } catch(e) { learnLast = 0; }

                // record Arrange + Final (Bobot B: 40/60)
                let finalRec = { learn: learnLast, arrange: arrangeScore100, final: 0, bestFinal: 0 };
                try {
                    if(this.ChapterReport && typeof this.ChapterReport.recordArrangeAndFinal === 'function') {
                        finalRec = this.ChapterReport.recordArrangeAndFinal(a.chapter, arrangeScore100, learnLast);
                    } else {
                        finalRec.final = Math.round((0.4 * learnLast) + (0.6 * arrangeScore100));
                        finalRec.bestFinal = finalRec.final;
                    }
                } catch(e) {}

                const scoreEl = document.getElementById('arrangeVictoryScore');
                if(scoreEl) scoreEl.textContent = `${finalRec.final} / 100`;

                const metaEl = document.getElementById('arrangeVictoryMeta');
                if(metaEl) metaEl.innerHTML =
                    `Skor Akhir (High Score: <b>${finalRec.bestFinal}/100</b>)<br>Belajar: <b>${finalRec.learn}/100</b> | Susun: <b>${finalRec.arrange}/100</b><br>Akurasi: ${acc}% | Best Streak: ${best} | Total Cek: ${totalChecks}`;

                // persist last result (simple)
                try {
                    const key = `arrangeLastResult_${a.chapter}`;
                    localStorage.setItem(key, JSON.stringify({
                        at: Date.now(),
                        score, maxScore,
                        arrangeScore100,
                        learnLast: finalRec.learn,
                        finalScore100: finalRec.final,
                        acc, best, totalChecks
                    }));
                } catch(e) {}

                UIManager.showScreen('arrangeVictoryScreen');
            },

            arrangeVictoryDone: function() {
                AudioManager.playSFX('click');
                // kembali ke menu chapter (grid mode)
                UIManager.showScreen('chapterScreen');
            },

            arrangeRestartChapter: function() {
                const a = this.state.arrange;
                const ch = a ? a.chapter : 'ch1';
                this.startArrangeChapter(ch);
            },


            arrangeNextQuestion: function() {
                const a = this.state.arrange;
                const bank = (this.arrangeBank && this.arrangeBank[a.chapter]) ? this.arrangeBank[a.chapter] : [];
                if(!bank.length) {
                    const fb = document.getElementById('arrangeFeedback');
                    if(fb) fb.textContent = 'Bank kata untuk chapter ini belum diisi.';
                    return;
                }

                // kalau semua sudah mastered dan remedial kosong -> selesai
                if((a.session && a.session.mastered >= a.session.totalWords) && (!a.remedialQueue || a.remedialQueue.length === 0) && (!a.mainQueue || a.mainQueue.length === 0)) {
                    this.arrangeFinishChapter();
                    return;
                }

                // ambil next id: mainQueue dulu, lalu remedial
                let nextId = null;
                if(a.mainQueue && a.mainQueue.length) {
                    nextId = a.mainQueue.shift();
                    a.currentSource = 'main';
                } else if(a.remedialQueue && a.remedialQueue.length) {
                    nextId = a.remedialQueue.shift();
                    a.currentSource = 'remedial';
                } else {
                    // fallback safety
                    this.arrangeFinishChapter();
                    return;
                }

                a.currentId = nextId;
                a.currentQ = bank[nextId];


                a.currentParts = this.splitArabicParts(a.currentQ.word || "");
                if((!a.currentParts || !a.currentParts.length) && a.currentQ.parts) a.currentParts = a.currentQ.parts.slice();
                a.answerParts = new Array(a.currentParts.length).fill(null);
                a.wrongAttempts = 0;
                a.helpShown = false;
                this.arrangeHideHelp(true);
                this.arrangeHideReveal(true);

                // render
                this.arrangeRenderQuestion();
            },

            
            arrangeRenderQuestion: function() {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;

                // feedback clear
                const fb = document.getElementById('arrangeFeedback');
                if(fb) fb.textContent = '';

                // slots
                const slots = document.getElementById('arrangeSlots');
                if(slots) {
                    slots.innerHTML = '';
                    for(let i = 0; i < a.currentParts.length; i++) {
                        const div = document.createElement('div');
                        div.className = 'arrange-slot' + (a.answerParts[i] ? ' filled' : '');
                        div.textContent = a.answerParts[i] ? a.answerParts[i].text : ' ';
                        div.onclick = () => this.arrangeUndoSlot(i);
                        slots.appendChild(div);
                    }
                }

                // parts bank (shuffled display)
                const bankEl = document.getElementById('arrangePartsBank');
                if(bankEl) {
                    bankEl.innerHTML = '';
                    const parts = (a.currentParts || []).map((p, idx) => ({ p, idx }));
                    // shuffle for display
                    for(let i = parts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [parts[i], parts[j]] = [parts[j], parts[i]];
                    }

                    parts.forEach((item) => {
                        const btn = document.createElement('button');
                        btn.className = 'arrange-part';
                        btn.type = 'button';
                        btn.textContent = item.p;
                        btn.dataset.partIndex = String(item.idx);
                        btn.onclick = () => this.arrangePickPart(btn, item.p);
                        bankEl.appendChild(btn);
                    });
                }

                // buttons state
                const checkBtn = document.getElementById('arrangeBtnCheck');
                if(checkBtn) checkBtn.disabled = true;

                this.arrangeRenderStats();
            },
            // --- Woosh SFX (WebAudio, no external file) ---
            _wooshCtx: null,
            _wooshLastAt: 0,
            playWoosh: function() {
                try {
                    const now = (window.performance && performance.now) ? performance.now() : Date.now();
                    if(now - (this._wooshLastAt||0) < 160) return; // rate-limit
                    this._wooshLastAt = now;

                    // Reuse the main AudioContext for maximum compatibility (mobile-friendly)
                    if (typeof AudioManager !== 'undefined' && AudioManager.ensureContext) {
                        AudioManager.ensureContext();
                    }
                    let ctx = (typeof AudioManager !== 'undefined' && AudioManager.ctx) ? AudioManager.ctx : null;
                    if(!ctx) {
                        const AC = window.AudioContext || window.webkitAudioContext;
                        if(!AC) return;
                        if(!this._wooshCtx) this._wooshCtx = new AC();
                        ctx = this._wooshCtx;
                        if(ctx.state === 'suspended') ctx.resume().catch(()=>{});
                    }

                    const t0 = ctx.currentTime;
                    const dur = 0.26;

                    // ---- Airy whoosh (noise + swept filter) ----
                    const frames = Math.max(1, Math.floor(ctx.sampleRate * dur));
                    const buf = ctx.createBuffer(1, frames, ctx.sampleRate);
                    const data = buf.getChannelData(0);
                    for(let i=0;i<frames;i++){
                        // slightly shaped noise
                        const r = (Math.random()*2 - 1);
                        data[i] = r * 1.00;
                    }
                    const noise = ctx.createBufferSource();
                    noise.buffer = buf;

                    const bp = ctx.createBiquadFilter();
                    bp.type = 'bandpass';
                    bp.Q.setValueAtTime(0.8, t0);
                    bp.frequency.setValueAtTime(360, t0);
                    bp.frequency.exponentialRampToValueAtTime(2600, t0 + dur);

                    const hp = ctx.createBiquadFilter();
                    hp.type = 'highpass';
                    hp.frequency.setValueAtTime(160, t0);

                    const g = ctx.createGain();
                    g.gain.setValueAtTime(0.0001, t0);
                    g.gain.exponentialRampToValueAtTime(1.35, t0 + 0.025);
                    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

                    // Optional stereo pan sweep to feel "swishy"
                    let panNode = null;
                    if (ctx.createStereoPanner) {
                        panNode = ctx.createStereoPanner();
                        panNode.pan.setValueAtTime(-0.35, t0);
                        panNode.pan.linearRampToValueAtTime(0.35, t0 + dur);
                    }

                    // ---- Cute "whoop" chirp layer (playful, not musical) ----
                    const osc1 = ctx.createOscillator();
                    osc1.type = 'triangle';
                    osc1.frequency.setValueAtTime(820, t0);
                    osc1.frequency.exponentialRampToValueAtTime(1650, t0 + 0.14);

                    const og1 = ctx.createGain();
                    og1.gain.setValueAtTime(0.0001, t0);
                    og1.gain.exponentialRampToValueAtTime(0.32, t0 + 0.02);
                    og1.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.14);

                    // ---- Tiny "pop" transient (adds modern-game punch) ----
                    const osc2 = ctx.createOscillator();
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(2200, t0);
                    osc2.frequency.exponentialRampToValueAtTime(900, t0 + 0.06);

                    const og2 = ctx.createGain();
                    og2.gain.setValueAtTime(0.0001, t0);
                    og2.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
                    og2.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.06);

                    // Connect graph
                    // noise -> bp -> hp -> gain -> (optional pan) -> destination
                    noise.connect(bp);
                    bp.connect(hp);
                    hp.connect(g);
                    if (panNode) {
                        g.connect(panNode);
                        panNode.connect(ctx.destination);
                    } else {
                        g.connect(ctx.destination);
                    }

                    // chirps
                    osc1.connect(og1);
                    og1.connect(ctx.destination);
                    osc2.connect(og2);
                    og2.connect(ctx.destination);

                    noise.start(t0);
                    noise.stop(t0 + dur);

                    osc1.start(t0);
                    osc1.stop(t0 + 0.15);

                    osc2.start(t0);
                    osc2.stop(t0 + 0.065);
                } catch(e) {
                    // fail silently (never break gameplay)
                }
            },

            arrangePickPart: function(btnEl, part) {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;
                if(a.isAnimating) return;

                const idx = a.answerParts.indexOf(null);
                if(idx === -1) return;

                const slots = document.getElementById('arrangeSlots');
                const slotEl = (slots && slots.children && slots.children[idx]) ? slots.children[idx] : null;
                if(!slotEl || !btnEl) return;

                this.playWoosh();

                // Geometry (viewport-relative, suitable for position:fixed)
                const from = btnEl.getBoundingClientRect();
                const to = slotEl.getBoundingClientRect();

                a.isAnimating = true;

                // Create a flying visual clone (overlay) from button -> target slot
                const fly = document.createElement('div');
                fly.className = 'arrange-fly';
                fly.textContent = part;

                // Place at the center of the source button
                const startX = from.left + from.width/2;
                const startY = from.top + from.height/2;
                const endX = to.left + to.width/2;
                const endY = to.top + to.height/2;

                // Use translate with transform-origin center for smoother motion
                fly.style.left = (startX) + 'px';
                fly.style.top = (startY) + 'px';
                fly.style.transform = 'translate(-50%, -50%) translate(0px, 0px) scale(1)';
                fly.style.opacity = '1';
                fly.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1), opacity 420ms ease';

                document.body.appendChild(fly);

                // Make sure the browser has painted the initial state before animating (prevents "teleport")
                // 1) Force reflow
                fly.getBoundingClientRect();

                // 2) Fade the source button instead of instantly hiding it (keeps layout stable and avoids blink)
                btnEl.style.opacity = '0';
                btnEl.style.pointerEvents = 'none';

                const dx = (endX - startX);
                const dy = (endY - startY);

                // 3) Animate on next frame (double rAF improves reliability on some mobile browsers)
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        fly.style.transform = `translate(-50%, -50%) translate(${dx}px, ${dy}px) scale(0.92)`;
                        fly.style.opacity = '0.9';
                    });
                });

                const finish = () => {
                    if(fly && fly.parentNode) fly.parentNode.removeChild(fly);

                    // Now truly "remove" the part visually, while keeping placeholder space (B1)
                    btnEl.style.visibility = 'hidden';
                    btnEl.style.opacity = '0';
                    btnEl.style.pointerEvents = 'none';

                    // Commit state
                    a.answerParts[idx] = { text: part, btn: btnEl };

                    // Update slot
                    slotEl.textContent = part;
                    slotEl.classList.add('filled');

                    const checkBtn = document.getElementById('arrangeBtnCheck');
                    if(checkBtn) checkBtn.disabled = a.answerParts.includes(null);

                    a.isAnimating = false;
                };

                // Finish after transition (slightly > duration to be safe on slower devices)
                setTimeout(finish, 460);
            },

            arrangeUndoSlot: function(slotIndex) {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;
                if(a.isAnimating) return;

                const entry = a.answerParts[slotIndex];
                if(!entry) return; // nothing to undo

                AudioManager.playSFX('click');

                // restore button (B1)
                if(entry.btn) {
                    entry.btn.style.visibility = 'visible';
                    entry.btn.style.opacity = '1';
                    entry.btn.style.pointerEvents = 'auto';
                }

                // clear slot
                a.answerParts[slotIndex] = null;
                const slots = document.getElementById('arrangeSlots');
                const slotEl = (slots && slots.children && slots.children[slotIndex]) ? slots.children[slotIndex] : null;
                if(slotEl) {
                    slotEl.textContent = ' ';
                    slotEl.classList.remove('filled');
                }

                const checkBtn = document.getElementById('arrangeBtnCheck');
                if(checkBtn) checkBtn.disabled = true;
            },

            // internal clear: keep question & bank order; restore all parts & empty slots
            arrangeClearAnswer: function(silent) {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;

                // restore all part buttons (including hidden placeholders)
                const bankEl = document.getElementById('arrangePartsBank');
                if(bankEl) {
                    const btns = bankEl.querySelectorAll('button.arrange-part');
                    btns.forEach((b) => {
                        b.style.visibility = 'visible';
                        b.style.opacity = '1';
                        b.style.pointerEvents = 'auto';
                    });
                }

                // clear state
                a.answerParts = new Array(a.currentParts.length).fill(null);

                // clear UI slots
                const slots = document.getElementById('arrangeSlots');
                if(slots) {
                    for(let i=0; i<slots.children.length; i++) {
                        const el = slots.children[i];
                        el.textContent = ' ';
                        el.classList.remove('filled');
                    }
                }

                const checkBtn = document.getElementById('arrangeBtnCheck');
                if(checkBtn) checkBtn.disabled = true;

                if(!silent) AudioManager.playSFX('click');
            },

            // kept for compatibility (no UI button); now just clears current answer without reshuffling
            arrangeReset: function() {
                this.arrangeClearAnswer(false);
            },

            arrangeSkip: function() {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;
                AudioManager.playSFX('click');

                // lewati dihitung sebagai attempt & salah
                if(a.session) a.session.totalChecks = Number(a.session.totalChecks || 0) + 1;
                if(a.stats) {
                    a.stats.played = Number(a.stats.played || 0) + 1;
                    a.stats.wrong = Number(a.stats.wrong || 0) + 1;
                }
                // reset streak
                a.streak = 0;

                // treat as fail like "salah 3x"
                this.arrangeApplyFailAndReveal('Dilewati.');
            },

            arrangeCheck: function() {
                const a = this.state.arrange;
                if(!a || !a.currentQ) return;

                const expected = (a.currentParts || []).join('');
                const got = (a.answerParts || []).map(x => x ? x.text : '').join('');
                const fb = document.getElementById('arrangeFeedback');

                // setiap klik "Cek" dihitung sebagai 1 attempt (untuk akurasi)
                if(a.session) {
                    a.session.totalChecks = (a.session.totalChecks || 0) + 1;
                }
                if(a.stats) {
                    a.stats.played = Number(a.stats.played || 0) + 1;
                }

                if(got === expected) {
                    AudioManager.playSFX('correct');

                    // session accuracy
                    if(a.session) a.session.correctChecks = (a.session.correctChecks || 0) + 1;

                    // overall stats
                    if(a.stats) a.stats.correct = Number(a.stats.correct || 0) + 1;

                    // scoring (mutqin): makin cepat benar, makin tinggi
                    let pts = 5;
                    if(a.wrongAttempts === 0) pts = 10;
                    else if(a.wrongAttempts === 1) pts = 7;

                    if(a.session) {
                        a.session.score = Math.max(0, Number(a.session.score || 0) + pts);
                    }

                    // streak
                    a.streak = (a.streak || 0) + 1;
                    if(a.session) a.session.bestStreak = Math.max(Number(a.session.bestStreak || 0), a.streak);
                    if(a.stats) a.stats.bestStreak = Math.max(Number(a.stats.bestStreak || 0), a.streak);

                    // mark mastered
                    const id = String(a.currentId);
                    if(!a.masteredIds[id]) {
                        a.masteredIds[id] = 1;
                        if(a.session) a.session.mastered = Number(a.session.mastered || 0) + 1;
                    }

                    // reset per soal
                    a.wrongAttempts = 0;
                    a.helpShown = false;
                    this.arrangeHideHelp(true);
                    this.arrangeHideReveal(true);

                    if(fb) fb.textContent = 'Benar. Lanjut soal berikutnya.';
                    this.arrangeSaveStats();
                    this.arrangeRenderStats();

                    this.arrangeShowPraise(a.currentQ);
                    return;
                } else {
                    AudioManager.playSFX('wrong');

                    if(a.stats) a.stats.wrong = Number(a.stats.wrong || 0) + 1;
                    a.streak = 0;

                    a.wrongAttempts = Number(a.wrongAttempts || 0) + 1;

                    if(a.wrongAttempts >= 2) {
                        a.helpShown = true;
                        this.arrangeShowHelp(); // overlay (does not shift layout)
                    }

                    if(a.wrongAttempts >= 3) {
                        // salah ke-3: penalti + tampil jawaban + masuk remedial
                        this.arrangeApplyFailAndReveal('Salah 3Ã—.');
                    } else {
                        if(fb) fb.textContent = a.helpShown ? 'Salah. Bantuan ditampilkan. Coba lagi.' : 'Salah. Coba lagi.';
                        this.arrangeSaveStats();
                        this.arrangeRenderStats();
                        // auto reset jawaban agar murid mulai ulang
                        this.arrangeClearAnswer(true);
                    }
                }
            },

nextPuzzle: function() {
                if(this.state.puzzleIdx >= 18) { this.finishPuzzle(); return; }
                const item = this.state.puzzleQueue[this.state.puzzleIdx];
                UIManager.$('puzzleProgress').innerText = `SOAL ${this.state.puzzleIdx + 1}/18`;
                UIManager.$('puzzleRiddle').innerText = item.riddle;
                const opts = [item, ...GLOBAL_POOL.filter(x => x.id !== item.id).sort(() => Math.random() - 0.5).slice(0, 2)].sort(() => Math.random() - 0.5);
                const g = UIManager.$('puzzleOptions'); g.innerHTML = '';
                opts.forEach(o => {
                    const row = document.createElement('div'); row.className = 'puzzle-opt-row';
                    const bs = document.createElement('button'); bs.className = 'btn-puzzle-sm'; bs.innerHTML = 'ðŸ”Š'; bs.onclick = (e) => { e.stopPropagation(); AudioManager.playTTS(o.arab, 'ar-EG'); };
                    const ba = document.createElement('button'); ba.className = 'btn btn-puzzle-ar'; ba.innerText = o.arab; ba.onclick = () => this.checkPuzzleAns(o.id === item.id);
                    row.append(ba, bs); g.append(row);
                });
                UIManager.showScreen('puzzleScreen');
                AudioManager.playTTS(item.riddle, 'id-ID');
            },
            checkPuzzleAns: function(c) {
                if(this.state.isBusy) return;
                this.state.isBusy = true;
                if(c) {
                    this.state.puzzleCorrect++; this.state.streak++;
                    const fb = this.getStreakFeedback(this.state.streak);
                    AudioManager.playSFX(fb.sfx);
                    if(fb.intensity >= 1.5) UIManager.triggerFlash(0);
                    UIManager.showFeedback(true, null, fb.msg, "Mumtaz!", fb.emoji);
                } else {
                    this.state.streak = 0; AudioManager.playSFX('wrong');
                    UIManager.showFeedback(false, null, "Qadarullah, belum tepat. Ayo coba lagi!", "Belum Tepat", "âŒ");
                }
                setTimeout(() => { this.state.isBusy = false; this.state.puzzleIdx++; this.nextPuzzle(); }, 2200);
            },
            playPuzzleAudio: function(isR) { const item = this.state.puzzleQueue[this.state.puzzleIdx]; if(item) AudioManager.playTTS(isR ? item.riddle : item.arab, isR ? 'id-ID' : 'ar-EG'); },
            finishPuzzle: function() {
                const final = Math.round((this.state.puzzleCorrect / 18) * 100);
                this.state.isFromPuzzle = true; this.state.tempScore = final;
                UIManager.$('resultScore').innerText = final;
                const rE = UIManager.$('resEmoji'), rT = UIManager.$('resTitle'), rM = UIManager.$('resMsg'), rB = UIManager.$('resultExitBtn');
                rB.innerText = "Ke Menu Utama";
                if(final === 100) { rE.innerText = "ðŸ‘‘"; rT.innerText = "Maa SyaAllah!"; rM.innerHTML = `<p style="font-size:1.3rem; font-weight:bold;">Maa SyaAllah Tabarakallah! Sempurna!</p>Skor: <span style="color:var(--accent); font-size: 2rem;">${final}</span>`; AudioManager.playSFX('grandFanfare'); Fireworks.start(2, 2); }
                else if(final >= 75) { rE.innerText = "ðŸ†"; rT.innerText = "Alhamdulillah!"; rM.innerHTML = `<p style="font-size:1.1rem; font-weight:bold;">Alhamdulillah Mumtaz! Hebat Sekali!</p>Skor: <span style="color:var(--accent); font-size: 2rem;">${final}</span>`; AudioManager.playSFX('fanfare'); Fireworks.start(1, 1); }
                else { rE.innerText = "ðŸ’ª"; rT.innerText = "Barakallahu Fiik!"; rM.innerHTML = `<p style="font-size:1.1rem; font-weight:bold;">Barakallahu Fiik! Terus semangat belajar Lillah!</p>Skor: <span style="color:var(--accent); font-size: 2rem;">${final}</span>`; AudioManager.playSFX('gentle'); }
                this.state.history.unshift({ type: 'puzzle', score: final, date: new Date().toLocaleDateString('id-ID'), time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) });
                this.saveData(); UIManager.showScreen('resultScreen');
            }
        };
        window.GameEngine = GameEngine;
        const Fireworks = {
            interval: null, canvas: null, ctx: null, particles: [], isRunning: false,
            initCanvas: function() { this.canvas = document.getElementById('canvasFireworks'); if(!this.canvas) return; this.ctx = this.canvas.getContext('2d'); this.resize(); window.addEventListener('resize', () => this.resize()); },
            resize: function() { if(this.canvas) { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; } },
            start: function(density = 1, mode = 0, preserve = false) { if(this.isRunning) this.stop(preserve); if(!this.canvas) this.initCanvas(); this.isRunning = true; if(!preserve) this.particles = []; this.canvas.style.opacity = 1; this.interval = setInterval(() => { if(!this.isRunning || !this.canvas) return; if (mode === 2) { if(Math.random() < 0.2) this.particles.push(new this.Particle(Math.random()*this.canvas.width, -20, null, 2, "âœ¨", 'top')); } if (mode === 3) { if(Math.random() < 0.2) { const exX = Math.random() * this.canvas.width, exY = Math.random() * (this.canvas.height * 0.6); const icons = ["ðŸ’Ž", "â­", "ðŸ‘‘"]; const icon = icons[Math.floor(Math.random()*icons.length)]; for(let i=0; i<12; i++) this.particles.push(new this.Particle(exX, exY, null, 1, icon, 'explosion')); } } if(Math.random() < 0.15) { const exX = Math.random() * this.canvas.width, exY = Math.random() * (this.canvas.height * 0.6); AudioManager.playSFX('firework'); for(let i=0; i<40; i++) this.particles.push(new this.Particle(exX, exY, `hsl(${Math.random()*360},100%,60%)`, 1, 'dot', 'explosion')); } }, 60); this.animate(); },
            stop: function(preserve = false) { this.isRunning = false; if(this.interval) clearInterval(this.interval); if(!preserve) { this.particles = []; if(this.ctx && this.canvas) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); } else { setTimeout(() => { if(this.canvas) this.canvas.style.opacity = 0; setTimeout(() => this.stop(false), 1000); }, 2000); } },
            Particle: function(x, y, c, mode, type, spawnType) { this.x = x; this.y = y; this.color = c; this.alpha = 1; this.life = 100; this.type = type; const angle = Math.random()*Math.PI*2, speed = Math.random()*6+2; this.velocity = { x: Math.cos(angle)*speed, y: Math.sin(angle)*speed }; if(spawnType === 'top') { this.velocity.y = Math.random()*5+2; this.velocity.x = (Math.random()-0.5)*2; } this.gravity = 0.15; this.drag = 0.96; this.draw = (ctx) => { ctx.save(); ctx.globalAlpha = this.alpha; if(this.type === 'dot') { ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill(); } else { ctx.font = "30px Arial"; ctx.fillText(this.type, this.x, this.y); } ctx.restore(); }; this.update = () => { this.x += this.velocity.x; this.y += this.velocity.y; this.velocity.y += this.gravity; this.velocity.x *= this.drag; this.alpha -= 0.015; this.life--; }; },
            animate: function() { if(!this.isRunning && this.particles.length === 0) return; requestAnimationFrame(() => this.animate()); if(this.ctx) { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.particles = this.particles.filter(p => { if(p.life > 0 && p.alpha > 0) { p.update(); p.draw(this.ctx); return true; } return false; }); } }
        };
        window.addEventListener('DOMContentLoaded', () => { GameEngine.boot(); UIManager.showScreen('coverScreen'); document.body.addEventListener('click', () => { AudioManager.ensureContext(); SyariahFX.init(); }, { once: true }); });
    </script>
  </div>

  <script id="desktopPureScalerJS">
  (function(){
    const DESIGN_W = 880;
    const BOOST = 1.10;

    const meta = document.getElementById('viewportMeta');
    const root = document.getElementById('viewportRoot');

    function apply(){
      // Force a "desktop layout viewport" and then scale down to fit phone width.
      if(meta){
        meta.setAttribute('content', `width=${DESIGN_W}, viewport-fit=cover`);
      }
      const w = window.innerWidth || DESIGN_W;
      const scale = Math.min(1, (w / DESIGN_W) * BOOST);
      document.documentElement.style.setProperty('--uiScale', scale.toFixed(4));
      if(root){
        root.classList.toggle('scaled', scale < 1);
      }
    }

    window.addEventListener('resize', apply, {passive:true});
    window.addEventListener('orientationchange', apply, {passive:true});
    document.addEventListener('DOMContentLoaded', apply);
    apply();
  })();
  </script>

</body>
</html>